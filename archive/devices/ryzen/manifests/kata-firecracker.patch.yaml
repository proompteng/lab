machine:
  files:
    - path: /etc/cri/containerd.toml
      op: overwrite
      permissions: 0o644
      content: |
        version = 3

        disabled_plugins = [
            "io.containerd.differ.v1.erofs",
            "io.containerd.internal.v1.tracing",
            "io.containerd.snapshotter.v1.erofs",
            "io.containerd.ttrpc.v1.otelttrpc",
            "io.containerd.tracing.processor.v1.otlp",
        ]

        imports = [
            "/etc/cri/conf.d/cri.toml",
        ]

        [debug]
        level = "info"
        format = "json"
    - path: /etc/cri/conf.d/20-customization.part
      op: overwrite
      permissions: 0o644
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
          use_local_image_pull = false

        [plugins."io.containerd.cri.v1.images".pinned_images]
          sandbox = "registry.k8s.io/pause@sha256:ee6521f290b2168b6e0935a181d4cff9be1ac3f505666ef0e3c98fae8199917a"

        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes."kata-fc"]
          snapshotter = "overlayfs"
          runtime_type = "io.containerd.kata-fc.v2"
          runtime_path = "/usr/local/bin/containerd-shim-kata-v2"
          privileged_without_host_devices = true
          pod_annotations = ["io.katacontainers.*"]
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes."kata-fc".options]
            ConfigPath = "/usr/local/share/kata-containers/configuration.toml"

        [plugins."io.containerd.cri.v1.runtime".containerd.runtimes."kata-fc"]
          snapshotter = "overlayfs"
          runtime_type = "io.containerd.kata-fc.v2"
          runtime_path = "/usr/local/bin/containerd-shim-kata-v2"
          privileged_without_host_devices = true
          pod_annotations = ["io.katacontainers.*"]
          [plugins."io.containerd.cri.v1.runtime".containerd.runtimes."kata-fc".options]
            ConfigPath = "/usr/local/share/kata-containers/configuration.toml"
