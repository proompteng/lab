apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: agent-argo
  labels:
    runtime: argo
spec:
  compositeTypeRef:
    apiVersion: agents.proompteng.ai/v1alpha1
    kind: XAgent
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: workflow-template
            base:
              apiVersion: argoproj.io/v1alpha1
              kind: WorkflowTemplate
              metadata:
                namespace: argo-workflows
              spec:
                serviceAccountName: codex-workflow
                entrypoint: agent-run
                templates:
                  - name: agent-run
                    volumes:
                      - name: agent-providers
                        configMap:
                          name: ""
                          optional: true
                    inputs:
                      parameters:
                        - name: provider
                          default: ''
                        - name: repository
                          default: ''
                        - name: issueNumber
                          default: ''
                        - name: base
                          default: ''
                        - name: head
                          default: ''
                        - name: stage
                          default: ''
                        - name: rawEventB64
                          default: ''
                        - name: eventBodyB64
                          default: ''
                        - name: promptJson
                          default: ''
                    container:
                      image: registry.ide-newton.ts.net/lab/jangar:latest
                      resources:
                        requests: {}
                        limits: {}
                      command:
                        - /bin/sh
                        - -c
                      args:
                        - |
                          set -euo pipefail
                          AGENT_SPEC="$(mktemp)"
                          export AGENT_SPEC
                          node - \
                            "{{inputs.parameters.provider}}" \
                            "{{inputs.parameters.repository}}" \
                            "{{inputs.parameters.issueNumber}}" \
                            "{{inputs.parameters.base}}" \
                            "{{inputs.parameters.head}}" \
                            "{{inputs.parameters.stage}}" \
                            "{{inputs.parameters.rawEventB64}}" \
                            "{{inputs.parameters.eventBodyB64}}" \
                            "{{inputs.parameters.promptJson}}" <<'NODE'
                          const fs = require('fs');
                          const [
                            ,
                            ,
                            provider,
                            repository,
                            issueNumber,
                            base,
                            head,
                            stage,
                            rawEventB64,
                            eventBodyB64,
                            promptJson,
                          ] = process.argv;
                          const spec = {
                            provider,
                            inputs: {
                              repository,
                              issueNumber,
                              base,
                              head,
                              stage,
                            },
                            payloads: {
                              rawEventB64,
                              eventBodyB64,
                              promptJson,
                            },
                          };
                          fs.writeFileSync(process.env.AGENT_SPEC, JSON.stringify(spec));
                          NODE
                          /usr/local/bin/agent-runner --spec "$AGENT_SPEC"
                      env:
                        - name: AGENT_PROVIDER
                          value: ''
                        - name: AGENT_REPOSITORY
                          value: ''
                        - name: AGENT_ISSUE_NUMBER
                          value: ''
                        - name: AGENT_BASE
                          value: ''
                        - name: AGENT_HEAD
                          value: ''
                        - name: AGENT_STAGE
                          value: ''
                        - name: WORKFLOW_STAGE
                          value: ''
                        - name: WORKFLOW_NATS_ENABLED
                          value: 'true'
                        - name: WORKFLOW_KAFKA_COMPLETIONS
                          value: 'true'
                        - name: WORKFLOW_GRAF_ENABLED
                          value: 'false'
                      volumeMounts:
                        - name: agent-providers
                          mountPath: /etc/agent-providers
            patches:
              - fromFieldPath: metadata.name
                toFieldPath: metadata.name
              - fromFieldPath: metadata.labels["crossplane.io/claim-name"]
                toFieldPath: metadata.name
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.runtime.argo.namespace
                toFieldPath: metadata.namespace
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.runtime.argo.serviceAccount
                toFieldPath: spec.serviceAccountName
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.providerRef.name
                toFieldPath: spec.templates[0].inputs.parameters[0].default
              - fromFieldPath: spec.providerRef.name
                toFieldPath: spec.templates[0].volumes[0].configMap.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%s-agent-provider'
              - fromFieldPath: spec.inputs.repository
                toFieldPath: spec.templates[0].inputs.parameters[1].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.repository
                toFieldPath: spec.templates[0].container.env[1].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.issueNumber
                toFieldPath: spec.templates[0].inputs.parameters[2].default
                policy:
                  fromFieldPath: Optional
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%v'
              - fromFieldPath: spec.inputs.issueNumber
                toFieldPath: spec.templates[0].container.env[2].value
                policy:
                  fromFieldPath: Optional
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%v'
              - fromFieldPath: spec.inputs.base
                toFieldPath: spec.templates[0].inputs.parameters[3].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.base
                toFieldPath: spec.templates[0].container.env[3].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.head
                toFieldPath: spec.templates[0].inputs.parameters[4].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.head
                toFieldPath: spec.templates[0].container.env[4].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.stage
                toFieldPath: spec.templates[0].inputs.parameters[5].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.stage
                toFieldPath: spec.templates[0].container.env[5].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.inputs.stage
                toFieldPath: spec.templates[0].container.env[6].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.payloads.rawEventB64
                toFieldPath: spec.templates[0].inputs.parameters[6].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.payloads.eventBodyB64
                toFieldPath: spec.templates[0].inputs.parameters[7].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.payloads.promptJson
                toFieldPath: spec.templates[0].inputs.parameters[8].default
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.providerRef.name
                toFieldPath: spec.templates[0].container.env[0].value
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.observability.natsEnabled
                toFieldPath: spec.templates[0].container.env[7].value
                policy:
                  fromFieldPath: Optional
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%v'
              - fromFieldPath: spec.observability.kafkaCompletions
                toFieldPath: spec.templates[0].container.env[8].value
                policy:
                  fromFieldPath: Optional
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%v'
              - fromFieldPath: spec.observability.grafEnabled
                toFieldPath: spec.templates[0].container.env[9].value
                policy:
                  fromFieldPath: Optional
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: '%v'
              - fromFieldPath: spec.resources.cpu
                toFieldPath: spec.templates[0].container.resources.requests.cpu
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.resources.cpu
                toFieldPath: spec.templates[0].container.resources.limits.cpu
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.resources.memory
                toFieldPath: spec.templates[0].container.resources.requests.memory
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.resources.memory
                toFieldPath: spec.templates[0].container.resources.limits.memory
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.resources.ephemeral
                toFieldPath: spec.templates[0].container.resources.requests["ephemeral-storage"]
                policy:
                  fromFieldPath: Optional
              - fromFieldPath: spec.resources.ephemeral
                toFieldPath: spec.templates[0].container.resources.limits["ephemeral-storage"]
                policy:
                  fromFieldPath: Optional
            readinessChecks:
              - type: None
