# Chart Controllers PodDisruptionBudget

Status: Draft (2026-02-06)

## Overview
The chart can deploy a separate controllers Deployment (`agents-controllers`), but the chartâ€™s PodDisruptionBudget (PDB) template currently only targets the control plane pods. This creates an availability gap: controllers may all be evicted during node drains or cluster maintenance even when the control plane is protected.

## Goals
- Add optional PDB support for `agents-controllers`.
- Keep backward compatibility for existing installs using `podDisruptionBudget.*`.

## Non-Goals
- Enforcing a single organization-wide disruption policy.

## Current State
- Existing PDB template: `charts/agents/templates/poddisruptionbudget.yaml`
  - Selects `{{ include "agents.selectorLabels" . }}` (control plane).
- Controllers selector labels differ: `charts/agents/templates/_helpers.tpl` (`agents.controllersSelectorLabels`).
- Values: `charts/agents/values.yaml` exposes `podDisruptionBudget.*` (single set).
- Cluster desired state: `argocd/applications/agents/values.yaml` does not enable a PDB.

## Design
### Proposed values
Add component-scoped PDBs:
- `controlPlane.podDisruptionBudget` (defaults to existing `podDisruptionBudget`)
- `controllers.podDisruptionBudget` (new)

### Defaults
- Keep existing `podDisruptionBudget.enabled=false`.
- When controllers are enabled, recommend enabling a PDB with `maxUnavailable: 1` for controllers.

## Config Mapping
| Helm value | Rendered object | Intended behavior |
|---|---|---|
| `podDisruptionBudget.*` | `PodDisruptionBudget/agents` | Backward compatible control plane PDB. |
| `controllers.podDisruptionBudget.enabled=true` | `PodDisruptionBudget/agents-controllers` | Prevents full controller eviction during voluntary disruptions. |

## Rollout Plan
1. Add `controllers.podDisruptionBudget` with defaults (disabled).
2. Enable in non-prod and validate node-drain behavior.
3. Enable in prod after confirming controllers can roll without downtime.

Rollback:
- Disable `controllers.podDisruptionBudget.enabled`.

## Validation
```bash
helm template agents charts/agents --set controllers.enabled=true --set controllers.podDisruptionBudget.enabled=true | rg -n \"kind: PodDisruptionBudget\"
kubectl -n agents get pdb
```

## Failure Modes and Mitigations
- PDB too strict blocks node drain: mitigate with `maxUnavailable: 1` and by matching replicas.
- Selector mismatch means PDB protects nothing: mitigate with render-time tests and explicit selector labels.

## Acceptance Criteria
- When enabled, a PDB exists for `agents-controllers` selecting the correct pods.
- Node drains do not evict all controller replicas at once.

## References
- Kubernetes PodDisruptionBudget: https://kubernetes.io/docs/tasks/run-application/configure-pdb/

