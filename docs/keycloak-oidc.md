# Keycloak (OIDC) for Headlamp

This runbook covers the in-cluster Keycloak deployment used for OIDC, plus the initial admin hardening steps and proxy notes.

## Deployment layout

- Argo CD app path: `argocd/applications/keycloak`
- Namespace: `keycloak`
- Helm chart: `codecentric/keycloakx`
- Database: CloudNativePG cluster `keycloak-db` (Longhorn, 5Gi)
- Public hostname: `auth.proompteng.ai`
- Traefik route: `argocd/applications/keycloak/ingressroute.yaml`

## Admin UI

- Admin console URL: `https://auth.proompteng.ai/admin/`
- Temporary bootstrap admin: stored in the sealed secret `keycloak-admin`

### Create a permanent admin user (required)

Keycloak warns if you are still using the bootstrap admin. Create a permanent admin and delete the temporary account.

1) In the **master** realm, create a new user (Users → Add user) and set a non-temporary password.
2) Assign realm roles:
   - Go to the user → **Role mapping** → **Assign role**.
   - Under **Realm roles**, select **admin** and assign it.
3) Log out and log in with the new user.
4) Delete the temporary bootstrap admin user.

Note: In this Keycloak build, the realm-level admin role is named **admin** under Realm roles (not `realm-admin`).

## Proxy (Nginx Proxy Manager)

Nginx Proxy Manager is terminating TLS and forwarding to Traefik. Keycloak is configured for proxy headers:

- `KC_HOSTNAME=auth.proompteng.ai`
- `KC_PROXY_HEADERS=xforwarded`
- `KC_HTTP_ENABLED=true`

No custom proxy config is required if NPM forwards standard X-Forwarded headers. If you see redirect loops or bad hostnames, add this custom location in NPM:

```nginx
location / {
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Port $server_port;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass $forward_scheme://$server:$port;
}
```

## Database notes

- CNPG cluster: `keycloak-db`
- App secret (generated by CNPG): `keycloak-db-app`
- Keycloak uses `keycloak-db-rw:5432` with the CNPG app secret for credentials.

## Rotating the bootstrap admin password

The bootstrap admin credentials are sealed in `argocd/applications/keycloak/keycloak-admin-sealedsecret.yaml`.
To rotate:

1) Generate a new secret (do not commit plaintext):

```bash
kubectl create secret generic keycloak-admin \
  -n keycloak \
  --from-literal=username=admin \
  --from-literal=password='<new-password>' \
  --dry-run=client -o yaml \
  | kubeseal --controller-name sealed-secrets \
  --controller-namespace sealed-secrets -o yaml \
  > argocd/applications/keycloak/keycloak-admin-sealedsecret.yaml
```

2) Commit the updated sealed secret and sync Argo CD.

## Quick checks

```bash
kubectl -n keycloak get pods,svc,ingressroute,cluster
```

