# Keycloak (OIDC) for Headlamp

This runbook covers the in-cluster Keycloak deployment used for OIDC, plus the initial admin hardening steps and proxy notes.

## Deployment layout

- Argo CD app path: `argocd/applications/keycloak`
- Namespace: `keycloak`
- Manifests: `argocd/applications/keycloak/keycloak.yaml`
- Database: CloudNativePG cluster `keycloak-db` (`rook-ceph-block`, 5Gi)
- Public hostname: `auth.proompteng.ai`
- Traefik route: `argocd/applications/keycloak/ingressroute.yaml`
- Uses plain manifests (no Helm) under `argocd/applications/keycloak/`.

For Headlamp-specific wiring (OIDC secret, RBAC, control-plane OIDC args), see `docs/headlamp-setup.md`.

## Admin UI

- Admin console URL: `https://auth.proompteng.ai/admin/`
- Temporary bootstrap admin: stored in the sealed secret `keycloak-admin`

### Create a permanent admin user (required)

Keycloak warns if you are still using the bootstrap admin. Create a permanent admin and delete the temporary account.

1) In the **master** realm, create a new user (Users → Add user) and set a non-temporary password.
2) Assign realm roles:
   - Go to the user → **Role mapping** → **Assign role**.
   - Under **Realm roles**, select **admin** and assign it.
3) Log out and log in with the new user.
4) Delete the temporary bootstrap admin user.

Note: In this Keycloak build, the realm-level admin role is named **admin** under Realm roles (not `realm-admin`).

## OIDC client for Kubernetes/Headlamp

Use a single confidential OIDC client for both the kube-apiserver and Headlamp (example client ID: `kubernetes`).

Capabilities:
- Client authentication: **On**
- Standard flow: **On**
- Direct access grants: Off
- Implicit flow: Off
- Service accounts roles: Off
- PKCE: None

Login settings (Headlamp):
- Root URL: `https://headlamp.ide-newton.ts.net`
- Home URL: `https://headlamp.ide-newton.ts.net`
- Valid redirect URIs: `https://headlamp.ide-newton.ts.net/oidc-callback`
- Web origins: `https://headlamp.ide-newton.ts.net`
- Valid post logout redirect URIs: `https://headlamp.ide-newton.ts.net`

Issuer and scopes:
- Issuer: Realm → **Realm settings** → **Endpoints** → **OpenID Endpoint Configuration** (`issuer`)
- Scopes: `openid profile email`

Optional (recommended) group mapper:
- Mapper type: **Group Membership**
- Token claim name: `groups`
- Add to ID token: On
- Add to access token: On

## Proxy (Nginx Proxy Manager)

Nginx Proxy Manager is terminating TLS and forwarding to Traefik. Keycloak is configured for proxy headers:

- `KC_HOSTNAME=auth.proompteng.ai`
- `KC_PROXY_HEADERS=xforwarded`
- `KC_HTTP_ENABLED=true`

No custom proxy config is required if NPM forwards standard X-Forwarded headers. If you see redirect loops or bad hostnames, add this custom location in NPM:

```nginx
location / {
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Port $server_port;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass $forward_scheme://$server:$port;
}
```

## Database notes

- CNPG cluster: `keycloak-db`
- App secret (generated by CNPG): `keycloak-db-app`
- Keycloak uses `keycloak-db-rw:5432` with the CNPG app secret for credentials.

## Rotating the bootstrap admin password

The bootstrap admin credentials are sealed in `argocd/applications/keycloak/keycloak-admin-sealedsecret.yaml`.
To rotate:

1) Generate a new secret (do not commit plaintext):

```bash
kubectl create secret generic keycloak-admin \
  -n keycloak \
  --from-literal=username=admin \
  --from-literal=password='<new-password>' \
  --dry-run=client -o yaml \
  | kubeseal --controller-name sealed-secrets \
  --controller-namespace sealed-secrets -o yaml \
  > argocd/applications/keycloak/keycloak-admin-sealedsecret.yaml
```

2) Commit the updated sealed secret and sync Argo CD.

## Applying manifests locally

This app uses plain YAML manifests (no Helm). To apply directly:

```bash
kubectl apply -f argocd/applications/keycloak/keycloak-admin-sealedsecret.yaml
kubectl apply -f argocd/applications/keycloak/postgres-cluster.yaml
kubectl apply -f argocd/applications/keycloak/keycloak.yaml
kubectl apply -f argocd/applications/keycloak/ingressroute.yaml
```

## Quick checks

```bash
kubectl -n keycloak get pods,svc,ingressroute,cluster
```
