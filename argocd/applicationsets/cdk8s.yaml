apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cdk8s
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error
  generators:
    - matrix:
        generators:
          - list:
              elements: &clusters_default
                - cluster: in-cluster
                  suffix: ""
                  destinationServer: https://kubernetes.default.svc
          - list:
              elements: &cdk8s_elements
                - name: bonjour
                  path: services/bonjour
                  namespace: bonjour
                  image: registry.ide-newton.ts.net/lab/bonjour@sha256:8b1ebac20afc95edaf794f52648fb33eff4ef85e6b4e0250cde2ff98af1a298b
                  replicas: 1
                  automation: manual
                  enabled: "false"
                  annotations:
                    argocd.argoproj.io/sync-wave: "6"
            selector:
              matchExpressions:
                - key: enabled
                  operator: NotIn
                  values: ["false", "False", "0"]
  template:
    metadata:
      name: "{{ .name }}{{ .suffix }}"
    spec:
      project: '{{ if hasKey . "project" }}{{ .project }}{{ else }}default{{ end }}'
      destination:
        namespace: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
      source:
        repoURL: https://github.com/proompteng/lab.git
        targetRevision: main
        path: "{{ .path }}"
        plugin:
          name: cdk8s
          env:
            - name: IMAGE
              value: '{{ if hasKey . "image" }}{{ .image }}{{ else }}registry.ide-newton.ts.net/lab/bonjour:latest{{ end }}'
            - name: NAMESPACE
              value: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
            - name: REPLICAS
              value: '{{ if hasKey . "replicas" }}{{ .replicas }}{{ else }}2{{ end }}'
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
  templatePatch: |
    {{- if .annotations }}
    metadata:
      annotations:
      {{- range $key, $value := .annotations }}
          {{ $key }}: {{ $value | quote }}
      {{- end }}
    {{- end }}
    {{- $hasDestServer := hasKey . "destinationServer" -}}
    {{- $hasDestName := hasKey . "destinationName" -}}
    {{- $auto := eq .automation "auto" -}}
    {{- $deps := list -}}
    {{- $crds := list -}}
    {{- if hasKey . "dependsOnApps" -}}
    {{- $deps = .dependsOnApps -}}
    {{- end -}}
    {{- if hasKey . "requiresCrds" -}}
    {{- $crds = .requiresCrds -}}
    {{- end -}}

    {{- $hasInfo := or (gt (len $deps) 0) (gt (len $crds) 0) -}}
    {{- $needsSpec := or $hasDestServer $hasDestName $auto $hasInfo -}}
{{- if $needsSpec }}
spec:
  {{- if or $hasDestServer $hasDestName }}
  destination:
    namespace: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
    {{- if $hasDestServer }}
    server: '{{ .destinationServer }}'
    {{- end }}
    {{- if $hasDestName }}
    name: '{{ .destinationName }}'
    {{- end }}
  {{- end }}
  {{- if $hasInfo }}
  info:
    {{- if gt (len $deps) 0 }}
    - name: Depends On (Argo apps)
      value: '{{ join ", " $deps }}'
    {{- end }}
    {{- if gt (len $crds) 0 }}
    - name: Requires CRDs
      value: '{{ join ", " $crds }}'
    {{- end }}
  {{- end }}
  {{- if $auto }}
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
  {{- end }}
{{- end }}
