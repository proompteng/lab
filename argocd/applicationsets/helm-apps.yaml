# this template is created to use OCI helm charts
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: appset-helm
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          - list:
              elements: &clusters_default
                - cluster: in-cluster
                  suffix: ""
                  destinationServer: https://kubernetes.default.svc
          - list:
              elements: &helm_elements []
            selector:
              matchExpressions:
                - key: enabled
                  operator: NotIn
                  values: ["false", "False", "0"]
  template:
    metadata:
      name: "{{ .name }}{{ .suffix }}"
      namespace: argocd
    spec:
      project: default
      destination:
        namespace: "{{.namespace}}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
      source:
        repoURL: "{{.repoUrl}}"
        chart: "{{.chart}}"
        targetRevision: "{{.version}}"
        helm:
          releaseName: "{{.releaseName}}"
          skipCrds: false
	  templatePatch: |
	    {{- $hasDestServer := hasKey . "destinationServer" -}}
	    {{- $hasDestName := hasKey . "destinationName" -}}
	    {{- $hasValuesObject := hasKey . "valuesObject" -}}
	    {{- $hasAppName := hasKey . "name" -}}
	    {{- $deps := list -}}
	    {{- $crds := list -}}
	    {{- $appsSealedSecret := list "app" "arc" "argo-workflows" "argocd" "cloudflare" "cms" "coder" "convex" "dagster" "dernier" "discourse" "ecran" "facteur" "froussard" "graf" "headlamp" "jangar" "keycloak" "miel" "milvus" "minio" "nats" "observability" "oirat" "pgadmin" "reviseur" "rook-ceph" "tailscale" "torghut" -}}
	    {{- $appsIngressRoute := list "app" "argo-workflows" "argocd" "backstage" "cms" "convex" "discourse" "docs" "ecran" "graf" "keycloak" "proompteng" "reviseur" "traefik" -}}
	    {{- $appsLoadBalancer := list "agents" "convex" "dagster" "facteur" "golink" "graf" "homepage" "jangar" "kafka" "milvus" "minio" "observability" "pgadmin" "registry" "temporal" "torghut" "traefik" -}}
	    {{- $appsCnpg := list "app" "cms" "coder" "convex" "dernier" "discourse" "ecran" "facteur" "golink" "jangar" "keycloak" "torghut" -}}
	    {{- $appsIstio := list "istio-ingress" "istio-system" -}}
	    {{- $appsKnative := list "dernier" "facteur" "froussard" "galette" "golink" "graf" "jangar" "prt" "registry" "torghut" "traefik" -}}
	    {{- $appsKubevirt := list "kubevirt" "workers" -}}
	    {{- $appsCdi := list -}}

	    {{- if and $hasAppName (has .name $appsSealedSecret) -}}
	    {{- $deps = append $deps "sealed-secrets" -}}
	    {{- $crds = append $crds "sealedsecrets.bitnami.com" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsIngressRoute) -}}
	    {{- $deps = append $deps "traefik" -}}
	    {{- $crds = append $crds "traefik.io" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsLoadBalancer) -}}
	    {{- $deps = append $deps "metallb-system" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsCnpg) -}}
	    {{- $deps = append $deps "cloudnative-pg" -}}
	    {{- $crds = append $crds "postgresql.cnpg.io" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsIstio) -}}
	    {{- $crds = append $crds "networking.istio.io" -}}
	    {{- $crds = append $crds "security.istio.io" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsKnative) -}}
	    {{- $deps = append $deps "knative-serving" -}}
	    {{- $crds = append $crds "serving.knative.dev" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsKubevirt) -}}
	    {{- $deps = append $deps "kubevirt" -}}
	    {{- $crds = append $crds "kubevirt.io" -}}
	    {{- end -}}
	    {{- if and $hasAppName (has .name $appsCdi) -}}
	    {{- $deps = append $deps "cdi" -}}
	    {{- $crds = append $crds "cdi.kubevirt.io" -}}
	    {{- end -}}

	    {{- $hasInfo := or (gt (len $deps) 0) (gt (len $crds) 0) -}}
	    {{- $needsSpec := or $hasDestServer $hasDestName $hasValuesObject $hasInfo -}}
	    {{- if $needsSpec }}
	    spec:
	      {{- if or $hasDestServer $hasDestName }}
	      destination:
	        {{- if $hasDestServer }}
	        server: '{{ .destinationServer }}'
	        {{- end }}
	        {{- if $hasDestName }}
	        name: '{{ .destinationName }}'
	        {{- end }}
	      {{- end }}
	      {{- if $hasInfo }}
	      info:
	        {{- if gt (len $deps) 0 }}
	        - name: Depends On (Argo apps)
	          value: '{{ join ", " $deps }}'
	        {{- end }}
	        {{- if gt (len $crds) 0 }}
	        - name: Requires CRDs
	          value: '{{ join ", " $crds }}'
	        {{- end }}
	      {{- end }}
	      {{- if $hasValuesObject }}
	      source:
	        helm:
	          valuesObject: {{- .valuesObject | toYaml | nindent 12 }}
	      {{- end }}
	    {{- end }}
