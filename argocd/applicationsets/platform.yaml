apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: platform
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          - list:
              elements: &clusters_default
                - cluster: in-cluster
                  suffix: ""
                  destinationServer: https://kubernetes.default.svc
          - list:
              elements: &platform_elements
              - name: cloudnative-pg
                path: argocd/applications/cloudnative-pg
                namespace: cloudnative-pg
                annotations:
                  argocd.argoproj.io/sync-wave: "-1"
                automation: auto
                enabled: "false"
              - name: clickhouse-operator
                path: argocd/applications/clickhouse-operator
                namespace: clickhouse-operator
                annotations:
                  argocd.argoproj.io/sync-wave: "-1"
                automation: manual
                enabled: "false"
              - name: redis-operator
                path: argocd/applications/redis-operator
                namespace: redis-operator
                annotations:
                  argocd.argoproj.io/sync-wave: "-1"
                automation: auto
                enabled: "false"
              - name: rook-ceph
                path: argocd/applications/rook-ceph
                namespace: rook-ceph
                annotations:
                  argocd.argoproj.io/sync-wave: "-1"
                automation: manual
                enabled: "false"
              - name: kubevirt
                path: argocd/applications/kubevirt
                namespace: kubevirt
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                automation: manual
                enabled: "false"
              - name: cdi
                path: argocd/applications/cdi
                namespace: cdi
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                automation: manual
                enabled: "false"
              - name: workers
                path: argocd/applications/workers
                namespace: workers
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: manual
                enabled: "false"
                managedNamespaceMetadata:
                  labels:
                    pod-security.kubernetes.io/enforce: privileged
                    pod-security.kubernetes.io/audit: privileged
                    pod-security.kubernetes.io/warn: privileged
              - name: kata-containers
                path: argocd/applications/kata-containers
                namespace: kube-system
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                automation: manual
                enabled: "false"
              - name: external-dns
                path: argocd/applications/external-dns
                namespace: external-dns
                annotations:
                  argocd.argoproj.io/sync-wave: "0"
                automation: auto
                enabled: "false"
              - name: cloudflare
                path: argocd/applications/cloudflare
                namespace: cloudflare
                annotations:
                  argocd.argoproj.io/sync-wave: "0"
                automation: auto
                enabled: "false"
              - name: istio-system
                path: argocd/applications/istio-system
                namespace: istio-system
                annotations:
                  argocd.argoproj.io/sync-wave: "0"
                automation: auto
                enabled: "false"
              - name: istio-ingress
                path: argocd/applications/istio-ingress
                namespace: istio-ingress
                dependsOnApps:
                  - istio-system
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                automation: auto
                enabled: "false"
              - name: knative
                path: argocd/applications/knative
                namespace: knative
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                automation: auto
                enabled: "false"
              - name: knative-serving
                path: argocd/applications/knative-serving
                namespace: knative-serving
                dependsOnApps:
                  - knative
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: auto
                enabled: "false"
              - name: knative-eventing
                path: argocd/applications/knative-eventing
                namespace: knative-eventing
                dependsOnApps:
                  - knative
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: auto
                enabled: "false"
              - name: fission
                path: argocd/applications/fission
                namespace: fission
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: auto
                enabled: "false"
              - name: kafka
                path: argocd/applications/kafka
                namespace: kafka
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: auto
                enabled: "false"
              - name: nats
                path: argocd/applications/nats
                namespace: nats
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: manual
                enabled: "false"
              - name: nack
                path: argocd/applications/nack
                namespace: nack
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: manual
                enabled: "false"
              - name: kubernetes-reflector
                path: argocd/applications/kubernetes-reflector
                namespace: kubernetes-reflector
                annotations:
                  argocd.argoproj.io/sync-wave: "2"
                automation: auto
                enabled: "false"
              - name: argo-workflows
                path: argocd/applications/argo-workflows
                namespace: argo-workflows
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: manual
                enabled: "false"
              - name: observability
                path: argocd/applications/observability
                namespace: observability
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: auto
                enabled: "false"
              - name: minio
                path: argocd/applications/minio
                namespace: minio
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: manual
                enabled: "false"
              - name: flink
                path: argocd/applications/flink
                namespace: flink
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: manual
                enabled: "false"
              - name: milvus
                path: argocd/applications/milvus
                namespace: milvus
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: tigresse
                path: argocd/applications/tigresse
                namespace: tigresse-system
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: auto
                enabled: "false"
              - name: temporal
                path: argocd/applications/temporal
                namespace: temporal
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: manual
                enabled: "false"
              - name: airbyte
                path: argocd/applications/airbyte
                namespace: airbyte
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: dagster
                path: argocd/applications/dagster
                namespace: dagster
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: verdaccio
                path: argocd/applications/verdaccio
                namespace: verdaccio
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: auto
                enabled: "false"
              - name: spark
                path: argocd/applications/spark
                namespace: spark
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: auto
                enabled: "false"
              - name: coder
                path: argocd/applications/coder
                namespace: coder
                annotations:
                  argocd.argoproj.io/sync-wave: "3"
                automation: manual
                enabled: "false"
              - name: arc
                path: argocd/applications/arc
                namespace: arc
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: backstage
                path: argocd/applications/backstage
                namespace: backstage
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: keycloak
                path: argocd/applications/keycloak
                namespace: keycloak
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: headlamp
                path: argocd/applications/headlamp
                namespace: headlamp
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
              - name: pgadmin
                path: argocd/applications/pgadmin
                namespace: pgadmin
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: manual
                enabled: "false"
              - name: graf
                path: argocd/applications/graf
                namespace: graf
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                  argocd.argoproj.io/compare-options: IgnoreExtraneous
                ignoreDifferences:
                  - group: serving.knative.dev
                    kind: Service
                    jsonPointers:
                      - /metadata/annotations
                      - /metadata/labels
                      - /spec/traffic
                      - /spec/template/metadata/annotations
                      - /spec/template/metadata/creationTimestamp
                      - /spec/template/metadata/labels
                      - /spec/template/spec/containers/0/ports/0/protocol
                      - /spec/template/spec/containers/0/readinessProbe
                      - /spec/template/spec/enableServiceLinks
                automation: manual
                enabled: "false"
              - name: convex
                path: argocd/applications/convex
                namespace: convex
                annotations:
                  argocd.argoproj.io/sync-wave: "4"
                automation: auto
                enabled: "false"
            selector:
              matchExpressions:
                - key: enabled
                  operator: NotIn
                  values: ["false", "False", "0"]
  template:
    metadata:
      name: "{{ .name }}{{ .suffix }}"
    spec:
      project: '{{ if hasKey . "project" }}{{ .project }}{{ else }}default{{ end }}'
      destination:
        namespace: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
      source:
        repoURL: https://github.com/proompteng/lab.git
        targetRevision: main
        path: "{{ .path }}"
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
      ignoreDifferences:
        - kind: StatefulSet
          group: apps
          namespace: dagster
          jqPathExpressions:
            - .spec.volumeClaimTemplates
        - kind: StatefulSet
          group: apps
          namespace: graf
          name: graf-db
          jqPathExpressions:
            - .spec.volumeClaimTemplates
        - kind: StatefulSet
          group: apps
          namespace: temporal
          name: elasticsearch-master
          jqPathExpressions:
            - .spec.volumeClaimTemplates[].apiVersion
            - .spec.volumeClaimTemplates[].kind
        - kind: StatefulSet
          group: apps
          namespace: nats
          name: nats
          jqPathExpressions:
            - .spec.persistentVolumeClaimRetentionPolicy
            - .spec.revisionHistoryLimit
            - .spec.updateStrategy
            - .spec.volumeClaimTemplates[].apiVersion
            - .spec.volumeClaimTemplates[].kind
            - .spec.volumeClaimTemplates[].spec.volumeMode
            - .spec.volumeClaimTemplates[].status
            - .spec.template.spec.containers[].livenessProbe.httpGet.scheme
            - .spec.template.spec.containers[].readinessProbe.httpGet.scheme
            - .spec.template.spec.containers[].startupProbe.httpGet.scheme
            - .spec.template.spec.containers[].terminationMessagePath
            - .spec.template.spec.containers[].terminationMessagePolicy
            - .spec.template.spec.dnsPolicy
            - .spec.template.spec.restartPolicy
            - .spec.template.spec.schedulerName
            - .spec.template.spec.volumes[].configMap.defaultMode
        - kind: Service
          group: serving.knative.dev
          namespace: graf
          name: graf
          jqPathExpressions:
            - .spec.template.spec.containers[].ports[].protocol
            - .spec.template.spec.containers[].readinessProbe.successThreshold
        - kind: Deployment
          group: apps
          namespace: istio-system
          name: istiod
          jqPathExpressions:
            - .spec.template.spec.containers[].env[].valueFrom.resourceFieldRef.divisor
        - kind: Deployment
          group: apps
          namespace: clickhouse-operator
          name: clickhouse-operator-altinity-clickhouse-operator
          jqPathExpressions:
            - .spec.template.spec.containers[].env[].valueFrom.resourceFieldRef.divisor
            - .spec.template.spec.containers[].env[].valueFrom.fieldRef.apiVersion
        - kind: DaemonSet
          group: apps
          namespace: istio-system
          name: istio-cni-node
          jqPathExpressions:
            - .spec.template.spec.containers[].env[].valueFrom.resourceFieldRef.divisor
        - kind: ValidatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: istio-validator-istio-system
          jqPathExpressions:
            - .webhooks[].failurePolicy
        - kind: ValidatingWebhookConfiguration
          group: admissionregistration.k8s.io
          name: istiod-default-validator
          jqPathExpressions:
            - .webhooks[].failurePolicy
        - kind: ClusterRole
          group: rbac.authorization.k8s.io
          name: knative-eventing-operator-aggregated-stable
          jqPathExpressions:
            - .rules
        - kind: ClusterRole
          group: rbac.authorization.k8s.io
          name: knative-serving-operator-aggregated-stable
          jqPathExpressions:
            - .rules
        - kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          name: flinkdeployments.flink.apache.org
          jqPathExpressions:
            - .spec.conversion
            - .spec.names.listKind
            - .spec.versions[].additionalPrinterColumns[].priority
        - kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          name: flinksessionjobs.flink.apache.org
          jqPathExpressions:
            - .spec.conversion
            - .spec.names.listKind
            - .spec.versions[].additionalPrinterColumns[].priority
        - kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          name: flinkstatesnapshots.flink.apache.org
          jqPathExpressions:
            - .spec.conversion
            - .spec.names.listKind
            - .spec.versions[].additionalPrinterColumns[].priority
        - kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          name: cdis.cdi.kubevirt.io
          jqPathExpressions:
            - .spec.versions
        - kind: VirtualMachine
          group: kubevirt.io
          namespace: workers
          name: workers
          jqPathExpressions:
            - .metadata.annotations
            - .metadata.finalizers
            - .spec.dataVolumeTemplates[].metadata.creationTimestamp
            - .spec.template.metadata.creationTimestamp
            - .spec.template.spec.architecture
            - .spec.template.spec.domain.firmware
            - .spec.template.spec.domain.machine
  templatePatch: |
    {{- if .annotations }}
    metadata:
      annotations:
      {{- range $key, $value := .annotations }}
          {{ $key }}: {{ $value | quote }}
      {{- end }}
    {{- end }}
    {{- $hasDestServer := hasKey . "destinationServer" -}}
    {{- $hasDestName := hasKey . "destinationName" -}}
    {{- $useLovely := or (not (hasKey . "renderWithLovely")) .renderWithLovely -}}
    {{- $auto := eq .automation "auto" -}}
    {{- $hasManagedNS := hasKey . "managedNamespaceMetadata" -}}
    {{- $deps := list -}}
    {{- $crds := list -}}
    {{- if hasKey . "dependsOnApps" -}}
    {{- $deps = .dependsOnApps -}}
    {{- end -}}
    {{- if hasKey . "requiresCrds" -}}
    {{- $crds = .requiresCrds -}}
    {{- end -}}

    {{- $hasInfo := or (gt (len $deps) 0) (gt (len $crds) 0) -}}
    {{- $needsSpec := or $hasDestServer $hasDestName $useLovely $auto $hasManagedNS $hasInfo (hasKey . "ignoreDifferences") -}}
    {{- if $needsSpec }}
    spec:
      {{- if or $hasDestServer $hasDestName }}
      destination:
        {{- if $hasDestServer }}
        server: '{{ .destinationServer }}'
        {{- end }}
        {{- if $hasDestName }}
        name: '{{ .destinationName }}'
        {{- end }}
      {{- end }}
      {{- if $hasInfo }}
      info:
        {{- if gt (len $deps) 0 }}
        - name: Depends On (Argo apps)
          value: '{{ join ", " $deps }}'
        {{- end }}
        {{- if gt (len $crds) 0 }}
        - name: Requires CRDs
          value: '{{ join ", " $crds }}'
        {{- end }}
      {{- end }}
      {{- if $useLovely }}
      source:
        plugin:
          name: lovely
      {{- end }}
      {{- if or $auto $hasManagedNS }}
      syncPolicy:
        {{- if $auto }}
        automated:
          prune: true
          selfHeal: true
        {{- end }}
        {{- if $hasManagedNS }}
        managedNamespaceMetadata:
          {{- if hasKey .managedNamespaceMetadata "labels" }}
          labels:
            {{- range $key, $value := .managedNamespaceMetadata.labels }}
            {{ $key }}: {{ $value | quote }}
            {{- end }}
          {{- end }}
          {{- if hasKey .managedNamespaceMetadata "annotations" }}
          annotations:
            {{- range $key, $value := .managedNamespaceMetadata.annotations }}
            {{ $key }}: {{ $value | quote }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if hasKey . "ignoreDifferences" }}
      ignoreDifferences: {{ toJson .ignoreDifferences }}
      {{- end }}
    {{- end }}
