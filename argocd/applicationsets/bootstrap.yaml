apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - matrix:
        generators:
          - list:
              elements: &bootstrap_clusters_default
                - cluster: in-cluster
                  suffix: ""
                  destinationServer: https://kubernetes.default.svc
          - list:
              elements: &bootstrap_elements
                - name: argocd
                  path: argocd/applications/argocd
                  namespace: argocd
                  annotations:
                    argocd.argoproj.io/sync-wave: "-2"
                  automation: manual
                  enabled: "true"
                - name: sealed-secrets
                  path: argocd/applications/sealed-secrets
                  namespace: sealed-secrets
                  annotations:
                    argocd.argoproj.io/sync-wave: "-2"
                  automation: auto
                  enabled: "true"
                - name: cert-manager
                  path: argocd/applications/cert-manager
                  namespace: cert-manager
                  annotations:
                    argocd.argoproj.io/sync-wave: "-1"
                  automation: auto
                  enabled: "false"
                  ignoreDifferences:
                    - group: admissionregistration.k8s.io
                      kind: MutatingWebhookConfiguration
                      name: cert-manager-webhook
                      jqPathExpressions:
                        - .webhooks[]?.clientConfig.caBundle
                    - group: admissionregistration.k8s.io
                      kind: ValidatingWebhookConfiguration
                      name: cert-manager-webhook
                      jqPathExpressions:
                        - .webhooks[]?.clientConfig.caBundle
                    - group: apiextensions.k8s.io
                      kind: CustomResourceDefinition
                      nameRegex: '.*cert-manager.io'
                      jqPathExpressions:
                        - .spec.conversion.webhook.clientConfig.caBundle
                    - group: apiregistration.k8s.io
                      kind: APIService
                      nameRegex: '.*cert-manager.io'
                      jqPathExpressions:
                        - .spec.caBundle
                - name: rook-ceph
                  path: argocd/applications/rook-ceph
                  namespace: rook-ceph
                  annotations:
                    argocd.argoproj.io/sync-wave: "-1"
                  automation: manual
                  enabled: "true"
                - name: local-path
                  path: argocd/applications/local-path
                  namespace: local-path-storage
                  annotations:
                    argocd.argoproj.io/sync-wave: "-1"
                  automation: manual
                  enabled: "false"
                  managedNamespaceMetadata:
                    labels:
                      pod-security.kubernetes.io/enforce: privileged
                      pod-security.kubernetes.io/audit: privileged
                      pod-security.kubernetes.io/warn: privileged
                - name: metallb-system
                  path: argocd/applications/metallb-system
                  namespace: metallb-system
                  annotations:
                    argocd.argoproj.io/sync-wave: "0"
                  automation: auto
                  enabled: "true"
                - name: traefik
                  path: argocd/applications/traefik
                  namespace: traefik
                  dependsOnApps:
                    - metallb-system
                  requiresCrds:
                    - traefik.io
                  annotations:
                    argocd.argoproj.io/sync-wave: "1"
                  automation: auto
                  enabled: "true"
                - name: tailscale
                  path: argocd/applications/tailscale
                  namespace: tailscale
                  annotations:
                    argocd.argoproj.io/sync-wave: "0"
                  automation: auto
                  enabled: "true"
                - name: registry
                  path: argocd/applications/registry
                  namespace: registry
                  annotations:
                    argocd.argoproj.io/sync-wave: "1"
                  automation: manual
                  enabled: "false"
            selector:
              matchExpressions:
                - key: enabled
                  operator: NotIn
                  values: ["false", "False", "0"]
  template:
    metadata:
      name: '{{ .name }}{{ .suffix }}'
    spec:
      project: '{{ if hasKey . "project" }}{{ .project }}{{ else }}default{{ end }}'
      destination:
        namespace: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
      source:
        repoURL: https://github.com/proompteng/lab.git
        targetRevision: main
        path: '{{ .path }}'
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
          - ClientSideApplyMigration=false
  templatePatch: |
    {{- if .annotations }}
    metadata:
      annotations:
    {{- range $key, $value := .annotations }}
        {{ $key }}: {{ $value | quote }}
    {{- end }}
    {{- end }}
    {{- $hasDestServer := hasKey . "destinationServer" -}}
    {{- $hasDestName := hasKey . "destinationName" -}}
    {{- $useLovely := or (not (hasKey . "renderWithLovely")) .renderWithLovely -}}
    {{- $auto := eq .automation "auto" -}}
    {{- $hasManagedNS := hasKey . "managedNamespaceMetadata" -}}
    {{- $deps := list -}}
    {{- $crds := list -}}
    {{- if hasKey . "dependsOnApps" -}}
    {{- $deps = .dependsOnApps -}}
    {{- end -}}
    {{- if hasKey . "requiresCrds" -}}
    {{- $crds = .requiresCrds -}}
    {{- end -}}

    {{- $hasInfo := or (gt (len $deps) 0) (gt (len $crds) 0) -}}
    {{- $needsSpec := or $hasDestServer $hasDestName $useLovely $auto $hasManagedNS $hasInfo (hasKey . "ignoreDifferences") -}}
{{- if $needsSpec }}
spec:
  {{- if or $hasDestServer $hasDestName }}
  destination:
    namespace: '{{ if hasKey . "namespace" }}{{ .namespace }}{{ else }}{{ .name }}{{ end }}'
    {{- if $hasDestServer }}
    server: '{{ .destinationServer }}'
    {{- end }}
    {{- if $hasDestName }}
    name: '{{ .destinationName }}'
    {{- end }}
  {{- end }}
  {{- if $hasInfo }}
  info:
    {{- if gt (len $deps) 0 }}
    - name: Depends On (Argo apps)
      value: '{{ join ", " $deps }}'
    {{- end }}
    {{- if gt (len $crds) 0 }}
    - name: Requires CRDs
      value: '{{ join ", " $crds }}'
    {{- end }}
  {{- end }}
  {{- if $useLovely }}
  source:
    plugin:
      name: lovely
  {{- end }}
  {{- if or $auto $hasManagedNS }}
  syncPolicy:
    {{- if $auto }}
    automated:
      prune: true
      selfHeal: true
    {{- end }}
    {{- if $hasManagedNS }}
    managedNamespaceMetadata:
      {{- if hasKey .managedNamespaceMetadata "labels" }}
      labels:
        {{- range $key, $value := .managedNamespaceMetadata.labels }}
        {{ $key }}: {{ $value | quote }}
        {{- end }}
      {{- end }}
      {{- if hasKey .managedNamespaceMetadata "annotations" }}
      annotations:
        {{- range $key, $value := .managedNamespaceMetadata.annotations }}
        {{ $key }}: {{ $value | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- if hasKey . "ignoreDifferences" }}
  ignoreDifferences: {{ toJson .ignoreDifferences }}
  {{- end }}
{{- end }}
