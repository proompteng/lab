apiVersion: v1
kind: Secret
metadata:
  name: saigak-cloud-init
type: Opaque
stringData:
  userdata: |-
    #cloud-config
    preserve_hostname: false
    hostname: saigak
    manage_etc_hosts: true
    package_update: true
    package_upgrade: false
    disk_setup:
      /dev/vdb:
        table_type: gpt
        layout: true
        overwrite: false
    fs_setup:
      - device: /dev/vdb1
        filesystem: ext4
        overwrite: false
    mounts:
      - ["/dev/vdb1", "/var/lib/ollama", "ext4", "defaults,nofail", "0", "2"]
    packages:
      - openssh-server
      - ca-certificates
      - curl
      - git
      - jq
      - gnupg
    write_files:
      - path: /etc/systemd/system/ollama.service.d/99-saigak.conf
        owner: root:root
        permissions: '0644'
        content: |-
          [Service]
          Environment="OLLAMA_HOST=0.0.0.0:11434"
          Environment="OLLAMA_MODELS=/var/lib/ollama"
      - path: /etc/saigak/qwen3-embedding-0-6b.modelfile
        owner: root:root
        permissions: '0644'
        content: |-
          FROM qwen3-embedding:0.6b
          TEMPLATE {{ .Prompt }}
          PARAMETER num_ctx 4096
      - path: /etc/saigak/qwen3-coder-30b.modelfile
        owner: root:root
        permissions: '0644'
        content: |-
          FROM qwen3-coder:30b
          PARAMETER num_ctx 8192
      - path: /etc/netplan/99-saigak.yaml
        owner: root:root
        permissions: '0600'
        content: |-
          network:
            version: 2
            renderer: networkd
            ethernets:
              primary:
                match:
                  name: 'en*'
                dhcp4: true
                dhcp6: false
      - path: /var/lib/cloud/scripts/per-boot/10-netplan-apply
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          netplan generate || true
          netplan apply || true
    users:
      - name: ubuntu
        groups: [sudo]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOE//lpGZI2015yMUjHwhWJjgarTLIsqQBIFXlAanPvS
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDVYPSSdt6tjSWRooRm7nUDS73CebsP92G6GjFa9X+zy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzVze3nx4QPa6t9Wvp5FLrcAlM7BDLUmxf049N4HC6d
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDW2gOD2bqZxDwKEsfZM+ggSBV+DlTrUxMQY8JxDMVgG
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlmf/vteEu7gLBfxyEUjVtQiZ2LCqU6zo+6+G5gmaaa
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEht47QYSXM1n78ww4Aw9jHS50FR9IpQlQGU8emLg1ed
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB9gANXCk/KnE27qvzZk9pGSc1wIzSUewHhqZQXwFJs+
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINXAA7B1vTdTvaMTUcDJTD96v1oiNZx6XI+amVwPXPzy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOco184B4eZEOoLP5ehTK9cgsJgbelKWUxXuO3+S38U/
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII0/89LwFLAM6tu2gtbwVDrQwFhPiW55RciZo0RUVMrF
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH77X+Ekaz8sSLPImUYO8VYhgDDcb+DXkqU26UZ2PaAP
          - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMqGcgm6U9z2d9kH5SNjm4wZumlbMxndFi40iNEhI2OKvfSoE4OQJQ8j5KCiu6GrcE2biJcqP1dkMCaJ8xcaYA8= sshid.io/gregkonush
    ssh_pwauth: false
    disable_root: true
    runcmd:
      - [ bash, -lc, 'systemctl enable --now ssh' ]
      - [ bash, -lc, 'netplan generate && netplan apply || true' ]
      - [ bash, -lc, 'apt-get update' ]
      - [ bash, -lc, 'DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-drivers-common' ]
      - [ bash, -lc, 'installed=0; for pkg in nvidia-driver-590 nvidia-driver-580 nvidia-driver-570 nvidia-driver-550 nvidia-driver-535; do if apt-cache show $pkg >/dev/null 2>&1; then if DEBIAN_FRONTEND=noninteractive apt-get install -y $pkg; then installed=1; break; fi; fi; done; if [ $installed -ne 1 ]; then echo "failed to install any nvidia-driver package" >&2; exit 1; fi' ]
      - [ bash, -lc, 'modprobe nvidia || true; modprobe nvidia_uvm || true' ]
      - [ bash, -lc, 'for i in $(seq 1 90); do if nvidia-smi -L; then break; fi; sleep 2; done; nvidia-smi -L' ]
      - [ bash, -lc, 'curl -fsSL https://ollama.com/install.sh | sh' ]
      - [ bash, -lc, 'systemctl stop ollama || true' ]
      - [ bash, -lc, 'mkdir -p /etc/systemd/system/ollama.service.d' ]
      - [ bash, -lc, 'id ollama >/dev/null 2>&1 && chown -R ollama:ollama /var/lib/ollama || true' ]
      - [ bash, -lc, 'systemctl daemon-reload' ]
      - [ bash, -lc, 'systemctl enable --now ollama' ]
      - [ bash, -lc, 'sleep 2' ]
      - [ bash, -lc, 'curl -fsS http://127.0.0.1:11434/api/version' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama pull qwen3-embedding:0.6b' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama create qwen3-embedding-saigak:0.6b -f /etc/saigak/qwen3-embedding-0-6b.modelfile' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama show qwen3-embedding-saigak:0.6b >/dev/null' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama pull qwen3-coder:30b' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama create qwen3-coder-saigak:30b -f /etc/saigak/qwen3-coder-30b.modelfile' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama show qwen3-coder-saigak:30b >/dev/null' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama create qwen3-coder-saigak:30b-a3b-q4_K_M -f /etc/saigak/qwen3-coder-30b.modelfile' ]
      - [ bash, -lc, 'export HOME=/home/ubuntu OLLAMA_HOST=127.0.0.1:11434; ollama show qwen3-coder-saigak:30b-a3b-q4_K_M >/dev/null' ]
