apiVersion: batch/v1
kind: Job
metadata:
  name: rook-ceph-rgw-loki-bucket
  namespace: rook-ceph
  labels:
    app.kubernetes.io/name: rook-ceph-rgw-loki-bucket
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-options: Replace=true
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        app.kubernetes.io/name: rook-ceph-rgw-loki-bucket
    spec:
      restartPolicy: OnFailure
      containers:
        - name: create-bucket
          image: public.ecr.aws/aws-cli/aws-cli:2.22.34
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: rook-ceph-rgw-loki
                  key: accessKey
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: rook-ceph-rgw-loki
                  key: secretKey
            - name: AWS_DEFAULT_REGION
              valueFrom:
                secretKeyRef:
                  name: rook-ceph-rgw-loki
                  key: region
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: rook-ceph-rgw-loki
                  key: endpoint
            - name: BUCKET
              valueFrom:
                secretKeyRef:
                  name: rook-ceph-rgw-loki
                  key: bucket
            - name: AWS_EC2_METADATA_DISABLED
              value: "true"
            - name: AWS_S3_FORCE_PATH_STYLE
              value: "true"
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              attempt=0
              until aws --endpoint-url="$S3_ENDPOINT" s3api list-buckets >/dev/null 2>&1; do
                attempt=$((attempt+1))
                if [ "$attempt" -gt 30 ]; then
                  echo "RGW not responding after $attempt attempts" >&2
                  exit 1
                fi
                echo "waiting for RGW endpoint $S3_ENDPOINT (attempt $attempt)" >&2
                sleep 10
              done

              if aws --endpoint-url="$S3_ENDPOINT" s3api head-bucket --bucket "$BUCKET" >/dev/null 2>&1; then
                echo "Bucket $BUCKET already exists"
              else
                aws --endpoint-url="$S3_ENDPOINT" s3api create-bucket --bucket "$BUCKET"
                echo "Created bucket $BUCKET"
              fi
