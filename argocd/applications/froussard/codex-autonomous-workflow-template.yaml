apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: codex-autonomous
  namespace: jangar
  annotations:
    codex-universal-image-digest: latest
spec:
  serviceAccountName: jangar-inspector
  parallelism: 1
  synchronization:
    mutex:
      name: 'codex-{{=sprig.replace("/", "-", workflow.parameters.repository)}}-{{workflow.parameters.issue_number}}'
  entrypoint: codex-dag
  arguments:
    parameters:
      - name: repository
        value: ''
      - name: issue_number
        value: ''
      - name: base
        value: 'main'
      - name: head
        value: ''
      - name: prompt
        value: ''
      - name: rawEvent
        value: '{}'
      - name: eventBody
        value: '{}'
      - name: implementation_iterations
        value: '1'
      - name: iteration_cycle
        value: '1'
  workflowMetadata:
    labels:
      codex.stage: implementation
      codex.issue_number: '{{workflow.parameters.issue_number}}'
    annotations:
      codex.repository: '{{workflow.parameters.repository}}'
      codex.head: '{{workflow.parameters.head}}'
      codex.base: '{{workflow.parameters.base}}'
  volumes:
    - name: workdir
      persistentVolumeClaim:
        claimName: jangar-workspace-rwx
    - name: docker-lib
      emptyDir: {}
  templates:
    - name: codex-dag
      steps:
        - - name: implementation
            templateRef:
              name: codex-run
              template: codex-run
            withSequence:
              start: "1"
              end: "{{workflow.parameters.implementation_iterations}}"
            arguments:
              parameters:
                - name: repository
                  value: '{{workflow.parameters.repository}}'
                - name: issue_number
                  value: '{{workflow.parameters.issue_number}}'
                - name: base
                  value: '{{workflow.parameters.base}}'
                - name: head
                  value: '{{workflow.parameters.head}}'
                - name: prompt
                  value: '{{workflow.parameters.prompt}}'
                - name: stage
                  value: implementation
                - name: iteration
                  value: '{{item}}'
                - name: iteration_cycle
                  value: '{{workflow.parameters.iteration_cycle}}'
                - name: rawEvent
                  value: '{{workflow.parameters.rawEvent}}'
                - name: eventBody
                  value: '{{workflow.parameters.eventBody}}'
        - - name: judge
            templateRef:
              name: codex-run
              template: codex-run
            arguments:
              parameters:
                - name: repository
                  value: '{{workflow.parameters.repository}}'
                - name: issue_number
                  value: '{{workflow.parameters.issue_number}}'
                - name: base
                  value: '{{workflow.parameters.base}}'
                - name: head
                  value: '{{workflow.parameters.head}}'
                - name: prompt
                  value: '{{workflow.parameters.prompt}}'
                - name: stage
                  value: judge
                - name: iteration
                  value: '{{workflow.parameters.implementation_iterations}}'
                - name: iteration_cycle
                  value: '{{workflow.parameters.iteration_cycle}}'
                - name: rawEvent
                  value: '{{workflow.parameters.rawEvent}}'
                - name: eventBody
                  value: '{{workflow.parameters.eventBody}}'
