apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: github-codex-implementation
  namespace: argo-workflows
  labels:
    codex.stage: implementation
spec:
  serviceAccountName: codex-workflow
  entrypoint: implement
  arguments:
    parameters:
      - name: rawEvent
        value: '{}'
      - name: eventBody
        value: '{}'
      - name: head
        value: ''
      - name: base
        value: 'main'
  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        storageClassName: longhorn
  volumes:
    - name: docker-lib
      emptyDir: {}
  templates:
    - name: implement
      inputs:
        parameters:
          - name: rawEvent
          - name: eventBody
          - name: head
          - name: base
      container:
        image: registry.ide-newton.ts.net/lab/codex-universal:latest
        imagePullPolicy: Always
        env:
          - name: HEAD_BRANCH
            value: '{{inputs.parameters.head}}'
          - name: BASE_BRANCH
            value: '{{inputs.parameters.base}}'
          - name: DISCORD_BOT_TOKEN
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: bot-token
                optional: true
          - name: DISCORD_GUILD_ID
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: guild-id
                optional: true
          - name: DISCORD_CATEGORY_ID
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: category-id
                optional: true
          - name: GH_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-token
                key: token
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-token
                key: token
          - name: CODEX_GRAF_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: graf-api
                key: bearer-tokens
                optional: true
          - name: LGTM_LOKI_ENDPOINT
            value: http://observability-loki-loki-distributed-gateway.observability.svc.cluster.local/loki/api/v1/push
          - name: DOCKER_HOST
            value: tcp://localhost:2375
          - name: DOCKER_TLS_VERIFY
            value: ""
          - name: DOCKER_ENABLED
            value: "1"
        command: ["/usr/local/bin/codex-bootstrap"]
        args:
          - "/bin/bash"
          - "-lc"
          - |
            set -euo pipefail

            EVENT_FILE=$(mktemp)
            EVENT_BODY_B64='{{inputs.parameters.eventBody}}'
            if [[ -z "$EVENT_BODY_B64" ]]; then
              echo "Missing Codex event payload" >&2
              exit 1
            fi
            printf '%s' "$EVENT_BODY_B64" | base64 --decode > "$EVENT_FILE"

            WORKTREE_DIR="${WORKTREE:-/workspace/lab}"

            STAGE=$(jq -r '.stage // ""' "$EVENT_FILE")
            if [[ "$STAGE" != "implementation" ]]; then
              echo "Skipping unsupported stage: '$STAGE'"
              exit 0
            fi

            export OUTPUT_PATH="${IMPLEMENTATION_OUTPUT_PATH:-/workspace/lab/.codex-implementation.log}"
            export POST_TO_GITHUB=true

            echo "Executing implementation workflow" >&2
            /usr/local/bin/codex-implement "$EVENT_FILE"
        volumeMounts:
          - name: workdir
            mountPath: /workspace
          - name: docker-lib
            mountPath: /var/lib/docker
            readOnly: true
        resources:
          requests:
            cpu: "4"
            memory: 8Gi
          limits:
            cpu: "6"
            memory: 12Gi
      sidecars:
        - name: docker
          image: docker:25.0-dind
          command: ["dockerd-entrypoint.sh"]
          args:
            - "--host=tcp://0.0.0.0:2375"
            - "--host=unix:///var/run/docker.sock"
          env:
            - name: DOCKER_TLS_CERTDIR
              value: ""
            - name: XDG_RUNTIME_DIR
              value: /tmp/docker-runtime
            - name: DOCKER_HOST
              value: tcp://0.0.0.0:2375
          ports:
            - containerPort: 2375
              name: docker
          securityContext:
            privileged: true
          volumeMounts:
            - name: docker-lib
              mountPath: /var/lib/docker
          resources:
            requests:
              cpu: "1"
              memory: 2Gi
            limits:
              cpu: "2"
              memory: 4Gi
      outputs:
        artifacts:
          - name: implementation-changes
            path: /workspace/lab/.codex-implementation-changes.tar.gz
          - name: implementation-patch
            path: /workspace/lab/.codex-implementation.patch
          - name: implementation-status
            path: /workspace/lab/.codex-implementation-status.txt
