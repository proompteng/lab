apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: jangar-db
spec:
  instances: 1
  primaryUpdateStrategy: unsupervised
  storage:
    storageClass: rook-ceph-block
    size: 5Gi
  bootstrap:
    initdb:
      database: jangar
      owner: jangar
      encoding: "UTF8"
      dataChecksums: true
      postInitApplicationSQL:
        - CREATE EXTENSION IF NOT EXISTS pgcrypto;
        - CREATE EXTENSION IF NOT EXISTS vector;
  backup:
    barmanObjectStore:
      destinationPath: s3://argo-workflows/cnpg/jangar
      endpointURL: http://observability-minio.minio.svc.cluster.local:9000
      s3Credentials:
        accessKeyId:
          name: observability-minio-creds
          key: accesskey
        secretAccessKey:
          name: observability-minio-creds
          key: secretkey
    retentionPolicy: "14d"
  inheritedMetadata:
    annotations:
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "agents,pgadmin"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "agents,pgadmin"
  monitoring:
    enablePodMonitor: true
# CNPG defaults generate application credentials in `jangar-db-app` (uri, user, password, host, port, dbname)
# and the CA bundle in `jangar-db-ca` (ca.crt). Jangar currently uses `PGSSLMODE=require` and does not pass
# `sslrootcert` URL params (Bunâ€™s Postgres client treats those as server GUCs and errors).
