# Kestra (lab)

- Helm chart: `kestra/kestra` v1.0.18 (release name `kestra`).
- Persistence: CloudNativePG cluster `kestra-db` (2 instances, 50Gi Longhorn PVCs, pod monitor enabled).
- Object storage: MinIO tenant `kestra-minio` in namespace `minio` (1 server, 2Ã—20Gi Longhorn PVCs) with bucket `kestra` created by a PostSync Job.
- Access: Tailscale LoadBalancer `kestra-tailscale` exposes the UI at tailnet hostname **kestra** on port 80.

## Secrets
- `kestra-minio-creds` (SealedSecret in `minio`) carries root + Kestra access keys and is reflected into the `kestra` namespace.
- To rotate keys:
  1. Fetch the sealing cert: `kubeseal --fetch-cert --controller-name sealed-secrets --controller-namespace sealed-secrets > /tmp/sealed-secrets-cert.pem`.
  2. Regenerate the plain Secret with new values (keep key names: `accesskey`, `secretkey`, `kestra-access-key`, `kestra-secret-key`, `config.env`).
  3. Seal it: `kubeseal --cert /tmp/sealed-secrets-cert.pem -o yaml < secret.yaml > argocd/applications/kestra/minio-credentials-sealedsecret.yaml`.
  4. Commit and sync; the reflector re-creates the mirrored secret in `kestra`.

## Notes
- DinD sidecar is disabled to avoid privileged workloads; enable via `deployments.standalone.dind.enabled=true` in `kestra-values.yaml` if Docker runner support is required.
- Kestra relies on the `kestra-db-app` secret generated by CloudNativePG for JDBC credentials and the reflected MinIO secret for S3 access; config uses environment variable substitution to avoid embedding secrets in Git.
