apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-health-report-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - torghutNamespace
      - torghutService
      - wsService
      - flinkRestService
      - guardrailsService
  text: |
    Objective: Produce a single Torghut health report (read-only) using in-cluster HTTP endpoints only.

    Constraints:
    - Do not mutate cluster state.
    - Do not open PRs.
    - Assume kubectl is unavailable or unreliable.

    Inputs (from AgentRun parameters):
    - torghutNamespace
    - torghutService
    - wsService
    - flinkRestService
    - guardrailsService

    Steps:
    1) Build base URLs using service DNS names with `.svc.cluster.local`.
       - TORGHUT_BASE = http://<torghutService>.<torghutNamespace>.svc.cluster.local
       - WS_BASE = http://<wsService>.<torghutNamespace>.svc.cluster.local
       - FLINK_BASE = http://<flinkRestService>.<torghutNamespace>.svc.cluster.local:8081
       - GUARDRAILS_BASE = http://<guardrailsService>.<torghutNamespace>.svc.cluster.local:9108
    2) Query each endpoint and capture status/body snippets.
       - GET ${WS_BASE}/readyz and ${WS_BASE}/healthz
       - GET ${FLINK_BASE}/overview and ${FLINK_BASE}/jobs/overview
       - GET ${TORGHUT_BASE}/trading/status and ${TORGHUT_BASE}/trading/health
       - GET ${GUARDRAILS_BASE}/metrics
    3) From metrics, extract:
       - torghut_clickhouse_guardrails_clickhouse_up
       - torghut_clickhouse_guardrails_disk_free_ratio
       - torghut_clickhouse_guardrails_any_replica_readonly
       - torghut_clickhouse_guardrails_ta_signals_max_event_ts_seconds
       - torghut_clickhouse_guardrails_ta_microbars_max_window_end_seconds
       - torghut_clickhouse_guardrails_last_scrape_success
    4) Compute ages for max TA timestamps and classify freshness.
       - If market is open (US session, Mon-Fri 09:30-16:00 America/New_York) and age > 300s => degraded.
       - During closed hours report stale signal age without triggering failure by staleness alone.

    Output:
    - Produce a concise Markdown report with sections: Summary, WS, Flink, Trading, Guardrails, Freshness.
    - Conclude with a single health verdict: healthy | degraded | down.
---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-v3-promotion-policy-check-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - candidateId
      - runId
      - promotionTarget
      - policyPath
      - candidateStatePath
      - gateReportPath
      - artifactRoot
      - artifactPath
  text: |
    Objective: Enforce promotion prerequisite and rollback-readiness checks before stage promotion.

    Guardrails:
    - Read-only policy evaluation; no cluster mutation.
    - Promotion progression is denied when either prerequisite or rollback checks fail.

    Inputs:
    - candidateId, runId, promotionTarget
    - policyPath, candidateStatePath, gateReportPath
    - artifactRoot, artifactPath

    Steps:
    1) Run:
       - python services/torghut/scripts/validate_promotion_policy.py \
         --policy ${policyPath} \
         --state ${candidateStatePath} \
         --gate-report ${gateReportPath} \
         --artifact-root ${artifactRoot} \
         --promotion-target ${promotionTarget} \
         --output ${artifactPath}/promotion-policy-check.json
    2) Fail fast if `promotion_progression_allowed` is false.
    3) Publish the decision artifact path and reasons.
---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-v3-promotion-policy-dry-run-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - promotionTarget
      - policyPath
      - gateReportPath
      - artifactPath
      - simulateMissingArtifact
      - simulateStaleRollback
  text: |
    Objective: Execute dry-run harness proving policy enforcement behavior for promotion and rollback workflows.

    Constraints:
    - Must remain dry-run only.
    - Must emit structured JSON artifact to `${artifactPath}`.

    Inputs:
    - promotionTarget, policyPath, gateReportPath, artifactPath
    - simulateMissingArtifact, simulateStaleRollback

    Steps:
    1) Build optional simulation flags:
       - SIM_MISSING = `--simulate-missing-artifact` when simulateMissingArtifact is true.
       - SIM_STALE = `--simulate-stale-rollback` when simulateStaleRollback is true.
    2) Run:
       - python services/torghut/scripts/run_governance_policy_dry_run.py \
         --policy ${policyPath} \
         --gate-report ${gateReportPath} \
         --promotion-target ${promotionTarget} \
         ${SIM_MISSING} \
         ${SIM_STALE} \
         --output ${artifactPath}/governance-policy-dry-run.json
    3) Include `promotion_progression_allowed` and failure reasons in output summary.
---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-gated-actuation-runner-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - repository
      - base
      - head
      - torghutNamespace
      - gitopsPath
      - change
      - reason
      - confirm
  text: |
    Objective: Perform a single Torghut recovery actuation step via GitOps PR.

    Guardrails:
    - Do not perform any direct kubectl mutation unless explicitly requested as an emergency.
    - Only edit files under ${gitopsPath}.
    - Require confirm == ACTUATE_TORGHUT.
    - Supported changes only: pause-trading, restart-ws, suspend-ta, resume-ta.
    - PRs are mandatory for all requested changes.

    Inputs (from AgentRun parameters):
    - repository, base, head
    - torghutNamespace, gitopsPath
    - change, reason, confirm

    Steps:
    1) Validate `change` is one of: pause-trading, restart-ws, suspend-ta, resume-ta.
    2) Validate `confirm` is exactly `ACTUATE_TORGHUT`.
    3) Apply the corresponding patch under `argocd/applications/torghut`:
       - pause-trading: set TRADING_ENABLED="false" in knative-service.yaml.
       - restart-ws: bump kubectl.kubernetes.io/restartedAt in ws/deployment.yaml.
       - suspend-ta: set spec.job.state: suspended in ta/flinkdeployment.yaml.
       - resume-ta: set spec.job.state: running and bump spec.restartNonce if needed.
    4) Open a PR against ${repository} with base ${base} and head ${head}.
    5) Output PR URL and clear rollback instructions.
---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-market-context-fundamentals-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - symbol
      - domain
      - asOfUtc
      - reason
      - callbackUrl
      - requestId
  text: |
    Objective: Build a fundamentals market-context snapshot for `${symbol}` and publish it to `${callbackUrl}`.

    Guardrails:
    - Read-only research task; do not mutate cluster state.
    - Use at least 2 independent citations.
    - All timestamps must be UTC ISO-8601 strings.
    - Keep qualityScore in [0, 1].

    Inputs:
    - symbol, domain, asOfUtc, reason
    - callbackUrl, requestId

    Required output payload shape:
    {
      "symbol": "<symbol>",
      "domain": "fundamentals",
      "asOfUtc": "<ISO timestamp>",
      "sourceCount": <integer>,
      "qualityScore": <number 0..1>,
      "payload": {
        "thesis": "<short summary>",
        "valuation": { ... },
        "growth": { ... },
        "profitability": { ... },
        "balanceSheet": { ... },
        "upcomingCatalysts": [ ... ]
      },
      "citations": [
        { "source": "<publisher>", "publishedAt": "<ISO timestamp>", "url": "<https url or null>" }
      ],
      "riskFlags": [ ... ],
      "provider": "codex-spark",
      "runStatus": "succeeded",
      "requestId": "<requestId>"
    }

    Steps:
    1) Research current fundamentals for `${symbol}` (valuation, growth, profitability, balance-sheet/capital structure, near-term catalysts).
    2) Write the JSON payload to `/tmp/market-context-fundamentals.json`.
    3) Submit the payload:
       - AUTH=()
       - TOKEN_PATH="/var/run/secrets/kubernetes.io/serviceaccount/token"
       - if [ -r "${TOKEN_PATH}" ]; then TOKEN="$(tr -d '\n' < "${TOKEN_PATH}")"; fi
       - if [ -n "${TOKEN:-}" ]; then AUTH=(-H "authorization: Bearer ${TOKEN}"); fi
       - curl -fsS -X POST "${callbackUrl}" -H "content-type: application/json" "${AUTH[@]}" --data-binary @/tmp/market-context-fundamentals.json
    4) Ensure callback response contains `"ok": true`. If it fails, retry once; if still failing, exit non-zero.
---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: torghut-market-context-news-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - symbol
      - domain
      - asOfUtc
      - reason
      - callbackUrl
      - requestId
  text: |
    Objective: Build a news market-context snapshot for `${symbol}` and publish it to `${callbackUrl}`.

    Guardrails:
    - Read-only research task; do not mutate cluster state.
    - Prioritize the most recent high-signal news (last 24h, then 7d if sparse).
    - Use at least 3 citations.
    - All timestamps must be UTC ISO-8601 strings.
    - Keep qualityScore in [0, 1].

    Inputs:
    - symbol, domain, asOfUtc, reason
    - callbackUrl, requestId

    Required output payload shape:
    {
      "symbol": "<symbol>",
      "domain": "news",
      "asOfUtc": "<ISO timestamp>",
      "sourceCount": <integer>,
      "qualityScore": <number 0..1>,
      "payload": {
        "summary": "<short summary>",
        "headlines": [
          {
            "headline": "<title>",
            "publisher": "<publisher>",
            "publishedAt": "<ISO timestamp>",
            "url": "<https url or null>",
            "marketImpact": "positive|negative|mixed|neutral"
          }
        ],
        "eventRisk": "low|medium|high"
      },
      "citations": [
        { "source": "<publisher>", "publishedAt": "<ISO timestamp>", "url": "<https url or null>" }
      ],
      "riskFlags": [ ... ],
      "provider": "codex-spark",
      "runStatus": "succeeded",
      "requestId": "<requestId>"
    }

    Steps:
    1) Gather recent high-signal company/sector/macro news relevant to `${symbol}`.
    2) Write the JSON payload to `/tmp/market-context-news.json`.
    3) Submit the payload:
       - AUTH=()
       - TOKEN_PATH="/var/run/secrets/kubernetes.io/serviceaccount/token"
       - if [ -r "${TOKEN_PATH}" ]; then TOKEN="$(tr -d '\n' < "${TOKEN_PATH}")"; fi
       - if [ -n "${TOKEN:-}" ]; then AUTH=(-H "authorization: Bearer ${TOKEN}"); fi
       - curl -fsS -X POST "${callbackUrl}" -H "content-type: application/json" "${AUTH[@]}" --data-binary @/tmp/market-context-news.json
    4) Ensure callback response contains `"ok": true`. If it fails, retry once; if still failing, exit non-zero.
