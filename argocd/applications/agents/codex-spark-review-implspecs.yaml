apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-review-orchestrator-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - stage
  summary: 'Codex Spark review-and-fix workflow orchestrator'
  text: |
    You are the Codex Spark review-and-fix coordinator.
    Use `stage` to determine which phase to run:

    - `stage=review`: run the review step and write review output to
      `/workspace/.agentrun/codex-spark-review/review-notes.md`.
    - `stage=fix`: read that review output file and apply actionable fixes.

    Keep changes scoped to repository code and prefer minimal edits.
  acceptanceCriteria:
    - For review stage, produce and persist review output in the agreed file path.
    - For fix stage, implement actionable fixes from the review output.

---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-review-step-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - base
  summary: 'Run non-interactive codex review and persist findings'
  text: |
    Objective: Perform a review-only pass and persist findings for the same branch baseline.

    Review prompt:
    - You are reviewing the currently checked-out changes for correctness, regressions, missing tests,
      security risks, and maintainability issues.
    - Keep findings actionable and scoped to code changes only.
    - Prioritize high-confidence issues and include file-level context in each finding.

    1) Create/refresh the review output directory:
       `mkdir -p /workspace/.agentrun/codex-spark-review`
    2) Run the review command against `main` and pipe all output into:
       `/workspace/.agentrun/codex-spark-review/review-notes.md`
       so downstream automation can consume it via Unix pipe semantics.
    3) Exit after writing the file.

    Exact shell sequence to run:
    `mkdir -p /workspace/.agentrun/codex-spark-review && codex review --base main | tee /workspace/.agentrun/codex-spark-review/review-notes.md`

    This step should not apply code changes.
  acceptanceCriteria:
    - A non-empty `/workspace/.agentrun/codex-spark-review/review-notes.md` file exists at step end.

---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-fix-step-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - stage
  summary: 'Apply fixes from prior review output'
  text: |
    Objective: Consume review output and implement suggested fixes.

    1) Read the entire file `/workspace/.agentrun/codex-spark-review/review-notes.md`.
    2) Treat its contents as review findings and apply the requested, actionable fixes in the workspace.
    3) Use minimal edits and keep behavior stable; do not broaden scope.
    4) Summarize changed files and changed hunks at the end of the run.

    If the review file is missing or empty, fail with a clear message that the review step must run first.
  acceptanceCriteria:
    - The review file is read before any code edit.
    - Changes are limited to actionable items found in that review output.
  labels:
    - codex-spark
    - review
    - fix
