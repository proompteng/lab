apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-review-orchestrator-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - stage
  summary: 'Codex Spark review-and-fix workflow orchestrator'
  text: |
    You are the Codex Spark review-and-fix coordinator.
    Use `stage` to determine which phase to run:

    - `stage=review`: run the review step and write review output to
      `/workspace/.agentrun/codex-spark-review/review-notes.md`.
    - `stage=fix`: read that review output file and apply actionable fixes.

    Keep changes scoped to repository code and prefer minimal edits.
  acceptanceCriteria:
    - For review stage, produce and persist review output in the agreed file path.
    - For fix stage, implement actionable fixes from the review output.

---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-review-step-v1
  namespace: agents
spec:
  summary: 'Run non-interactive Codex review against main and persist findings.'
  text: |
    Objective: Run a single non-interactive review pass and persist raw output only.

    Constraints:
    - Do not edit source files.
    - Do not print preambles or summaries.
    - Do not produce any output beyond running the command and persisting its output.
    - Output path must be `/workspace/.agentrun/codex-spark-review/review-notes.md`.

    Exact command sequence:
    1) `mkdir -p /workspace/.agentrun/codex-spark-review`
    2) `codex review --base main 2>&1 | tee /workspace/.agentrun/codex-spark-review/review-notes.md`
    3) If review exits non-zero, fail with the same exit code.
    4) Fail if `review-notes.md` is empty.

    Exit immediately after writing the file. No code changes.
  acceptanceCriteria:
    - The file `/workspace/.agentrun/codex-spark-review/review-notes.md` exists.
    - The file is non-empty.
    - The Codex review command was run once with `--base main`.

---
apiVersion: agents.proompteng.ai/v1alpha1
kind: ImplementationSpec
metadata:
  name: codex-spark-fix-step-v1
  namespace: agents
spec:
  contract:
    requiredKeys:
      - stage
  summary: 'Apply fixes from prior review output'
  text: |
    Objective: Consume review output and implement suggested fixes.

    1) Read the entire file `/workspace/.agentrun/codex-spark-review/review-notes.md`.
    2) Treat its contents as review findings and apply the requested, actionable fixes in the workspace.
    3) Use minimal edits and keep behavior stable; do not broaden scope.
    4) Summarize changed files and changed hunks at the end of the run.

    If the review file is missing or empty, fail with a clear message that the review step must run first.
  acceptanceCriteria:
    - The review file is read before any code edit.
    - Changes are limited to actionable items found in that review output.
  labels:
    - codex-spark
    - review
    - fix
