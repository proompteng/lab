fullnameOverride: pgadmin

image:
  tag: "9.11"

service:
  type: LoadBalancer
  annotations:
    tailscale.com/hostname: pgadmin

env:
  email: greg@proompteng.ai
  enhanced_cookie_protection: "False"

existingSecret: pgadmin-auth

envVarsExtra:
  - name: PGADMIN_SERVER_JSON_FILE
    value: /var/lib/pgadmin/servers/servers.json
  - name: PGADMIN_CONFIG_ENABLE_SERVER_PASS_EXEC_CMD
    value: "True"

extraVolumes:
  - name: pgadmin-servers
    emptyDir: {}
  - name: cnpg-app-secrets
    projected:
      sources:
        - secret:
            name: keycloak-db-app
            items:
              - key: uri
                path: keycloak-db-app/uri
              - key: password
                path: keycloak-db-app/password
        - secret:
            name: coder-cluster-app
            items:
              - key: uri
                path: coder-cluster-app/uri
              - key: password
                path: coder-cluster-app/password
        - secret:
            name: convex-db-app
            items:
              - key: uri
                path: convex-db-app/uri
              - key: password
                path: convex-db-app/password
        - secret:
            name: jangar-db-app
            items:
              - key: uri
                path: jangar-db-app/uri
              - key: password
                path: jangar-db-app/password
        - secret:
            name: golink-db-app
            items:
              - key: uri
                path: golink-db-app/uri
              - key: password
                path: golink-db-app/password
        - secret:
            name: facteur-vector-cluster-app
            items:
              - key: uri
                path: facteur-vector-cluster-app/uri
              - key: password
                path: facteur-vector-cluster-app/password
        - secret:
            name: dernier-db-app
            items:
              - key: uri
                path: dernier-db-app/uri
              - key: password
                path: dernier-db-app/password
        - secret:
            name: torghut-db-app
            items:
              - key: uri
                path: torghut-db-app/uri
              - key: password
                path: torghut-db-app/password
        - secret:
            name: torghut-clickhouse-auth
            items:
              - key: torghut_password
                path: torghut-clickhouse-auth/password

extraVolumeMounts:
  - name: pgadmin-servers
    mountPath: /var/lib/pgadmin/servers
  - name: cnpg-app-secrets
    mountPath: /etc/pgadmin/secrets
    readOnly: true

extraInitContainers: |
  - name: pgadmin-servers
    image: python:3.12-alpine
    env:
      - name: PGADMIN_USER_EMAIL
        value: {{ .Values.env.email | quote }}
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        python - <<'PY'
        import json
        import os
        from pathlib import Path
        from urllib.parse import parse_qs, unquote, urlparse

        def preprocess_username(value: str) -> str:
            if not value:
                return value
            if value[0].isdigit():
                value = f'pga_user_{value}'
            return value.replace('@', '_').replace('/', 'slash').replace('\\', 'slash')

        clusters = [
            {'secret': 'keycloak-db-app', 'name': 'keycloak-db'},
            {'secret': 'coder-cluster-app', 'name': 'coder-cluster'},
            {'secret': 'convex-db-app', 'name': 'convex-db'},
            {'secret': 'jangar-db-app', 'name': 'jangar-db'},
            {'secret': 'golink-db-app', 'name': 'golink-db'},
            {'secret': 'facteur-vector-cluster-app', 'name': 'facteur-vector-cluster'},
            {'secret': 'dernier-db-app', 'name': 'dernier-db'},
            {'secret': 'torghut-db-app', 'name': 'torghut-db'},
            {
                'secret': 'torghut-clickhouse-auth',
                'name': 'torghut-clickhouse',
                'group': 'ClickHouse',
                'host': 'torghut-clickhouse.torghut.svc.cluster.local',
                'port': 9005,
                'dbname': 'torghut',
                'username': 'torghut',
                'sslmode': 'disable',
                'password_key': 'password',
            },
        ]

        servers = {}
        index = 1
        passfile_entries = []
        passfile_name = 'pgpass'
        user_email = os.environ.get('PGADMIN_USER_EMAIL', 'pgadmin@proompteng.ai')
        storage_dir = Path('/var/lib/pgadmin/storage') / preprocess_username(user_email)
        storage_dir.mkdir(parents=True, exist_ok=True)
        passfile_path = storage_dir / passfile_name
        for cluster in clusters:
            secret_dir = Path('/etc/pgadmin/secrets') / cluster['secret']
            uri_key = cluster.get('uri_key', 'uri')
            uri_path = secret_dir / uri_key
            uri = ''
            if uri_path.exists():
                uri = uri_path.read_text().strip()
            if uri:
                parsed = urlparse(uri)
                host = parsed.hostname or ''
                if not host:
                    continue
                port = parsed.port or cluster.get('port', 5432)
                dbname = (parsed.path or '').lstrip('/') or 'postgres'
                username = unquote(parsed.username or '')
                sslmode = parse_qs(parsed.query).get('sslmode', ['require'])[0]
            else:
                host = cluster.get('host', '')
                if not host:
                    continue
                port = cluster.get('port', 5432)
                dbname = cluster.get('dbname', 'postgres')
                username = cluster.get('username', '')
                sslmode = cluster.get('sslmode', 'require')

            password_key = cluster.get('password_key', 'password')
            password_path = secret_dir / password_key
            if password_path.exists():
                password = password_path.read_text().strip()
                if password:
                    passfile_entries.append(f'{host}:{port}:{dbname}:{username}:{password}')

            servers[str(index)] = {
                'Name': cluster['name'],
                'Group': cluster.get('group', 'CNPG'),
                'Host': host,
                'Port': port,
                'MaintenanceDB': dbname,
                'Username': username,
                'SSLMode': sslmode,
                'PasswordExecCommand': f'cat {secret_dir}/{password_key}',
                'PasswordExecExpiration': 300,
                'ConnectionParameters': {
                    'passfile': passfile_name,
                },
            }
            index += 1

        if passfile_entries:
            passfile_path.write_text('\n'.join(passfile_entries) + '\n')
            passfile_path.chmod(0o600)

        db_path = Path('/var/lib/pgadmin/pgadmin4.db')
        if db_path.exists():
            import sqlite3
            conn = sqlite3.connect(db_path)
            cur = conn.cursor()
            user_row = cur.execute(
                'select id from user where email = ? or username = ? limit 1',
                (user_email, user_email),
            ).fetchone()
            if user_row:
                user_id = user_row[0]
                group_rows = cur.execute(
                    'select id, name from servergroup where user_id = ?',
                    (user_id,),
                ).fetchall()
                group_ids = {name: group_id for group_id, name in group_rows}

                for server in servers.values():
                    group_name = server.get('Group', 'Servers') or 'Servers'
                    group_id = group_ids.get(group_name)
                    if group_id is None:
                        cur.execute(
                            'insert into servergroup (user_id, name) values (?, ?)',
                            (user_id, group_name),
                        )
                        group_id = cur.lastrowid
                        group_ids[group_name] = group_id

                    connection_params = dict(server.get('ConnectionParameters', {}))
                    sslmode = server.get('SSLMode')
                    if sslmode:
                        connection_params['sslmode'] = sslmode
                    connection_params_json = json.dumps(connection_params)

                    server_row = cur.execute(
                        'select id from server where user_id = ? and name = ? limit 1',
                        (user_id, server['Name']),
                    ).fetchone()
                    if server_row:
                        cur.execute(
                            'update server set servergroup_id = ?, host = ?, port = ?, '
                            'maintenance_db = ?, username = ?, passexec_cmd = ?, '
                            'passexec_expiration = ?, connection_params = ? '
                            'where id = ?',
                            (
                                group_id,
                                server.get('Host'),
                                server.get('Port'),
                                server.get('MaintenanceDB'),
                                server.get('Username'),
                                server.get('PasswordExecCommand'),
                                server.get('PasswordExecExpiration'),
                                connection_params_json,
                                server_row[0],
                            ),
                        )
                    else:
                        cur.execute(
                            'insert into server (user_id, servergroup_id, name, host, port, '
                            'maintenance_db, username, passexec_cmd, passexec_expiration, connection_params) '
                            'values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)',
                            (
                                user_id,
                                group_id,
                                server['Name'],
                                server.get('Host'),
                                server.get('Port'),
                                server.get('MaintenanceDB'),
                                server.get('Username'),
                                server.get('PasswordExecCommand'),
                                server.get('PasswordExecExpiration'),
                                connection_params_json,
                            ),
                        )
            conn.commit()
            conn.close()

        output_dir = Path('/var/lib/pgadmin/servers')
        output_dir.mkdir(parents=True, exist_ok=True)
        with open(output_dir / 'servers.json', 'w', encoding='utf-8') as handle:
            json.dump({'Servers': servers}, handle, indent=2)
        PY
    volumeMounts:
      - name: pgadmin-servers
        mountPath: /var/lib/pgadmin/servers
      - name: pgadmin-data
        mountPath: /var/lib/pgadmin
      - name: cnpg-app-secrets
        mountPath: /etc/pgadmin/secrets
        readOnly: true
