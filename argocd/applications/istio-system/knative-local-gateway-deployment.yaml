apiVersion: apps/v1
kind: Deployment
metadata:
  name: knative-local-gateway
  namespace: istio-system
  labels:
    app.kubernetes.io/component: net-istio
    app.kubernetes.io/name: knative-local-gateway
    app.kubernetes.io/part-of: knative-serving
    app.kubernetes.io/version: 1.20.0
    networking.knative.dev/ingress-provider: istio
spec:
  replicas: 1
  selector:
    matchLabels:
      app: knative-local-gateway
      istio: ingressgateway
  template:
    metadata:
      annotations:
        inject.istio.io/templates: gateway
        sidecar.istio.io/inject: "true"
      labels:
        app: knative-local-gateway
        app.kubernetes.io/component: net-istio
        app.kubernetes.io/name: knative-local-gateway
        app.kubernetes.io/part-of: knative-serving
        app.kubernetes.io/version: 1.20.0
        networking.knative.dev/ingress-provider: istio
        istio: ingressgateway
        istio.io/dataplane-mode: none
    spec:
      serviceAccountName: knative-local-gateway
      terminationGracePeriodSeconds: 30
      containers:
        - name: istio-proxy
          image: docker.io/istio/proxyv2:1.28.0
          imagePullPolicy: Always
          args:
            - proxy
            - router
            - --domain
            - $(POD_NAMESPACE).svc.cluster.local
            - --proxyLogLevel=warning
            - --proxyComponentLogLevel=misc:error
            - --log_output_level=default:info
            - --serviceCluster
            - knative-local-gateway
            - --proxyAdminPort
            - "15000"
            - --controlPlaneAuthPolicy
            - NONE
            - --discoveryAddress
            - istiod.istio-system.svc.cluster.local:15012
          ports:
            - containerPort: 15090
              name: http-envoy-prom
              protocol: TCP
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: INSTANCE_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: ISTIO_META_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          resources:
            limits:
              cpu: "2"
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 128Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsGroup: 1337
            runAsNonRoot: true
            runAsUser: 1337
      securityContext:
        sysctls:
          - name: net.ipv4.ip_unprivileged_port_start
            value: "0"
