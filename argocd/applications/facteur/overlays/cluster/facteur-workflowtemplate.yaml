apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: facteur-dispatch
  namespace: argo-workflows
spec:
  serviceAccountName: facteur-workflow
  synchronization:
    semaphore:
      configMapKeyRef:
        name: argo-workflows-implementation-semaphore
        key: max-concurrency
  entrypoint: implementation
  arguments:
    parameters:
      - name: payload
        value: '{}'
  templates:
    - name: implementation
      inputs:
        parameters:
          - name: payload
      container:
        image: registry.ide-newton.ts.net/lab/codex-universal:latest
        imagePullPolicy: Always
        env:
          - name: DISCORD_BOT_TOKEN
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: bot-token
                optional: true
          - name: DISCORD_GUILD_ID
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: guild-id
                optional: true
          - name: DISCORD_CATEGORY_ID
            valueFrom:
              secretKeyRef:
                name: discord-codex-bot
                key: category-id
                optional: true
          - name: CODEX_GRAF_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: graf-api
                key: bearer-tokens
                optional: true
          - name: LGTM_LOKI_ENDPOINT
            value: http://observability-loki-loki-distributed-gateway.observability.svc.cluster.local/loki/api/v1/push
        command:
          - /usr/local/bin/codex-bootstrap
        args:
          - /bin/bash
          - -lc
          - |
            set -euo pipefail

            PAYLOAD_FILE=$(mktemp)
            cat <<'JSON' > "$PAYLOAD_FILE"
            {{inputs.parameters.payload}}
            JSON

            PROMPT=$(jq -r '.prompt // empty' "$PAYLOAD_FILE")
            if [[ -z "$PROMPT" || "$PROMPT" == "null" ]]; then
              echo "Missing Codex prompt in payload" >&2
              exit 1
            fi
            export CODEX_PROMPT="$PROMPT"

            ISSUE_REPO=$(jq -r '.repository // empty' "$PAYLOAD_FILE")
            if [[ "$ISSUE_REPO" == "null" ]]; then
              ISSUE_REPO=""
            fi
            export ISSUE_REPO

            ISSUE_NUMBER=$(jq -r '.issueNumber // empty' "$PAYLOAD_FILE")
            if [[ "$ISSUE_NUMBER" == "null" ]]; then
              ISSUE_NUMBER=""
            fi
            export ISSUE_NUMBER

            ISSUE_TITLE=$(jq -r '.title // empty' "$PAYLOAD_FILE")
            if [[ "$ISSUE_TITLE" == "null" ]]; then
              ISSUE_TITLE=""
            fi
            export ISSUE_TITLE

            RUN_ID=$(jq -r '.runId // empty' "$PAYLOAD_FILE")
            if [[ "$RUN_ID" == "null" ]]; then
              RUN_ID=""
            fi
            export CODEX_CHANNEL_RUN_ID="$RUN_ID"

            STAGE=$(jq -r '.stage // "implementation"' "$PAYLOAD_FILE")
            if [[ "$STAGE" == "null" || -z "$STAGE" ]]; then
              STAGE="implementation"
            fi
            export CODEX_STAGE="$STAGE"

            CHANNEL_DRY_RUN=$(jq -r '.discordChannelDryRun // "0"' "$PAYLOAD_FILE")
            if [[ "$CHANNEL_DRY_RUN" == "null" ]]; then
              CHANNEL_DRY_RUN="0"
            fi
            export DISCORD_CHANNEL_DRY_RUN="$CHANNEL_DRY_RUN"

            POST_TO_GITHUB=$(jq -r '.postToGithub // "false"' "$PAYLOAD_FILE" | tr '[:upper:]' '[:lower:]')
            if [[ "$POST_TO_GITHUB" == "true" || "$POST_TO_GITHUB" == "1" || "$POST_TO_GITHUB" == "yes" ]]; then
              export POST_TO_GITHUB=true
            else
              export POST_TO_GITHUB=false
            fi

            export OUTPUT_PATH="${IMPLEMENTATION_OUTPUT_PATH:-/workspace/lab/.codex-implementation.log}"
            export JSON_OUTPUT_PATH="${JSON_OUTPUT_PATH:-/workspace/lab/.codex-implementation-events.jsonl}"
            export AGENT_OUTPUT_PATH="${AGENT_OUTPUT_PATH:-/workspace/lab/.codex-implementation-agent.log}"

            AGENT_SPEC=$(mktemp)
            cat > "$AGENT_SPEC" <<JSON
            {
              "provider": "codex",
              "inputs": {
                "stage": "${CODEX_STAGE}"
              },
              "payloads": {
                "eventBodyPath": "$PAYLOAD_FILE"
              },
              "artifacts": {
                "statusPath": "/workspace/lab/.agent-status.json",
                "logPath": "/workspace/lab/.agent-runner.log"
              }
            }
            JSON

            /usr/local/bin/agent-runner --spec "$AGENT_SPEC"

            if [[ -s "$OUTPUT_PATH" ]]; then
              echo "Codex implementation output:" >&2
              cat "$OUTPUT_PATH" >&2
            fi
        resources:
          requests:
            cpu: "2"
            memory: 4Gi
          limits:
            cpu: "4"
            memory: 6Gi
      retryStrategy:
        limit: 3
        retryPolicy: OnFailure
