apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: inngest
resources:
  - postgres-cluster.yaml
  - redis.yaml
  - sealed-secret.yaml
  - tailscale-service.yaml
patches:
  - target:
      kind: Secret
      name: inngest
      namespace: inngest
    patch: |-
      $patch: delete
      apiVersion: v1
      kind: Secret
      metadata:
        name: inngest
        namespace: inngest
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: inngest
      namespace: inngest
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: inngest
        namespace: inngest
      spec:
        template:
          spec:
            containers:
              - name: inngest
                env:
                  - name: INNGEST_POSTGRES_URI
                    valueFrom:
                      secretKeyRef:
                        name: inngest-db-app
                        key: uri
                  - name: INNGEST_REDIS_URI
                    value: redis://inngest-redis:6379/0
helmCharts:
  - name: inngest
    repo: oci://ghcr.io/inngest/inngest-helm
    version: 0.3.0
    releaseName: inngest
    namespace: inngest
    includeCRDs: true
    valuesFile: ./values.yaml
