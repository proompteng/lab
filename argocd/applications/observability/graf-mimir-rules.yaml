apiVersion: v1
kind: ConfigMap
metadata:
  name: graf-mimir-rules
  namespace: observability
data:
  graf-rules.yaml: |
    groups:
      - name: graf-telemetry.rules
        rules:
          - alert: GrafHigh5xxRate
            expr: |
              sum(rate(graf_http_server_requests_count{http_status_code=~"5.."}[5m])) /
              clamp_min(sum(rate(graf_http_server_requests_count[5m])), 1) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Graf API is returning >5% 5xx responses
              description: Graf is emitting more than 5% 5xx errors over the last 5 minutes.
          - alert: GrafServiceDown
            expr: up{job="graf"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Graf service is unreachable
              description: The graf job is not reporting metrics (up metric is 0) for 5 minutes.
          - alert: GrafNoRequests
            expr: sum(rate(graf_http_server_requests_count[5m])) < 0.01
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Graf has not processed any requests
              description: The Graf HTTP counter has not incremented in the last 10 minutes.
      - name: flink.lag
        rules:
          - alert: FlinkKafkaLagHigh
            expr: max_over_time(kafka_consumer_records_lag_max{topic="flink-input"}[5m]) > 1000
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Flink consumer lag is high
              description: Kafka consumer lag on topic flink-input is over 1k for 10m.
      - name: flink.checkpoints
        rules:
          - alert: FlinkCheckpointStale
            expr: time() - max(flink_checkpoint_last_completed_timestamp{job_name="flink-kafka-roundtrip"}) > 600
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Flink checkpoints are stale
              description: No completed checkpoint for flink-kafka-roundtrip in the last 10 minutes.
      - name: flink.restarts
        rules:
          - alert: FlinkJobRestarts
            expr: increase(flink_jobmanager_job_numRestarts{job_name="flink-kafka-roundtrip"}[10m]) > 3
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Flink job restarting frequently
              description: flink-kafka-roundtrip restarted more than three times in 10 minutes.
