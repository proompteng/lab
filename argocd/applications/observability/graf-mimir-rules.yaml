apiVersion: v1
kind: ConfigMap
metadata:
  name: graf-mimir-rules
  namespace: observability
data:
  graf-rules.yaml: |
    groups:
      - name: graf-telemetry.rules
        rules:
          - alert: GrafHigh5xxRate
            expr: |
              sum(rate(graf_http_server_requests_count{http_status_code=~"5.."}[5m])) /
              clamp_min(sum(rate(graf_http_server_requests_count[5m])), 1) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Graf API is returning >5% 5xx responses
              description: Graf is emitting more than 5% 5xx errors over the last 5 minutes.
          - alert: GrafServiceDown
            expr: up{job="graf"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Graf service is unreachable
              description: The graf job is not reporting metrics (up metric is 0) for 5 minutes.
          - alert: GrafNoRequests
            expr: sum(rate(graf_http_server_requests_count[5m])) < 0.01
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Graf has not processed any requests
              description: The Graf HTTP counter has not incremented in the last 10 minutes.
      - name: codex-judge-pipeline.rules
        rules:
          - alert: CodexEventBusNoWorkflowCompletions
            expr: sum(changes({__name__=~"(nats|jetstream)_stream_last_seq", stream_name="default"}[15m])) == 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Argo Events EventBus has no workflow completion messages
              description: No new JetStream messages landed in the Argo Events default stream for 15 minutes.
          - alert: CodexEventBusJetStreamDisabled
            expr: max({__name__=~"(nats|jetstream)_server_jetstream_disabled", cluster="default"}) == 1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Argo Events EventBus JetStream is disabled
              description: JetStream reports disabled on the EventBus NATS cluster, blocking workflow completion delivery.
      - name: codex-pipeline-observability.rules
        rules:
          - alert: CodexKafkaCompletionsLagHigh
            expr: sum(kafka_consumergroup_lag_sum{consumergroup="jangar-codex-completions", topic="argo.workflows.completions"}) > 1000
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Kafka completions lag is elevated
              description: The Jangar consumer group is >1000 messages behind on argo.workflows.completions for 15 minutes.
          - alert: CodexNatsAgentCommsLagHigh
            expr: |
              max(
                jetstream_consumer_num_pending{consumer_name="jangar-agent-comms", stream_name="agent-comms"} or
                jetstream_consumer_num_pending{consumer="jangar-agent-comms", stream="agent-comms"}
              ) > 1000
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: NATS agent comms consumer lag is elevated
              description: The jangar-agent-comms JetStream consumer has >1000 pending messages for 15 minutes.
          - alert: CodexJangarAgentCommsStalled
            expr: |
              (
                sum(rate(jetstream_stream_last_seq{stream_name="agent-comms"}[10m])) or
                sum(rate(jetstream_stream_last_seq{stream="agent-comms"}[10m]))
              ) > 0
              and sum(rate(jangar_agent_comms_inserted_total[10m])) == 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar agent comms ingestion stalled
              description: Agent comms are publishing, but Jangar has not inserted any messages in 10 minutes.
          - alert: CodexJangarSseErrorRate
            expr: sum(rate(jangar_sse_errors_total[10m])) > 0.05
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar SSE error rate elevated
              description: SSE error responses exceed 0.05/sec for 10 minutes across Jangar streams.
      - name: torghut-clickhouse.guardrails.rules
        rules:
          - alert: TorghutClickHouseDiskFreeLowWarning
            expr: |
              min by (namespace, service) (
                torghut_clickhouse_guardrails_disk_free_ratio{
                  namespace="torghut",
                  service="torghut-clickhouse-guardrails-exporter"
                }
              ) < 0.15
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut ClickHouse disk free < 15%
              description: |
                Torghut ClickHouse is below 15% free disk for 10 minutes.

                First safe action: pause TA writes to stop the retry storm and prevent disk exhaustion.
                Follow-up guidance: v1/component-clickhouse-capacity-ttl-and-disk-guardrails.md.
              runbook_url: docs/torghut/design-system/v1/operations-pause-ta-writes.md
          - alert: TorghutClickHouseDiskFreeLowCritical
            expr: |
              min by (namespace, service) (
                torghut_clickhouse_guardrails_disk_free_ratio{
                  namespace="torghut",
                  service="torghut-clickhouse-guardrails-exporter"
                }
              ) < 0.08
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut ClickHouse disk free < 8%
              description: |
                Torghut ClickHouse is below 8% free disk for 5 minutes (imminent out-of-space risk).

                Stop the bleeding: immediately pause TA writes.
              runbook_url: docs/torghut/design-system/v1/operations-pause-ta-writes.md
          - alert: TorghutClickHouseReplicaReadOnly
            expr: |
              max by (namespace, service) (
                torghut_clickhouse_guardrails_any_replica_readonly{
                  namespace="torghut",
                  service="torghut-clickhouse-guardrails-exporter"
                }
              ) >= 1
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: Torghut ClickHouse replica is read-only
              description: |
                At least one Torghut ClickHouse replicated table reports read-only, which will cause TA JDBC writes to fail.

                Stop the bleeding: pause TA writes first (v1/operations-pause-ta-writes.md), then follow replica recovery
                (v1/operations-clickhouse-replica-and-keeper.md).
              runbook_url: docs/torghut/design-system/v1/operations-clickhouse-replica-and-keeper.md
          - alert: TorghutClickHouseGuardrailsExporterDown
            expr: |
              up{
                job="torghut",
                namespace="torghut",
                service="torghut-clickhouse-guardrails-exporter"
              } == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Torghut ClickHouse guardrails exporter is down
              description: Guardrails metrics are not being scraped, so disk/read-only alerts may not fire.
          - alert: TorghutClickHouseGuardrailsScrapeFailing
            expr: |
              torghut_clickhouse_guardrails_last_scrape_success{
                namespace="torghut",
                service="torghut-clickhouse-guardrails-exporter"
              } == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Torghut ClickHouse guardrails scrape failing
              description: Guardrails exporter is up but cannot query ClickHouse successfully.
      - name: torghut-ws.rules
        rules:
          - alert: TorghutWSForwarderDown
            expr: |
              up{
                job="torghut",
                namespace="torghut",
                service="torghut-ws"
              } == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut WS forwarder is down
              description: |
                torghut-ws is not being scraped (up=0) for 5 minutes. Market data will not flow into Kafka, and TA will stall.
              runbook_url: docs/torghut/design-system/v1/operations-ws-connection-limit-and-auth.md
          - alert: TorghutWSForwarderNotReady
            expr: |
              torghut_ws_readyz_status{
                namespace="torghut",
                service="torghut-ws"
              } == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut WS forwarder not ready
              description: |
                torghut-ws /readyz is failing for 5 minutes (Alpaca/Kafka gates not healthy).
              runbook_url: docs/torghut/design-system/v1/operations-ws-connection-limit-and-auth.md
          - alert: TorghutWSKafkaSendErrors
            expr: |
              rate(
                torghut_ws_kafka_send_errors_total{
                  namespace="torghut",
                  service="torghut-ws"
                }[5m]
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut WS Kafka send errors
              description: torghut-ws is reporting Kafka send errors over the last 10 minutes.
          - alert: TorghutWSKafkaSendsStalledDuringMarketHours
            expr: |
              (
                sum(
                  rate(
                    torghut_ws_kafka_send_latency_seconds_count{
                      namespace="torghut",
                      service="torghut-ws"
                    }[5m]
                  )
                ) == bool 0
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: Torghut WS is not publishing Kafka records (market hours)
              description: |
                torghut-ws has published 0 records/sec for 15 minutes during market hours (UTC schedule).

                This usually means the Alpaca WS isn't receiving events or subscriptions are broken.
              runbook_url: docs/torghut/design-system/v1/operations-ws-connection-limit-and-auth.md
      - name: torghut-ta.rules
        rules:
          - alert: TorghutTAJobmanagerDown
            expr: |
              up{
                job="torghut",
                namespace="torghut",
                service="torghut-ta"
              } == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut TA jobmanager metrics endpoint is down
              description: TA jobmanager is not being scraped (up=0) for 5 minutes.
              runbook_url: docs/torghut/design-system/v1/operations-ta-replay-and-recovery.md
          - alert: TorghutTACheckpointsStalled
            expr: |
              (
                time()
                - max(
                  flink_jobmanager_job_lastCheckpointCompletedTimestamp{
                    namespace="torghut",
                    service="torghut-ta"
                  }
                ) / 1000
              ) > 180
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: Torghut TA checkpoints appear stalled
              description: |
                Flink last checkpoint completed timestamp is older than 3 minutes for 10 minutes.
                This strongly indicates the TA job is stuck or failing to checkpoint.
              runbook_url: docs/torghut/design-system/v1/operations-ta-replay-and-recovery.md
      - name: torghut-trading.rules
        rules:
          - alert: TorghutTradingRevisionMetricsMissing
            expr: |
              absent(
                up{
                  job="torghut",
                  namespace="torghut",
                  service=~"torghut-[0-9]{5}-private"
                }
              ) == 1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut trading revision metrics missing
              description: |
                No active Knative private revision service metrics are being scraped for torghut.
                If torghut should be running, this may indicate revision readiness failures or scrape config drift.
              runbook_url: docs/torghut/design-system/v1/operations-knative-revision-failures.md
          - alert: TorghutTradingRevisionMetricsDown
            expr: |
              max(
                up{
                  job="torghut",
                  namespace="torghut",
                  service=~"torghut-[0-9]{5}-private"
                }
              ) == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut trading revision metrics endpoint is down
              description: |
                The active Knative private revision for torghut is being scraped but up=0 for 5 minutes.
              runbook_url: docs/torghut/design-system/v1/operations-knative-revision-failures.md
      - name: torghut-llm.rules
        rules:
          - alert: TorghutLLMErrorRateHigh
            expr: |
              (
                rate(torghut_llm_errors_total{namespace="torghut", service="torghut"}[10m])
                /
                clamp_min(rate(torghut_llm_requests_total{namespace="torghut", service="torghut"}[10m]), 1)
              ) > 0.1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM error rate is elevated
              description: LLM review errors exceed 10% of requests for 10 minutes.
              runbook_url: docs/torghut/design-system/v1/ai-layer-circuit-breakers-and-fallbacks.md
          - alert: TorghutLLMTokensSpike
            expr: |
              (
                rate(torghut_llm_tokens_total{namespace="torghut", service="torghut"}[5m])
                /
                clamp_min(
                  avg_over_time(rate(torghut_llm_tokens_total{namespace="torghut", service="torghut"}[5m])[1h]),
                  1
                )
              ) > 3
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM token usage spiked
              description: LLM token rate is >3x the trailing 1h baseline for 10 minutes.
              runbook_url: docs/torghut/design-system/v1/cost-model-and-budgets.md
          - alert: TorghutLLMTelemetryMissing
            expr: |
              absent(torghut_llm_requests_total{namespace="torghut", service="torghut"}) == 1
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM telemetry missing
              description: torghut LLM review metrics are not being scraped for 15 minutes.
              runbook_url: docs/torghut/design-system/v1/observability-metrics-logs-traces.md
      - name: torghut-mrm.rules
        rules:
          - alert: TorghutLLMGuardrailsExporterDown
            expr: |
              max(
                up{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }
              ) == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut LLM guardrails exporter is down
              description: LLM guardrails metrics are not being scraped (up=0) for 5 minutes.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMGuardrailsScrapeFailing
            expr: |
              torghut_llm_guardrails_last_scrape_success{
                job="torghut",
                namespace="torghut",
                service="torghut-llm-guardrails-exporter"
              } == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM guardrails scrape failing
              description: |
                The LLM guardrails exporter cannot reach /trading/metrics or /trading/status.
                Review torghut service health and network policies.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMGuardrailsBlocking
            expr: |
              increase(
                torghut_llm_guardrail_block_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[10m]
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM guardrails are blocking reviews
              description: |
                Model risk management guardrails are blocking LLM review requests.
                Check the configured evaluation evidence, inventory, and prompt version.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMParseErrorRateHigh
            expr: |
              (
                rate(
                  torghut_llm_parse_error_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[15m]
                )
                /
                rate(
                  torghut_llm_requests_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[15m]
                )
              ) > 0.05
              and
              rate(
                torghut_llm_requests_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[15m]
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM parse error rate elevated
              description: |
                LLM responses are failing JSON parsing over the last 15 minutes.
                This is a model risk incident; consider disabling LLM or tightening prompts.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMVetoRateSpike
            expr: |
              (
                rate(
                  torghut_llm_veto_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[30m]
                )
                /
                rate(
                  torghut_llm_requests_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[30m]
                )
              )
              > (
                max(
                  torghut_llm_veto_rate_baseline{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }
                ) * 1.5
              )
              and
              rate(
                torghut_llm_requests_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[30m]
              ) > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM veto rate spiked versus baseline
              description: |
                LLM veto rate is 1.5x higher than baseline. Investigate drift, prompt changes,
                or upstream signal integrity. Keep AI in shadow mode until resolved.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMCircuitOpened
            expr: |
              increase(
                torghut_llm_circuit_open_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[10m]
              ) > 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM circuit breaker opened recently
              description: Circuit breaker events indicate repeated LLM failures or timeouts in the last 10 minutes.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMCircuitOpenTooLong
            expr: |
              max(
                torghut_llm_circuit_open_seconds{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }
              ) > 600
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut LLM circuit stuck open
              description: |
                The LLM circuit breaker has remained open for longer than 10 minutes.
                Keep deterministic-only behavior and investigate upstream LLM failures.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
          - alert: TorghutLLMFailModeOverridesSpike
            expr: |
              increase(
                torghut_llm_fail_mode_override_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[15m]
              ) > 5
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM fail-mode overrides are frequent
              description: |
                Stage controls are repeatedly overriding configured fail mode.
                Verify rollout stage and live/paper configuration consistency.
              runbook_url: docs/torghut/design-system/v3/full-loop/15-llm-advisory-rollout-spec.md
          - alert: TorghutLLMTokenBudgetExceeded
            expr: |
              (
                increase(
                  torghut_llm_tokens_prompt_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[30m]
                )
                +
                increase(
                  torghut_llm_tokens_completion_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut-llm-guardrails-exporter"
                  }[30m]
                )
              )
              /
              increase(
                torghut_llm_requests_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[30m]
              )
              > max(
                torghut_llm_tokens_per_request_budget{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }
              )
              and
              increase(
                torghut_llm_requests_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut-llm-guardrails-exporter"
                }[30m]
              ) > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM token budget exceeded
              description: |
                Average LLM tokens per request are above the configured budget.
                Consider shortening prompts or lowering max tokens.
              runbook_url: docs/torghut/design-system/v1/ai-layer-model-risk-management.md
      - name: torghut-freshness.rules
        rules:
          - alert: TorghutSignalsStaleDuringMarketHours
            expr: |
              (
                time()
                - max(
                  torghut_clickhouse_guardrails_ta_signals_max_event_ts_seconds{
                    namespace="torghut",
                    service="torghut-clickhouse-guardrails-exporter"
                  }
                )
              ) > bool 900
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: Torghut signals are stale (market hours)
              description: |
                ClickHouse ta_signals max(event_ts) is older than 15 minutes during market hours (UTC schedule).

                First checks:
                - torghut-ws readiness and Kafka publishing
                - torghut-ta checkpointing and ClickHouse JDBC sink health
              runbook_url: docs/torghut/design-system/v1/operations-ta-replay-and-recovery.md
          - alert: TorghutMicrobarsStaleDuringMarketHours
            expr: |
              (
                time()
                - max(
                  torghut_clickhouse_guardrails_ta_microbars_max_window_end_seconds{
                    namespace="torghut",
                    service="torghut-clickhouse-guardrails-exporter"
                  }
                )
              ) > bool 300
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut microbars are stale (market hours)
              description: |
                ClickHouse ta_microbars max(window_end) is older than 5 minutes during market hours (UTC schedule).
              runbook_url: docs/torghut/design-system/v1/operations-ta-replay-and-recovery.md
      - name: torghut-quant-control-plane.rules
        rules:
          - alert: TorghutQuantDecisionsStalledDuringMarketHours
            expr: |
              (
                sum(
                  rate(
                    torghut_trading_decisions_total{
                      job="torghut",
                      namespace="torghut",
                      service="torghut"
                    }[5m]
                  )
                ) == bool 0
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Torghut trading decisions stalled (market hours)
              description: |
                No Torghut trading decisions have been recorded for 15 minutes during market hours (UTC schedule).
                This stalls quant control-plane snapshots and freshness.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutAutonomyNoSignalStreakDuringMarketHours
            expr: |
              (
                increase(
                  torghut_trading_no_signal_windows_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut"
                  }[10m]
                ) >= 2
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut autonomy no-signal streak (market hours)
              description: |
                Autonomy ingest returned empty windows for consecutive cycles for 10 minutes in market hours.
                Check TA signal chain health, Jangar symbol feed, and autonomy cursor state.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutAutonomyCursorAheadOfStreamDuringMarketHours
            expr: |
              (
                increase(
                  torghut_trading_no_signal_reason_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut",
                    reason="cursor_ahead_of_stream"
                  }[10m]
                ) >= 2
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 10m
            labels:
              severity: critical
            annotations:
              summary: Torghut autonomy cursor is ahead of stream (market hours)
              description: |
                Autonomy ingest reports repeated cursor_ahead_of_stream for 10 minutes during market hours.
                This indicates the TA pipeline is not advancing or ingestion is behind.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutSignalStalenessAlertsSustainedDuringMarketHours
            expr: |
              (
                increase(
                  torghut_trading_signal_staleness_alert_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut"
                  }[15m]
                ) >= 3
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut signal staleness alerts sustained (market hours)
              description: |
                Torghut emitted at least 3 signal freshness/continuity alerts in the last 15 minutes during market hours.
                Validate stream restart recovery and ta_signals cursor continuity before scaling execution.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutLeanFallbackRateElevated
            expr: |
              (
                rate(
                  torghut_trading_execution_fallback_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut",
                    from="lean",
                    to="alpaca"
                  }[15m]
                )
                /
                clamp_min(
                  rate(
                    torghut_trading_execution_requests_total{
                      job="torghut",
                      namespace="torghut",
                      service="torghut",
                      adapter="lean"
                    }[15m]
                  ),
                  0.001
                )
              ) > 0.15
              and
              rate(
                torghut_trading_execution_requests_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut",
                  adapter="lean"
                }[15m]
              ) > 0.01
            for: 15m
            labels:
              severity: critical
            annotations:
              summary: Torghut LEAN route fallback rate elevated
              description: |
                LEAN to Alpaca fallback transitions exceeded 15% of LEAN execution requests for 15 minutes.
                Route provenance continuity is degraded; keep fallback policy enabled and investigate LEAN runner stability.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutEvidenceContinuityFailuresDetected
            expr: |
              increase(
                torghut_trading_evidence_continuity_failures_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut"
                }[2h]
              ) > 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut evidence continuity check failed
              description: |
                Latest autonomy evidence reconciliation found missing research ledger rows
                across research_candidates/fold_metrics/stress_metrics/promotions.
                Halt promotions until artifact continuity is restored.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutQuantOrderRejectionRateHigh
            expr: |
              (
                rate(
                  torghut_trading_orders_rejected_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut"
                  }[15m]
                )
                /
                clamp_min(
                  rate(
                    torghut_trading_orders_submitted_total{
                      job="torghut",
                      namespace="torghut",
                      service="torghut"
                    }[15m]
                  ),
                  1
                )
              ) > 0.2
              and
              rate(
                torghut_trading_orders_submitted_total{
                  job="torghut",
                  namespace="torghut",
                  service="torghut"
                }[15m]
              ) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut order rejection rate elevated
              description: |
                Rejected orders exceed 20% of submitted orders for 10 minutes. This impacts execution quality
                and will degrade quant control-plane performance metrics.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: TorghutQuantLLMErrorRateHigh
            expr: |
              (
                rate(
                  torghut_trading_llm_error_total{
                    job="torghut",
                    namespace="torghut",
                    service="torghut"
                  }[15m]
                )
                /
                clamp_min(
                  rate(
                    torghut_trading_llm_requests_total{
                      job="torghut",
                      namespace="torghut",
                      service="torghut"
                    }[15m]
                  ),
                  1
                )
              ) > 0.1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Torghut LLM error rate elevated (trading metrics)
              description: |
                LLM errors exceed 10% of trading review requests for 10 minutes. Consider forcing LLM shadow-only
                to keep control-plane metrics stable while investigating.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: JangarQuantControlPlaneStreamErrors
            expr: |
              sum(rate(jangar_sse_errors_total{stream="torghut-quant"}[10m])) > 0.05
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar control-plane SSE errors elevated
              description: |
                Control-plane SSE errors exceed 0.05/sec for 10 minutes. Quant dashboards may show stale data
                or disconnects even if the pipeline is healthy.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: JangarTorghutQuantFramesMissingDuringMarketHours
            expr: |
              (
                sum(increase(jangar_torghut_quant_frames_total{window="1d"}[2m])) == bool 0
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Jangar torghut quant control-plane frames missing (market hours)
              description: |
                No new quant metric frames were computed for 5 minutes during market hours (UTC schedule).
                Dashboards will show stale data; investigate Jangar Torghut DB connectivity and runtime health.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: JangarTorghutQuantComputeErrors
            expr: |
              sum(increase(jangar_torghut_quant_compute_errors_total[10m])) > 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar torghut quant compute errors detected
              description: |
                The quant control-plane compute loop is encountering errors. This may stall updates or drop windows.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
          - alert: JangarTorghutQuantStaleFramesDuringMarketHours
            expr: |
              (
                sum(increase(jangar_torghut_quant_stale_frames_total{window="1d"}[5m])) > 0
              )
              * on() group_left()
              (
                (day_of_week(vector(time())) >= bool 1)
                * (day_of_week(vector(time())) <= bool 5)
                * (hour(vector(time())) >= bool 14)
                * (hour(vector(time())) < bool 21)
              )
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar torghut quant frames are stale (market hours)
              description: |
                Quant frames are being computed but are stale according to the configured max staleness threshold.
                This typically indicates upstream Torghut decisions/executions are not updating.
              runbook_url: docs/runbooks/torghut-quant-control-plane.md
