apiVersion: v1
kind: ConfigMap
metadata:
  name: graf-mimir-rules
  namespace: observability
data:
  graf-rules.yaml: |
    groups:
      - name: graf-telemetry.rules
        rules:
          - alert: GrafHigh5xxRate
            expr: |
              sum(rate(graf_http_server_requests_count{http_status_code=~"5.."}[5m])) /
              clamp_min(sum(rate(graf_http_server_requests_count[5m])), 1) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: Graf API is returning >5% 5xx responses
              description: Graf is emitting more than 5% 5xx errors over the last 5 minutes.
          - alert: GrafServiceDown
            expr: up{job="graf"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Graf service is unreachable
              description: The graf job is not reporting metrics (up metric is 0) for 5 minutes.
          - alert: GrafNoRequests
            expr: sum(rate(graf_http_server_requests_count[5m])) < 0.01
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Graf has not processed any requests
              description: The Graf HTTP counter has not incremented in the last 10 minutes.
      - name: codex-judge-pipeline.rules
        rules:
          - alert: CodexEventBusNoWorkflowCompletions
            expr: sum(changes({__name__=~"(nats|jetstream)_stream_last_seq", stream_name="default"}[15m])) == 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Argo Events EventBus has no workflow completion messages
              description: No new JetStream messages landed in the Argo Events default stream for 15 minutes.
          - alert: CodexEventBusJetStreamDisabled
            expr: max({__name__=~"(nats|jetstream)_server_jetstream_disabled", cluster="default"}) == 1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Argo Events EventBus JetStream is disabled
              description: JetStream reports disabled on the EventBus NATS cluster, blocking workflow completion delivery.
      - name: codex-pipeline-observability.rules
        rules:
          - alert: CodexKafkaCompletionsLagHigh
            expr: sum(kafka_consumergroup_lag_sum{consumergroup="jangar-codex-completions", topic="argo.workflows.completions"}) > 1000
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Kafka completions lag is elevated
              description: The Jangar consumer group is >1000 messages behind on argo.workflows.completions for 15 minutes.
          - alert: CodexNatsAgentCommsLagHigh
            expr: |
              max(
                jetstream_consumer_num_pending{consumer_name="jangar-agent-comms", stream_name="agent-comms"} or
                jetstream_consumer_num_pending{consumer="jangar-agent-comms", stream="agent-comms"}
              ) > 1000
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: NATS agent comms consumer lag is elevated
              description: The jangar-agent-comms JetStream consumer has >1000 pending messages for 15 minutes.
          - alert: CodexJangarAgentCommsStalled
            expr: |
              (
                sum(rate(jetstream_stream_last_seq{stream_name="agent-comms"}[10m])) or
                sum(rate(jetstream_stream_last_seq{stream="agent-comms"}[10m]))
              ) > 0
              and sum(rate(jangar_agent_comms_inserted_total[10m])) == 0
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar agent comms ingestion stalled
              description: Agent comms are publishing, but Jangar has not inserted any messages in 10 minutes.
          - alert: CodexJangarSseErrorRate
            expr: sum(rate(jangar_sse_errors_total[10m])) > 0.05
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: Jangar SSE error rate elevated
              description: SSE error responses exceed 0.05/sec for 10 minutes across Jangar streams.
      - name: torghut-clickhouse.guardrails
        rules:
          - alert: TorghutClickHouseDiskFreeLow
            expr: |
              (
                kubelet_volume_stats_available_bytes{namespace="torghut", persistentvolumeclaim=~"chi-data-torghut-clickhouse.*"}
                /
                clamp_min(
                  kubelet_volume_stats_capacity_bytes{namespace="torghut", persistentvolumeclaim=~"chi-data-torghut-clickhouse.*"},
                  1
                )
              ) < 0.15
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Torghut ClickHouse PVC free space < 15%
              description: |
                ClickHouse PVC free space is below 15% for 15m. This commonly causes Flink TA JDBC sink failures and can
                cascade into stale TA signals.

                Safe immediate action: pause TA writes (suspend FlinkDeployment/torghut-ta) to stop write pressure, then
                reclaim disk / wait for TTL merges. Do not change trading safety gates.
              runbook_url: docs/torghut/design-system/v1/operations-pause-ta-writes.md
          - alert: TorghutClickHouseDiskFreeCritical
            expr: |
              (
                kubelet_volume_stats_available_bytes{namespace="torghut", persistentvolumeclaim=~"chi-data-torghut-clickhouse.*"}
                /
                clamp_min(
                  kubelet_volume_stats_capacity_bytes{namespace="torghut", persistentvolumeclaim=~"chi-data-torghut-clickhouse.*"},
                  1
                )
              ) < 0.05
              or kubelet_volume_stats_available_bytes{namespace="torghut", persistentvolumeclaim=~"chi-data-torghut-clickhouse.*"} < 2 * 1024 * 1024 * 1024
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut ClickHouse PVC free space critically low
              description: |
                ClickHouse PVC free space is critically low (<5% or <2Gi) for 5m. Writes may fail imminently or already
                be failing.

                Stop the bleeding: pause TA writes (suspend FlinkDeployment/torghut-ta), then remediate disk pressure.
                Keep live trading gated/paper-by-default.
              runbook_url: docs/torghut/design-system/v1/operations-pause-ta-writes.md
          - alert: TorghutClickHouseReplicaReadOnly
            expr: |
              max by (namespace, service) (
                (
                  ClickHouse_AsyncMetrics_ReadonlyReplica{job="torghut", namespace="torghut", service="torghut-clickhouse"} or
                  clickhouse_asynchronous_metrics_readonly_replica{job="torghut", namespace="torghut", service="torghut-clickhouse"} or
                  clickhouse_metrics_readonly_replica{job="torghut", namespace="torghut", service="torghut-clickhouse"}
                )
              ) > 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: Torghut ClickHouse replica is read-only
              description: |
                ClickHouse reports one or more replicas are read-only. This blocks TA JDBC writes and usually indicates
                Keeper metadata or storage pressure issues.

                Recommended first action: pause TA writes to avoid retry storms, then follow the replica/keeper recovery
                procedure (SYSTEM RESTORE REPLICA) once the underlying issue is fixed.
              runbook_url: docs/torghut/design-system/v1/operations-clickhouse-replica-and-keeper.md
