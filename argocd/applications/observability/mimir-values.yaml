global:
  extraEnv:
    - name: MIMIR_S3_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: observability-minio-credentials
          key: mimirAccessKey
    - name: MIMIR_S3_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: observability-minio-credentials
          key: mimirSecretKey

mimir:
  structuredConfig:
    limits:
      ingestion_rate: 20000
      ingestion_burst_size: 400000
    blocks_storage:
      backend: s3
      bucket_store:
        sync_dir: /data/tsdb-sync
      s3:
        endpoint: observability-minio.minio.svc.cluster.local:9000
        bucket_name: mimir-blocks
        access_key_id: ${MIMIR_S3_ACCESS_KEY_ID}
        secret_access_key: ${MIMIR_S3_SECRET_ACCESS_KEY}
        insecure: true
        bucket_lookup_type: path
    alertmanager_storage:
      backend: s3
      s3:
        endpoint: observability-minio.minio.svc.cluster.local:9000
        bucket_name: mimir-alertmanager
        access_key_id: ${MIMIR_S3_ACCESS_KEY_ID}
        secret_access_key: ${MIMIR_S3_SECRET_ACCESS_KEY}
        insecure: true
        bucket_lookup_type: path
    ruler_storage:
      backend: local
      local:
        directory: /etc/mimir/rules
    ruler:
      # Must not overlap ruler_storage.local.directory.
      # /etc/mimir/rules is used as the read-only rule store (local backend),
      # while /data/ruler is the writable working directory used by the ruler.
      rule_path: /data/ruler
    usage_stats:
      enabled: false
      installation_mode: helm
  runtimeConfig:
    overrides:
      anonymous:
        ingestion_rate: 20000
        ingestion_burst_size: 400000

rollout_operator:
  enabled: false

admin_api:
  replicas: 1

distributor:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi

ingester:
  replicas: 3
  zoneAwareReplication:
    enabled: false
  persistentVolume:
    enabled: true
    size: 20Gi
    storageClass: rook-ceph-block

querier:
  replicas: 1

query_frontend:
  replicas: 1

query_scheduler:
  replicas: 1

ruler:
  replicas: 1
  # mimir-distributed chart uses `initContainers` (not `extraInitContainers`).
  initContainers:
    - name: copy-graf-rules
      image: docker.io/library/busybox:1.36
      imagePullPolicy: IfNotPresent
      command:
        - /bin/sh
        - -c
        - |
          set -eu
          rm -rf /etc/mimir/rules/*
          mkdir -p /etc/mimir/rules/anonymous
          # ConfigMap mounts use symlinks + timestamped dirs (..data/..2026_...).
          # Copy dereferenced files into the tenant directory without trying to preserve ownership.
          for f in /etc/mimir/rules-src/*.yml /etc/mimir/rules-src/*.yaml; do
            if [ -f "$f" ]; then
              cp -Lf "$f" /etc/mimir/rules/anonymous/
            fi
          done
  extraVolumes:
    - name: graf-mimir-rules
      configMap:
        name: graf-mimir-rules
    - name: graf-mimir-rules-writable
      emptyDir: {}
  extraVolumeMounts:
    - name: graf-mimir-rules
      mountPath: /etc/mimir/rules-src
      readOnly: true
    - name: graf-mimir-rules-writable
      mountPath: /etc/mimir/rules

store_gateway:
  replicas: 1
  zoneAwareReplication:
    enabled: false
  persistentVolume:
    enabled: true
    size: 20Gi
    storageClass: rook-ceph-block

compactor:
  replicas: 1
  persistentVolume:
    enabled: true
    size: 20Gi
    storageClass: rook-ceph-block

alertmanager:
  replicas: 1
  zoneAwareReplication:
    enabled: false
  persistence:
    enabled: true
    storageClass: rook-ceph-block
    size: 5Gi

minio:
  enabled: false

metaMonitoring:
  dashboards:
    enabled: false
