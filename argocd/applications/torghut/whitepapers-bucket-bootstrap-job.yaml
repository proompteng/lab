apiVersion: batch/v1
kind: Job
metadata:
  name: torghut-whitepapers-bootstrap
  namespace: torghut
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation,HookSucceeded
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: bootstrap
          image: quay.io/minio/mc:RELEASE.2025-02-21T16-00-46Z
          imagePullPolicy: IfNotPresent
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: torghut-whitepapers
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: torghut-whitepapers
                  key: AWS_SECRET_ACCESS_KEY
            - name: BUCKET_NAME
              valueFrom:
                configMapKeyRef:
                  name: torghut-whitepapers
                  key: BUCKET_NAME
            - name: BUCKET_HOST
              valueFrom:
                configMapKeyRef:
                  name: torghut-whitepapers
                  key: BUCKET_HOST
            - name: BUCKET_PORT
              valueFrom:
                configMapKeyRef:
                  name: torghut-whitepapers
                  key: BUCKET_PORT
            - name: HOME
              value: /tmp
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          command:
            - /bin/sh
            - -ec
            - |
              mc alias set ceph "http://${BUCKET_HOST}:${BUCKET_PORT}" "${AWS_ACCESS_KEY_ID}" "${AWS_SECRET_ACCESS_KEY}"
              mc stat "ceph/${BUCKET_NAME}" >/dev/null 2>&1 || mc mb "ceph/${BUCKET_NAME}"

              for prefix in \
                "raw/github" \
                "raw/arxiv" \
                "raw/ssrn" \
                "normalized/pdf" \
                "extracted/text" \
                "extracted/sections" \
                "metadata/documents" \
                "metadata/processing" \
                "synthesis" \
                "verdicts" \
                "design-prs" \
                "index/manifests" \
                "ops/failed" \
                "ops/quarantine"; do
                printf "" | mc pipe "ceph/${BUCKET_NAME}/${prefix}/.keep"
              done
