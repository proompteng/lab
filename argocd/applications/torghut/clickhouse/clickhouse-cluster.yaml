apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: torghut-clickhouse
  namespace: torghut
  labels:
    app.kubernetes.io/name: torghut-clickhouse
    app.kubernetes.io/part-of: torghut
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  configuration:
    files:
      config.d/99-prometheus.xml: |-
        <yandex>
          <prometheus>
            <endpoint>/metrics</endpoint>
            <port>9363</port>
            <metrics>true</metrics>
            <events>true</events>
            <asynchronous_metrics>true</asynchronous_metrics>
          </prometheus>
        </yandex>
      config.d/99-logging-overrides.xml: |-
        <yandex>
          <logger>
            <level>information</level>
          </logger>
          <!-- Keep system tables from growing without bound on small PVCs. -->
          <trace_log remove="1"/>
        </yandex>
      users.d/99-profile-overrides.xml: |-
        <yandex>
          <profiles>
            <default>
              <!-- Disable sampling profiler logs to keep system tables small. -->
              <query_profiler_real_time_period_ns>0</query_profiler_real_time_period_ns>
              <query_profiler_cpu_time_period_ns>0</query_profiler_cpu_time_period_ns>
              <log_profile_events>0</log_profile_events>
            </default>
          </profiles>
        </yandex>
    zookeeper:
      nodes:
        - host: keeper-torghut-keeper
          port: 2181
    users:
      default/password_sha256_hex:
        valueFrom:
          secretKeyRef:
            name: torghut-clickhouse-auth
            key: default_password_sha256_hex
      default/networks/ip:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
      torghut/password:
        valueFrom:
          secretKeyRef:
            name: torghut-clickhouse-auth
            key: torghut_password
      torghut/profile: default
      torghut/quota: default
      torghut/networks/ip:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    clusters:
      - name: default
        layout:
          shardsCount: 1
          replicasCount: 2
        templates:
          podTemplate: chi-default
          volumeClaimTemplate: chi-data
  templates:
    podTemplates:
      - name: chi-default
        spec:
          nodeSelector:
            kubernetes.io/arch: arm64
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: clickhouse.altinity.com/cluster
                        operator: In
                        values:
                          - default
                  topologyKey: kubernetes.io/hostname
          containers:
            - name: clickhouse
              image: altinity/clickhouse-server:25.3.6.10034.altinitystable
              resources:
                requests:
                  cpu: 1
                  memory: 2Gi
                limits:
                  cpu: 2
                  memory: 4Gi
    volumeClaimTemplates:
      - name: chi-data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 50Gi
          storageClassName: longhorn
  defaults:
    templates:
      podTemplate: chi-default
      volumeClaimTemplate: chi-data
