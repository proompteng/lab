apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: torghut-clickhouse
  namespace: torghut
  labels:
    app.kubernetes.io/name: torghut-clickhouse
    app.kubernetes.io/part-of: torghut
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  configuration:
    files:
      config.d/zz-logger.xml: |
        <yandex>
          <logger replace="1">
            <level>warning</level>
            <log>/var/log/clickhouse-server/clickhouse-server.log</log>
            <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
            <size>1000M</size>
            <count>10</count>
            <console>1</console>
          </logger>
        </yandex>
      config.d/zz-system-logs.xml: |
        <yandex>
          <text_log replace="1">
            <database>system</database>
            <table>text_log</table>
            <flush_interval_milliseconds>60000</flush_interval_milliseconds>
            <level>warning</level>
          </text_log>
          <metric_log replace="1">
            <database>system</database>
            <table>metric_log</table>
            <flush_interval_milliseconds>60000</flush_interval_milliseconds>
            <collect_interval_milliseconds>60000</collect_interval_milliseconds>
          </metric_log>
          <asynchronous_metric_log replace="1">
            <database>system</database>
            <table>asynchronous_metric_log</table>
            <flush_interval_milliseconds>60000</flush_interval_milliseconds>
          </asynchronous_metric_log>
          <trace_log remove="1"/>
          <latency_log remove="1"/>
          <query_metric_log remove="1"/>
        </yandex>
      users.d/zz-profile-logging.xml: |
        <yandex>
          <profiles>
            <default>
              <query_profiler_real_time_period_ns>0</query_profiler_real_time_period_ns>
              <query_profiler_cpu_time_period_ns>0</query_profiler_cpu_time_period_ns>
              <log_profile_events>0</log_profile_events>
              <log_processors_profiles>0</log_processors_profiles>
            </default>
          </profiles>
        </yandex>
    zookeeper:
      nodes:
        - host: keeper-torghut-keeper
          port: 2181
    users:
      default/password_sha256_hex:
        valueFrom:
          secretKeyRef:
            name: torghut-clickhouse-auth
            key: default_password_sha256_hex
      default/networks/ip:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
      torghut/password:
        valueFrom:
          secretKeyRef:
            name: torghut-clickhouse-auth
            key: torghut_password
      torghut/profile: default
      torghut/quota: default
      torghut/networks/ip:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
    clusters:
      - name: default
        layout:
          shardsCount: 1
          replicasCount: 2
        templates:
          podTemplate: chi-default
          volumeClaimTemplate: chi-data
  templates:
    podTemplates:
      - name: chi-default
        spec:
          nodeSelector:
            kubernetes.io/arch: arm64
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchExpressions:
                      - key: clickhouse.altinity.com/cluster
                        operator: In
                        values:
                          - default
                  topologyKey: kubernetes.io/hostname
          containers:
            - name: clickhouse
              image: altinity/clickhouse-server:25.3.6.10034.altinitystable
              resources:
                requests:
                  cpu: 1
                  memory: 2Gi
                limits:
                  cpu: 2
                  memory: 4Gi
    volumeClaimTemplates:
      - name: chi-data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: longhorn
  defaults:
    templates:
      podTemplate: chi-default
      volumeClaimTemplate: chi-data
