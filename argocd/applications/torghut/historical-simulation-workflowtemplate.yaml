apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: torghut-historical-simulation
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: torghut
spec:
  serviceAccountName: codex-workflow
  entrypoint: run
  arguments:
    parameters:
      - name: runId
        value: ''
      - name: mode
        value: 'plan'
      - name: datasetManifestB64
        value: ''
      - name: confirmPhrase
        value: 'START_HISTORICAL_SIMULATION'
      - name: forceReplay
        value: 'false'
      - name: forceDump
        value: 'false'
      - name: allowMissingState
        value: 'false'
      - name: outputRoot
        value: /tmp/torghut-simulations
      - name: gitRepo
        value: https://github.com/proompteng/lab.git
      - name: gitRef
        value: main
  templates:
    - name: run
      inputs:
        parameters:
          - name: runId
          - name: mode
          - name: datasetManifestB64
          - name: confirmPhrase
          - name: forceReplay
          - name: forceDump
          - name: allowMissingState
          - name: outputRoot
          - name: gitRepo
          - name: gitRef
      container:
        image: python:3.11-slim
        command:
          - /bin/bash
          - -lc
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 2
            memory: 4Gi
        args:
          - |
            set -euo pipefail

            WORK_ROOT=/workspace/lab
            WORKFLOW_DIR=/tmp/torghut-historical-simulation
            MANIFEST_PATH="${WORKFLOW_DIR}/dataset-manifest.yaml"
            OUTPUT_ROOT="{{inputs.parameters.outputRoot}}"

            if command -v apt-get >/dev/null 2>&1; then
              apt-get update
              apt-get install -y --no-install-recommends git curl ca-certificates
              rm -rf /var/lib/apt/lists/*
            fi

            pip install --no-cache-dir --upgrade pip
            pip install --no-cache-dir kafka-python "psycopg[binary]" pyyaml alembic

            if [ ! -f /usr/local/bin/kubectl ]; then
              K8S_STABLE="$(curl -fsSL https://dl.k8s.io/release/stable.txt | tr -d '[:space:]')"
              if [ -z "$K8S_STABLE" ]; then
                K8S_STABLE="v1.30.0"
              fi
              curl -fsSL "https://dl.k8s.io/release/${K8S_STABLE}/bin/linux/amd64/kubectl" -o /usr/local/bin/kubectl
              chmod +x /usr/local/bin/kubectl
            fi

            if ! command -v git >/dev/null 2>&1; then
              echo "git is required to fetch services/torghut/scripts/start_historical_simulation.py" >&2
              exit 1
            fi

            mkdir -p "${WORKFLOW_DIR}"
            if [ -d "${WORK_ROOT}/.git" ]; then
              git -C "${WORK_ROOT}" fetch --depth 1 origin "{{inputs.parameters.gitRef}}"
              git -C "${WORK_ROOT}" reset --hard "origin/{{inputs.parameters.gitRef}}"
            else
              rm -rf "${WORK_ROOT}"
              git clone --depth 1 --branch "{{inputs.parameters.gitRef}}" "{{inputs.parameters.gitRepo}}" "${WORK_ROOT}"
            fi

            if [ -z "{{inputs.parameters.datasetManifestB64}}" ]; then
              echo "datasetManifestB64 must be supplied" >&2
              exit 1
            fi

            printf '%s' "{{inputs.parameters.datasetManifestB64}}" | base64 -d > "${MANIFEST_PATH}"
            python3 - <<'PY'
            import os
            import yaml

            manifest_path = os.environ["MANIFEST_PATH"]
            output_root = os.environ["OUTPUT_ROOT"]

            with open(manifest_path, encoding='utf-8') as handle:
                payload = yaml.safe_load(handle) or {}
            if not isinstance(payload, dict):
                raise RuntimeError("manifest must be a YAML mapping")

            runtime = payload.get("runtime")
            if not isinstance(runtime, dict):
                runtime = {}
            runtime["output_root"] = output_root
            payload["runtime"] = runtime

            with open(manifest_path, 'w', encoding='utf-8') as handle:
                yaml.safe_dump(payload, handle, default_flow_style=False, sort_keys=False)
            PY

            chmod +x "${WORK_ROOT}/services/torghut/scripts/start_historical_simulation.py"
            RUN_ID='{{inputs.parameters.runId}}'
            MODE='{{inputs.parameters.mode}}'
            if [ -z "$RUN_ID" ]; then
              RUN_ID="$(date -u +%Y%m%dT%H%M%SZ)"
            fi

            case "$MODE" in
              plan|apply|teardown) ;;
              *)
                echo "invalid mode: $MODE" >&2
                exit 1
                ;;
            esac

            SCRIPT_ARGS=(--mode "$MODE" --run-id "$RUN_ID" --dataset-manifest "$MANIFEST_PATH" --json)
            if [ "$MODE" = "apply" ]; then
              SCRIPT_ARGS+=(--confirm '{{inputs.parameters.confirmPhrase}}')
            fi
            if [ '{{inputs.parameters.forceReplay}}' = 'true' ]; then
              SCRIPT_ARGS+=(--force-replay)
            fi
            if [ '{{inputs.parameters.forceDump}}' = 'true' ]; then
              SCRIPT_ARGS+=(--force-dump)
            fi
            if [ '{{inputs.parameters.allowMissingState}}' = 'true' ]; then
              SCRIPT_ARGS+=(--allow-missing-state)
            fi

            mkdir -p "$OUTPUT_ROOT"
            python3 "${WORK_ROOT}/services/torghut/scripts/start_historical_simulation.py" "${SCRIPT_ARGS[@]}"
        outputs:
          artifacts:
            - name: simulation-output
              path: /tmp/torghut-simulations
