apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  name: torghut-ta
  namespace: torghut
  labels:
    app: torghut-ta
spec:
  image: registry.ide-newton.ts.net/lab/torghut-ta@sha256:912efed85e3950f5c119e0865dbbcceede7e2e0b15cf5a937f2cbeca36c53c08
  imagePullPolicy: IfNotPresent
  flinkVersion: v2_0
  serviceAccount: torghut-runtime
  flinkConfiguration:
    state.checkpoints.dir: s3a://flink-checkpoints/torghut/technical-analysis/checkpoints
    state.savepoints.dir: s3a://flink-checkpoints/torghut/technical-analysis/savepoints
    taskmanager.numberOfTaskSlots: "8"
    restart-strategy.type: fixed-delay
    restart-strategy.fixed-delay.attempts: "5"
    restart-strategy.fixed-delay.delay: 5 s
    execution.checkpointing.unaligned: "true"
    metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prom.port: "9249"
    fs.s3a.endpoint: http://observability-minio.minio.svc.cluster.local:9000
    fs.s3a.connection.ssl.enabled: "false"
    fs.s3a.path.style.access: "true"
  podTemplate:
    apiVersion: v1
    kind: Pod
    metadata:
      labels:
        app: torghut-ta
    spec:
      serviceAccountName: torghut-runtime
      containers:
        - name: flink-main-container
          envFrom:
            - configMapRef:
                name: torghut-ta-config
          env:
            - name: TA_KAFKA_DELIVERY_GUARANTEE
              value: AT_LEAST_ONCE
            - name: TA_KAFKA_USERNAME
              value: torghut-ws
            - name: TA_KAFKA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: torghut-ws
                  key: password
            - name: TA_S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: accesskey
            - name: TA_S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: secretkey
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: accesskey
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: secretkey
            - name: AWS_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: accesskey
            - name: AWS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: observability-minio-creds
                  key: secretkey
            - name: TORGHUT_TA_VERSION
              value: v0.355.0-11-gc87e3a2f
            - name: TORGHUT_TA_COMMIT
              value: c87e3a2fba15d7adbdc2cf8c362262cf1ece9746
          ports:
            - containerPort: 9249
              name: metrics
  jobManager:
    resource:
      cpu: 0.5
      memory: 2048m
    podTemplate:
      metadata:
        labels:
          app: torghut-ta
    replicas: 1
  taskManager:
    resource:
      cpu: 1
      memory: 3072m
    podTemplate:
      metadata:
        labels:
          app: torghut-ta
    replicas: 3
  job:
    entryClass: ai.proompteng.dorvud.ta.flink.FlinkTechnicalAnalysisJobKt
    jarURI: local:///opt/flink/usrlib/app.jar
    parallelism: 8
    upgradeMode: stateless
    state: running
