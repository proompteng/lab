apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: codex-research-workflow
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: graf
spec:
  serviceAccountName: codex-workflow
  entrypoint: codex-research
  arguments:
    parameters:
      - name: prompt
        value: ""
      - name: artifactKey
        value: ""
      - name: artifactBucket
        value: argo-workflows
      - name: artifactEndpoint
        value: observability-minio.minio.svc.cluster.local:9000
      - name: artifactRegion
        value: ""
      - name: metadata
        value: "{}"
  templates:
    - name: codex-research
      inputs:
        parameters:
          - name: prompt
          - name: artifactKey
          - name: artifactBucket
          - name: artifactEndpoint
          - name: artifactRegion
          - name: metadata
      container:
        image: registry.ide-newton.ts.net/lab/codex-universal:latest
        imagePullPolicy: Always
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-token
                key: token
          - name: CODEX_GRAF_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: graf-api
                key: bearer-tokens
                optional: true
          - name: CODEX_GRAF_BASE_URL
            value: "http://graf.graf.svc.cluster.local"
          - name: NATS_URL
            value: nats://nats.nats.svc.cluster.local:4222
          - name: NATS_USER
            valueFrom:
              secretKeyRef:
                name: nats-agents-credentials
                key: username
          - name: NATS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nats-agents-credentials
                key: password
          - name: NATS_CREDS
            valueFrom:
              secretKeyRef:
                name: nats-agent-creds
                key: creds
                optional: true
          - name: WORKFLOW_NAME
            value: '{{workflow.name}}'
          - name: WORKFLOW_UID
            value: '{{workflow.uid}}'
          - name: WORKFLOW_NAMESPACE
            value: '{{workflow.namespace}}'
          - name: WORKFLOW_STAGE
            value: research
          - name: WORKFLOW_STEP
            value: '{{pod.name}}'
          - name: AGENT_ID
            value: research
          - name: AGENT_ROLE
            value: assistant
        command: ["/usr/local/bin/codex-bootstrap"]
        args:
          - "/bin/bash"
          - "-lc"
          - |
            set -euo pipefail

            PROMPT_FILE=$(mktemp)
            PROMPT_B64='{{inputs.parameters.prompt}}'
            if [[ -z "$PROMPT_B64" ]]; then
              echo "Missing Codex prompt payload" >&2
              exit 1
            fi
            printf '%s' "$PROMPT_B64" | base64 --decode > "$PROMPT_FILE"

            METADATA_FILE=$(mktemp)
            METADATA_B64='{{inputs.parameters.metadata}}'
            if [[ -z "$METADATA_B64" ]]; then
              echo "Missing Codex metadata payload" >&2
              exit 1
            fi
            printf '%s' "$METADATA_B64" | base64 --decode > "$METADATA_FILE"

            export AUTO_RESEARCH_METADATA_PATH="$METADATA_FILE"
            export AUTO_RESEARCH_ARTIFACT_PATH="${AUTO_RESEARCH_ARTIFACT_PATH:-/workspace/lab/codex-artifact.json}"
            export AUTO_RESEARCH_JSON_LOG="${AUTO_RESEARCH_JSON_LOG:-/workspace/lab/.codex-research-events.jsonl}"
            export AUTO_RESEARCH_AGENT_LOG="${AUTO_RESEARCH_AGENT_LOG:-/workspace/lab/.codex-research-agent.log}"
            export AUTO_RESEARCH_RUNTIME_LOG="${AUTO_RESEARCH_RUNTIME_LOG:-/workspace/lab/.codex-research-runtime.log}"

            AGENT_LOG_PATH="$AUTO_RESEARCH_AGENT_LOG"
            NATS_PUBLISHER="/usr/local/bin/codex-nats-publish"
            NATS_TAIL_PID=""

            if [[ -x "$NATS_PUBLISHER" ]]; then
              touch "$AGENT_LOG_PATH"
              "$NATS_PUBLISHER" --kind status --status started --content "research started" --publish-general
              "$NATS_PUBLISHER" --kind log --log-file "$AGENT_LOG_PATH" &
              NATS_TAIL_PID=$!
            fi

            cleanup_nats() {
              if [[ -n "${NATS_TAIL_PID:-}" ]]; then
                kill "$NATS_TAIL_PID" 2>/dev/null || true
                wait "$NATS_TAIL_PID" 2>/dev/null || true
              fi
            }
            trap cleanup_nats EXIT

            echo "Launching Codex research run"
            set +e
            AGENT_SPEC=$(mktemp)
            cat > "$AGENT_SPEC" <<JSON
            {
              "provider": "codex-research",
              "inputs": {
                "stage": "research"
              },
              "payloads": {
                "promptPath": "$PROMPT_FILE",
                "metadataPath": "$METADATA_FILE"
              },
              "artifacts": {
                "statusPath": "/workspace/lab/.agent-status.json",
                "logPath": "/workspace/lab/.agent-runner.log"
              }
            }
            JSON

            /usr/local/bin/agent-runner --spec "$AGENT_SPEC"
            EXIT_CODE=$?
            set -e

            cleanup_nats

            if [[ -x "$NATS_PUBLISHER" ]]; then
              "$NATS_PUBLISHER" --kind status --status completed --exit-code "$EXIT_CODE" --content "research completed" --publish-general
            fi

            exit "$EXIT_CODE"
      retryStrategy:
        limit: 3
        retryPolicy: OnFailure
      outputs:
        artifacts:
          - name: codex-artifact
            path: /workspace/lab/codex-artifact.json
            s3:
              endpoint: "{{inputs.parameters.artifactEndpoint}}"
              bucket: "{{inputs.parameters.artifactBucket}}"
              key: "{{inputs.parameters.artifactKey}}"
              region: "{{inputs.parameters.artifactRegion}}"
              insecure: true
              accessKeySecret:
                name: observability-minio-creds
                key: accesskey
              secretKeySecret:
                name: observability-minio-creds
                key: secretkey
