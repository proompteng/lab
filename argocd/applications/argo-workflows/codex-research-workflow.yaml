apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: codex-research-workflow
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: graf
spec:
  serviceAccountName: graf
  entrypoint: codex-research
  arguments:
    parameters:
      - name: prompt
        value: ""
      - name: artifactKey
        value: ""
      - name: artifactBucket
        value: argo-workflows
      - name: artifactEndpoint
        value: observability-minio.minio.svc.cluster.local:9000
      - name: artifactRegion
        value: ""
      - name: metadata
        value: "{}"
  templates:
    - name: codex-research
      inputs:
        parameters:
          - name: prompt
          - name: artifactKey
          - name: artifactBucket
          - name: artifactEndpoint
          - name: artifactRegion
          - name: metadata
      container:
        image: registry.ide-newton.ts.net/lab/codex-universal:latest
        imagePullPolicy: Always
        env:
          - name: CODEX_GRAF_BEARER_TOKEN
            valueFrom:
              secretKeyRef:
                name: graf-api
                key: bearer-tokens
                optional: true
          - name: CODEX_GRAF_BASE_URL
            value: "http://graf.graf.svc.cluster.local"
        command: ["/usr/local/bin/codex-bootstrap"]
        args:
          - "/bin/bash"
          - "-lc"
          - |
            set -euo pipefail

            PROMPT_FILE=$(mktemp)
            PROMPT_B64='{{inputs.parameters.prompt}}'
            if [[ -z "$PROMPT_B64" ]]; then
              echo "Missing Codex prompt payload" >&2
              exit 1
            fi
            printf '%s' "$PROMPT_B64" | base64 --decode > "$PROMPT_FILE"

            METADATA_FILE=$(mktemp)
            METADATA_B64='{{inputs.parameters.metadata}}'
            if [[ -z "$METADATA_B64" ]]; then
              echo "Missing Codex metadata payload" >&2
              exit 1
            fi
            printf '%s' "$METADATA_B64" | base64 --decode > "$METADATA_FILE"

            export AUTO_RESEARCH_METADATA_PATH="$METADATA_FILE"
            export AUTO_RESEARCH_ARTIFACT_PATH="${AUTO_RESEARCH_ARTIFACT_PATH:-/workspace/lab/codex-artifact.json}"
            export AUTO_RESEARCH_JSON_LOG="${AUTO_RESEARCH_JSON_LOG:-/workspace/lab/.codex-research-events.jsonl}"
            export AUTO_RESEARCH_AGENT_LOG="${AUTO_RESEARCH_AGENT_LOG:-/workspace/lab/.codex-research-agent.log}"
            export AUTO_RESEARCH_RUNTIME_LOG="${AUTO_RESEARCH_RUNTIME_LOG:-/workspace/lab/.codex-research-runtime.log}"

            echo "Launching Codex research run"
            codex-research "$PROMPT_FILE" "$METADATA_FILE"
      retryStrategy:
        limit: 3
        retryPolicy: OnFailure
      outputs:
        artifacts:
          - name: codex-artifact
            path: /workspace/lab/codex-artifact.json
            s3:
              endpoint: "{{inputs.parameters.artifactEndpoint}}"
              bucket: "{{inputs.parameters.artifactBucket}}"
              key: "{{inputs.parameters.artifactKey}}"
              region: "{{inputs.parameters.artifactRegion}}"
              insecure: true
              accessKeySecret:
                name: observability-minio-creds
                key: accesskey
              secretKeySecret:
                name: observability-minio-creds
                key: secretkey
