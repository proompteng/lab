apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: jangar-signal-wait
  namespace: argo-workflows
spec:
  serviceAccountName: codex-workflow
  entrypoint: wait
  templates:
    - name: wait
      inputs:
        parameters:
          - name: signalRef
            default: ''
          - name: deliveryId
            default: ''
          - name: namespace
            default: "{{workflow.labels['crossplane.io/claim-namespace']}}"
          - name: timeoutSeconds
            default: '86400'
          - name: pollSeconds
            default: '10'
      script:
        image: registry.ide-newton.ts.net/lab/jangar:latest
        command:
          - /bin/bash
          - -c
        source: |
          set -euo pipefail
          signal_ref="{{inputs.parameters.signalRef}}"
          delivery_id="{{inputs.parameters.deliveryId}}"
          namespace="{{inputs.parameters.namespace}}"
          if [ -z "${namespace}" ]; then
            namespace="{{workflow.namespace}}"
          fi
          timeout_seconds="{{inputs.parameters.timeoutSeconds}}"
          poll_seconds="{{inputs.parameters.pollSeconds}}"

          if [ -z "${delivery_id}" ] && [ -z "${signal_ref}" ]; then
            echo "signalRef or deliveryId is required" >&2
            exit 1
          fi

          start_ts="$(date +%s)"
          while true; do
            if [ -n "${delivery_id}" ]; then
              found="$(kubectl get signaldeliveries.signals.proompteng.ai -n "${namespace}" -o jsonpath="{.items[?(@.spec.deliveryId=='${delivery_id}')].metadata.name}" || true)"
            else
              found="$(kubectl get signaldeliveries.signals.proompteng.ai -n "${namespace}" -o jsonpath="{.items[?(@.spec.signalRef.name=='${signal_ref}')].metadata.name}" || true)"
            fi

            if [ -n "${found}" ]; then
              echo "signal delivered: ${found}"
              exit 0
            fi

            if [ "${timeout_seconds}" -gt 0 ]; then
              now_ts="$(date +%s)"
              if [ $((now_ts - start_ts)) -ge "${timeout_seconds}" ]; then
                echo "signal wait timed out after ${timeout_seconds}s" >&2
                exit 1
              fi
            fi

            sleep "${poll_seconds}"
          done
