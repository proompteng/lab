apiVersion: v1
kind: Secret
metadata:
  name: openclaw-cloud-init
type: Opaque
stringData:
  userdata: |-
    #cloud-config
    preserve_hostname: false
    hostname: openclaw
    manage_etc_hosts: true
    package_update: true
    package_upgrade: false
    package_reboot_if_required: true
    packages:
      - qemu-guest-agent
      - openssh-server
      - curl
      - xrdp
      - ubuntu-desktop
      - snapd
    write_files:
      - path: /etc/netplan/99-openclaw.yaml
        owner: root:root
        permissions: '0600'
        content: |-
          network:
            version: 2
            renderer: NetworkManager
            ethernets:
              default:
                match:
                  name: "e*"
                dhcp4: true
                dhcp6: false
      - path: /etc/gdm3/custom.conf
        owner: root:root
        permissions: '0644'
        content: |-
          [daemon]
          WaylandEnable=false
          AutomaticLoginEnable=false
      - path: /var/lib/cloud/scripts/per-boot/10-netplan-apply
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          netplan generate || true
          netplan apply || true
      - path: /usr/local/bin/openclaw-install.sh
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          OPENCLAW_VERSION="${OPENCLAW_VERSION:-2026.2.17}"
          OPENCLAW_BIN='/home/ubuntu/.npm-global/bin/openclaw'
          mkdir -p /var/lib/openclaw
          runuser -u ubuntu -- env HOME=/home/ubuntu OPENCLAW_NO_ONBOARD=1 OPENCLAW_NO_PROMPT=1 \
            OPENCLAW_USE_GUM=0 DEBIAN_FRONTEND=noninteractive OPENCLAW_VERSION="${OPENCLAW_VERSION}" \
            bash -lc \
            'curl -fsSL --proto "=https" --tlsv1.2 https://openclaw.ai/install.sh | bash -s -- --no-onboard --version "${OPENCLAW_VERSION}"' \
            > /var/lib/openclaw/openclaw-install.log 2>&1
          ln -sf "${OPENCLAW_BIN}" /usr/local/bin/openclaw
          if ! grep -q 'npm-global/bin' /home/ubuntu/.profile 2>/dev/null; then
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> /home/ubuntu/.profile
          fi
          if ! grep -q 'npm-global/bin' /home/ubuntu/.bashrc 2>/dev/null; then
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> /home/ubuntu/.bashrc
          fi

          uid="$(id -u ubuntu)"
          loginctl enable-linger ubuntu || true
          systemctl start "user@${uid}.service" || true
          for _ in $(seq 1 30); do
            if [ -S "/run/user/${uid}/bus" ]; then
              break
            fi
            sleep 1
          done
          runuser -u ubuntu -- env HOME=/home/ubuntu XDG_RUNTIME_DIR="/run/user/${uid}" \
            DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${uid}/bus" OPENCLAW_BIN="${OPENCLAW_BIN}" \
            bash -lc '$OPENCLAW_BIN gateway install'
          runuser -u ubuntu -- env HOME=/home/ubuntu XDG_RUNTIME_DIR="/run/user/${uid}" \
            DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${uid}/bus" \
            bash -lc 'systemctl --user daemon-reload && systemctl --user enable --now openclaw-gateway.service'

          echo "${OPENCLAW_VERSION}" > /var/lib/openclaw/openclaw-version-requested.txt
          "${OPENCLAW_BIN}" --version > /var/lib/openclaw/openclaw-version.txt
          runuser -u ubuntu -- env HOME=/home/ubuntu XDG_RUNTIME_DIR="/run/user/${uid}" \
            DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${uid}/bus" OPENCLAW_BIN="${OPENCLAW_BIN}" \
            bash -lc '$OPENCLAW_BIN gateway status' > /var/lib/openclaw/openclaw-gateway-status.txt
          runuser -u ubuntu -- env HOME=/home/ubuntu XDG_RUNTIME_DIR="/run/user/${uid}" \
            DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${uid}/bus" \
            bash -lc 'systemctl --user is-enabled openclaw-gateway.service && systemctl --user is-active openclaw-gateway.service' \
            > /var/lib/openclaw/openclaw-gateway-systemd.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > /var/lib/openclaw/openclaw-installed-at
      - path: /usr/local/bin/install-desktop-apps.sh
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          mkdir -p /var/lib/openclaw

          retry() {
            local attempts="$1"
            shift
            local attempt=1
            until "$@"; do
              if [ "${attempt}" -ge "${attempts}" ]; then
                return 1
              fi
              attempt=$((attempt + 1))
              sleep 3
            done
          }

          install_chrome() {
            local chrome_deb='/tmp/google-chrome-stable_current_amd64.deb'
            retry 5 curl -fsSL --proto "=https" --tlsv1.2 \
              -o "${chrome_deb}" \
              https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            retry 5 apt-get install -y "${chrome_deb}"
            google-chrome --version > /var/lib/openclaw/google-chrome-version.txt
          }

          install_ghostty() {
            systemctl enable --now snapd.socket
            ln -sfn /var/lib/snapd/snap /snap
            retry 20 bash -lc 'snap version >/dev/null 2>&1'
            if ! snap list ghostty >/dev/null 2>&1; then
              retry 5 snap install ghostty --classic
            fi
            snap list ghostty > /var/lib/openclaw/ghostty-version.txt
          }

          install_chrome
          install_ghostty
          date -u +"%Y-%m-%dT%H:%M:%SZ" > /var/lib/openclaw/desktop-apps-installed-at
    users:
      - name: ubuntu
        groups: [sudo]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOE//lpGZI2015yMUjHwhWJjgarTLIsqQBIFXlAanPvS
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDVYPSSdt6tjSWRooRm7nUDS73CebsP92G6GjFa9X+zy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzVze3nx4QPa6t9Wvp5FLrcAlM7BDLUmxf049N4HC6d
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDW2gOD2bqZxDwKEsfZM+ggSBV+DlTrUxMQY8JxDMVgG
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlmf/vteEu7gLBfxyEUjVtQiZ2LCqU6zo+6+G5gmaaa
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEht47QYSXM1n78ww4Aw9jHS50FR9IpQlQGU8emLg1ed
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB9gANXCk/KnE27qvzZk9pGSc1wIzSUewHhqZQXwFJs+
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINXAA7B1vTdTvaMTUcDJTD96v1oiNZx6XI+amVwPXPzy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOco184B4eZEOoLP5ehTK9cgsJgbelKWUxXuO3+S38U/
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII0/89LwFLAM6tu2gtbwVDrQwFhPiW55RciZo0RUVMrF
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH77X+Ekaz8sSLPImUYO8VYhgDDcb+DXkqU26UZ2PaAP
          - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMqGcgm6U9z2d9kH5SNjm4wZumlbMxndFi40iNEhI2OKvfSoE4OQJQ8j5KCiu6GrcE2biJcqP1dkMCaJ8xcaYA8= sshid.io/gregkonush
    ssh_pwauth: false
    disable_root: true
    runcmd:
      - [ bash, -lc, 'systemctl enable --now qemu-guest-agent' ]
      - [ bash, -lc, 'systemctl enable --now ssh' ]
      - [ bash, -lc, 'systemctl enable --now NetworkManager' ]
      - [ bash, -lc, 'netplan generate && netplan apply || true' ]
      - [ bash, -lc, 'adduser xrdp ssl-cert || true' ]
      - [ bash, -lc, 'grep -q "unset DBUS_SESSION_BUS_ADDRESS" /etc/xrdp/startwm.sh || sed -i "/^if test -r \\/etc\\/profile;/i unset DBUS_SESSION_BUS_ADDRESS\\nunset XDG_RUNTIME_DIR\\n" /etc/xrdp/startwm.sh' ]
      - [ bash, -lc, 'systemctl set-default graphical.target' ]
      - [ bash, -lc, 'systemctl enable --now xrdp' ]
      - [ bash, -lc, 'mkdir -p /var/lib/openclaw' ]
      - [ bash, -lc, '/usr/local/bin/openclaw-install.sh' ]
      - [ bash, -lc, '/usr/local/bin/install-desktop-apps.sh' ]
      - [ bash, -lc, 'dpkg-query -W ubuntu-desktop > /var/lib/openclaw/desktop-package.txt' ]
      - [ bash, -lc, 'date -u +"%Y-%m-%dT%H:%M:%SZ" > /var/lib/openclaw/desktop-ready' ]
