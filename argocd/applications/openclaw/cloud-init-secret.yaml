apiVersion: v1
kind: Secret
metadata:
  name: openclaw-cloud-init
type: Opaque
stringData:
  userdata: |-
    #cloud-config
    preserve_hostname: false
    hostname: openclaw
    manage_etc_hosts: true
    package_update: true
    package_upgrade: false
    package_reboot_if_required: true
    packages:
      - qemu-guest-agent
      - openssh-server
      - curl
      - xrdp
      - ubuntu-desktop
    write_files:
      - path: /etc/netplan/99-openclaw.yaml
        owner: root:root
        permissions: '0600'
        content: |-
          network:
            version: 2
            renderer: NetworkManager
            ethernets:
              default:
                match:
                  name: "e*"
                dhcp4: true
                dhcp6: false
      - path: /etc/gdm3/custom.conf
        owner: root:root
        permissions: '0644'
        content: |-
          [daemon]
          WaylandEnable=false
          AutomaticLoginEnable=false
      - path: /var/lib/cloud/scripts/per-boot/10-netplan-apply
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          netplan generate || true
          netplan apply || true
      - path: /usr/local/bin/openclaw-install.sh
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          OPENCLAW_VERSION="${OPENCLAW_VERSION:-2026.2.17}"
          mkdir -p /var/lib/openclaw
          runuser -u ubuntu -- env HOME=/home/ubuntu OPENCLAW_NO_ONBOARD=1 OPENCLAW_NO_PROMPT=1 \
            OPENCLAW_USE_GUM=0 DEBIAN_FRONTEND=noninteractive OPENCLAW_VERSION="${OPENCLAW_VERSION}" \
            bash -lc \
            'curl -fsSL --proto "=https" --tlsv1.2 https://openclaw.ai/install.sh | bash -s -- --no-onboard --version "${OPENCLAW_VERSION}"' \
            > /var/lib/openclaw/openclaw-install.log 2>&1
          ln -sf /home/ubuntu/.npm-global/bin/openclaw /usr/local/bin/openclaw
          echo "${OPENCLAW_VERSION}" > /var/lib/openclaw/openclaw-version-requested.txt
          /home/ubuntu/.npm-global/bin/openclaw --version > /var/lib/openclaw/openclaw-version.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > /var/lib/openclaw/openclaw-installed-at
    users:
      - name: ubuntu
        groups: [sudo]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOE//lpGZI2015yMUjHwhWJjgarTLIsqQBIFXlAanPvS
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDVYPSSdt6tjSWRooRm7nUDS73CebsP92G6GjFa9X+zy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzVze3nx4QPa6t9Wvp5FLrcAlM7BDLUmxf049N4HC6d
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDW2gOD2bqZxDwKEsfZM+ggSBV+DlTrUxMQY8JxDMVgG
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlmf/vteEu7gLBfxyEUjVtQiZ2LCqU6zo+6+G5gmaaa
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEht47QYSXM1n78ww4Aw9jHS50FR9IpQlQGU8emLg1ed
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB9gANXCk/KnE27qvzZk9pGSc1wIzSUewHhqZQXwFJs+
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINXAA7B1vTdTvaMTUcDJTD96v1oiNZx6XI+amVwPXPzy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOco184B4eZEOoLP5ehTK9cgsJgbelKWUxXuO3+S38U/
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII0/89LwFLAM6tu2gtbwVDrQwFhPiW55RciZo0RUVMrF
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH77X+Ekaz8sSLPImUYO8VYhgDDcb+DXkqU26UZ2PaAP
          - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMqGcgm6U9z2d9kH5SNjm4wZumlbMxndFi40iNEhI2OKvfSoE4OQJQ8j5KCiu6GrcE2biJcqP1dkMCaJ8xcaYA8= sshid.io/gregkonush
    ssh_pwauth: false
    disable_root: true
    runcmd:
      - [ bash, -lc, 'systemctl enable --now qemu-guest-agent' ]
      - [ bash, -lc, 'systemctl enable --now ssh' ]
      - [ bash, -lc, 'systemctl enable --now NetworkManager' ]
      - [ bash, -lc, 'netplan generate && netplan apply || true' ]
      - [ bash, -lc, 'adduser xrdp ssl-cert || true' ]
      - [ bash, -lc, 'grep -q "unset DBUS_SESSION_BUS_ADDRESS" /etc/xrdp/startwm.sh || sed -i "/^if test -r \\/etc\\/profile;/i unset DBUS_SESSION_BUS_ADDRESS\\nunset XDG_RUNTIME_DIR\\n" /etc/xrdp/startwm.sh' ]
      - [ bash, -lc, 'systemctl set-default graphical.target' ]
      - [ bash, -lc, 'systemctl enable --now xrdp' ]
      - [ bash, -lc, 'mkdir -p /var/lib/openclaw' ]
      - [ bash, -lc, '/usr/local/bin/openclaw-install.sh' ]
      - [ bash, -lc, 'dpkg-query -W ubuntu-desktop > /var/lib/openclaw/desktop-package.txt' ]
      - [ bash, -lc, 'date -u +"%Y-%m-%dT%H:%M:%SZ" > /var/lib/openclaw/desktop-ready' ]
