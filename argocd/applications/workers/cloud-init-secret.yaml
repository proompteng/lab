apiVersion: v1
kind: Secret
metadata:
  name: workers-cloud-init
type: Opaque
stringData:
  userdata: |-
    #cloud-config
    preserve_hostname: false
    hostname: workers
    manage_etc_hosts: true
    package_update: true
    package_upgrade: false
    disk_setup:
      /dev/vdb:
        table_type: gpt
        layout: true
        overwrite: false
    fs_setup:
      - device: /dev/vdb
        filesystem: ext4
        overwrite: false
    mounts:
      - ["/dev/vdb", "/home/ubuntu/data", "ext4", "defaults,nofail", "0", "2"]
    packages:
      - openssh-server
      - ca-certificates
      - curl
      - gnupg
      - git
      - jq
      - python3
      - build-essential
      - unzip
      - xz-utils
    write_files:
      - path: /home/ubuntu/.codex/config.toml
        owner: root:root
        permissions: '0600'
        content: |-
          model = "gpt-5.2-codex"
          model_reasoning_summary = "detailed"
          model_reasoning_effort = "medium"
          model_verbosity = "medium"
          approval_policy = "never"
          sandbox_mode = "danger-full-access"

          [features]
          undo = true
          web_search_request = true
          web_search_cached = true
          enable_request_compression = true
          apply_patch_freeform = true
          unified_exec = true
          shell_snapshot = true
          steer = true
          collab = true
          child_agents_md = true
          collaboration_modes = true
          responses_websockets = true

          [shell_environment_policy]
          ignore_default_excludes = true

          [projects."/home/ubuntu/github.com/lab"]
          trust_level = "trusted"

          [projects."/home/ubuntu"]
          trust_level = "trusted"
      - path: /home/ubuntu/.profile
        owner: root:root
        permissions: '0644'
        content: |-
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
      - path: /etc/systemd/system/chrome-remote-debug.service
        owner: root:root
        permissions: '0644'
        content: |-
          [Unit]
          Description=Chrome remote debugging (headless)
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=ubuntu
          Environment=CHROME_PATH=/usr/bin/google-chrome
          Environment=CHROME_REMOTE_DEBUG_PORT=9222
          Environment=CHROME_DEVTOOLS_USER_DATA=/home/ubuntu/data/chrome-devtools
          ExecStart=/usr/local/bin/start-chrome-remote-debug
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
      - path: /etc/systemd/system/chrome-devtools-mcp.service
        owner: root:root
        permissions: '0644'
        content: |-
          [Unit]
          Description=Chrome DevTools MCP server
          After=chrome-remote-debug.service network-online.target
          Requires=chrome-remote-debug.service

          [Service]
          Type=simple
          User=ubuntu
          Environment=NODE_NO_WARNINGS=1
          ExecStart=/usr/local/bin/start-chrome-devtools-mcp
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
      - path: /etc/netplan/99-kubevirt.yaml
        owner: root:root
        permissions: '0600'
        content: |-
          network:
            version: 2
            renderer: NetworkManager
            ethernets:
              default:
                match:
                  name: "e*"
                dhcp4: true
                dhcp6: false
      - path: /usr/local/bin/start-chrome-remote-debug
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          CHROME_PATH="${CHROME_PATH:-/usr/bin/google-chrome}"
          USER_DATA_DIR="${CHROME_DEVTOOLS_USER_DATA:-/home/ubuntu/data/chrome-devtools}"
          REMOTE_DEBUG_PORT="${CHROME_REMOTE_DEBUG_PORT:-9222}"
          mkdir -p "${USER_DATA_DIR}"
          exec "${CHROME_PATH}" \
            --user-data-dir="${USER_DATA_DIR}" \
            --profile-directory=Default \
            --remote-debugging-port="${REMOTE_DEBUG_PORT}" \
            --remote-debugging-address=127.0.0.1 \
            --remote-allow-origins=* \
            --no-first-run \
            --no-default-browser-check \
            --disable-gpu \
            --headless=new
      - path: /usr/local/bin/start-chrome-devtools-mcp
        owner: root:root
        permissions: '0755'
        content: |-
          #!/usr/bin/env bash
          set -euo pipefail
          export NVM_DIR="/home/ubuntu/.nvm"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            # shellcheck disable=SC1090
            . "$NVM_DIR/nvm.sh"
          fi
          exec npx -y chrome-devtools-mcp@latest --browser-url http://127.0.0.1:9222
    users:
      - name: ubuntu
        groups: [sudo]
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOE//lpGZI2015yMUjHwhWJjgarTLIsqQBIFXlAanPvS
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDVYPSSdt6tjSWRooRm7nUDS73CebsP92G6GjFa9X+zy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAzVze3nx4QPa6t9Wvp5FLrcAlM7BDLUmxf049N4HC6d
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDW2gOD2bqZxDwKEsfZM+ggSBV+DlTrUxMQY8JxDMVgG
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlmf/vteEu7gLBfxyEUjVtQiZ2LCqU6zo+6+G5gmaaa
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEht47QYSXM1n78ww4Aw9jHS50FR9IpQlQGU8emLg1ed
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB9gANXCk/KnE27qvzZk9pGSc1wIzSUewHhqZQXwFJs+
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINXAA7B1vTdTvaMTUcDJTD96v1oiNZx6XI+amVwPXPzy
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOco184B4eZEOoLP5ehTK9cgsJgbelKWUxXuO3+S38U/
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII0/89LwFLAM6tu2gtbwVDrQwFhPiW55RciZo0RUVMrF
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH77X+Ekaz8sSLPImUYO8VYhgDDcb+DXkqU26UZ2PaAP
    ssh_pwauth: false
    disable_root: true
    runcmd:
      - [ bash, -lc, 'systemctl enable --now ssh' ]
      - [ bash, -lc, 'install -m 0755 -d /etc/apt/keyrings' ]
      - [ bash, -lc, 'curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg' ]
      - [ bash, -lc, 'echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list' ]
      - [ bash, -lc, 'apt-get update' ]
      - [ bash, -lc, 'DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-desktop' ]
      - [ bash, -lc, 'systemctl enable --now NetworkManager' ]
      - [ bash, -lc, 'netplan apply' ]
      - [ bash, -lc, 'DEBIAN_FRONTEND=noninteractive apt-get install -y google-chrome-stable' ]
      - [ bash, -lc, 'apt-get clean && rm -rf /var/lib/apt/lists/*' ]
      - [ bash, -lc, 'chown -R ubuntu:ubuntu /home/ubuntu' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash''"' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''source ~/.nvm/nvm.sh && nvm install --lts && nvm alias default lts/*''"' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''curl -fsSL https://bun.sh/install | bash''"' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''~/.bun/bin/bun add -g @openai/codex''"' ]
      - [ bash, -lc, 'bash -lc ''source /home/ubuntu/.nvm/nvm.sh && install -m 0755 -d /usr/local/bin && ln -sf "$(command -v node)" /usr/local/bin/node && ln -sf "$(command -v npm)" /usr/local/bin/npm && ln -sf "$(command -v npx)" /usr/local/bin/npx''' ]
      - [ bash, -lc, 'bash -lc ''export BUN_INSTALL=/home/ubuntu/.bun; export PATH="$BUN_INSTALL/bin:$PATH"; ln -sf "$(command -v bun)" /usr/local/bin/bun; ln -sf "$(command -v codex)" /usr/local/bin/codex''' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''mkdir -p /home/ubuntu/data/chrome-devtools ~/.codex ~/github.com''"' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''[ -d ~/github.com/lab ] || git clone --depth 1 https://github.com/proompteng/lab ~/github.com/lab''"' ]
      - [ bash, -lc, 'su - ubuntu -c "bash -lc ''rm -rf ~/.codex/skills && mkdir -p ~/.codex/skills && cp -R ~/github.com/lab/skills/. ~/.codex/skills/''"' ]
      - [ bash, -lc, 'systemctl daemon-reload' ]
      - [ bash, -lc, 'systemctl restart ssh' ]
      - [ bash, -lc, 'systemctl enable --now chrome-remote-debug.service chrome-devtools-mcp.service' ]
      - [ bash, -lc, 'chown -R ubuntu:ubuntu /home/ubuntu || true' ]
