services:
  redis:
    image: redis:7-alpine
    container_name: jangar-redis
    command:
      - redis-server
      - --save
      - ""
      - --appendonly
      - "no"
    ports:
      - "6379:6379"
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: jangar-postgres
    environment:
      POSTGRES_USER: openwebui
      POSTGRES_PASSWORD: ${OPENWEBUI_DB_PASSWORD:-openwebui}
      POSTGRES_DB: openwebui
    volumes:
      - openwebui-pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openwebui"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  openwebui:
    image: ghcr.io/open-webui/open-webui:v0.6.43
    container_name: jangar-openwebui
    ports:
      - "${OPENWEBUI_PORT:-8080}:8080"
    environment:
      - DATABASE_URL=postgresql://openwebui:${OPENWEBUI_DB_PASSWORD:-openwebui}@postgres:5432/openwebui
      - DATABASE_TYPE=postgresql
      - OPENAI_API_BASE_URL=${JANGAR_OPENAI_BASE_URL:-http://host.docker.internal:3000/openai/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-changeme}
      - DEFAULT_MODELS=meta-orchestrator
      - ENABLE_OPENAI_API=true
      - BYPASS_MODEL_ACCESS_CONTROL=true
      - ENABLE_SIGNUP=false
      - DEFAULT_USER_ROLE=admin
      - WEBUI_AUTH=false
      - ENABLE_LOGIN_FORM=false
      - GLOBAL_LOG_LEVEL=DEBUG
      - UVICORN_LOG_LEVEL=debug
      - WEBSOCKET_MANAGER=redis
      - WEBSOCKET_REDIS_URL=redis://redis:6379/0
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - openwebui-data:/app/backend/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s

volumes:
  openwebui-data:
  openwebui-pg-data:
