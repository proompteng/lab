"""SQLAlchemy ORM models for torghut."""

from __future__ import annotations

import uuid
from datetime import datetime
from decimal import Decimal
from typing import Any, List, Optional

from sqlalchemy import Boolean, DateTime, ForeignKey, Index, Integer, Numeric, String, Text, text
from sqlalchemy import func
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .base import Base, GUID, JSONType


class TimestampMixin:
    """Mixin providing created_at and updated_at timestamps."""

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False
    )


class CreatedAtMixin:
    """Mixin providing created_at timestamp only."""

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), nullable=False
    )


class Strategy(Base, TimestampMixin):
    """Trading strategy configuration."""

    __tablename__ = "strategies"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    name: Mapped[str] = mapped_column(String(length=255), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    enabled: Mapped[bool] = mapped_column(Boolean, nullable=False, default=True, server_default=func.true())
    base_timeframe: Mapped[str] = mapped_column(String(length=16), nullable=False)
    universe_type: Mapped[str] = mapped_column(String(length=64), nullable=False)
    universe_symbols: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    max_position_pct_equity: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    max_notional_per_trade: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)

    trade_decisions: Mapped[List["TradeDecision"]] = relationship(
        back_populates="strategy", cascade="all, delete-orphan"
    )

    __table_args__ = (
        Index("ix_strategies_enabled", "enabled"),
        Index("ix_strategies_name", "name"),
    )


class TradeDecision(Base, CreatedAtMixin):
    """Decisions generated by strategies before order execution."""

    __tablename__ = "trade_decisions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    strategy_id: Mapped[uuid.UUID] = mapped_column(
        GUID(), ForeignKey("strategies.id", ondelete="CASCADE"), nullable=False
    )
    alpaca_account_label: Mapped[str] = mapped_column(String(length=64), nullable=False)
    symbol: Mapped[str] = mapped_column(String(length=16), nullable=False)
    timeframe: Mapped[str] = mapped_column(String(length=16), nullable=False)
    decision_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    rationale: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    decision_hash: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    status: Mapped[str] = mapped_column(
        String(length=32), nullable=False, default="planned", server_default=text("'planned'")
    )
    executed_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)

    strategy: Mapped[Strategy] = relationship(back_populates="trade_decisions")
    executions: Mapped[List["Execution"]] = relationship(back_populates="trade_decision")

    __table_args__ = (
        Index("ix_trade_decisions_strategy", "strategy_id"),
        Index("ix_trade_decisions_status", "status"),
        Index("ix_trade_decisions_decision_hash", "decision_hash", unique=True),
    )


class Execution(Base, TimestampMixin):
    """Orders sent to Alpaca and their execution state."""

    __tablename__ = "executions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    trade_decision_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="SET NULL"), nullable=True
    )
    alpaca_order_id: Mapped[str] = mapped_column(String(length=128), nullable=False, unique=True)
    client_order_id: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True, unique=True)
    symbol: Mapped[str] = mapped_column(String(length=16), nullable=False)
    side: Mapped[str] = mapped_column(String(length=8), nullable=False)
    order_type: Mapped[str] = mapped_column(String(length=32), nullable=False)
    time_in_force: Mapped[str] = mapped_column(String(length=16), nullable=False)
    submitted_qty: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    filled_qty: Mapped[Decimal] = mapped_column(
        Numeric(20, 8), nullable=False, default=Decimal("0"), server_default=text("0")
    )
    avg_fill_price: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    status: Mapped[str] = mapped_column(String(length=32), nullable=False)
    raw_order: Mapped[Any] = mapped_column(JSONType, nullable=True)
    last_update_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)

    trade_decision: Mapped[Optional[TradeDecision]] = relationship(back_populates="executions")

    __table_args__ = (
        Index("ix_executions_alpaca_order_id", "alpaca_order_id"),
        Index("ix_executions_symbol_status", "symbol", "status"),
    )


class PositionSnapshot(Base, CreatedAtMixin):
    """Snapshots of account equity, cash, buying power, and positions."""

    __tablename__ = "position_snapshots"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    alpaca_account_label: Mapped[str] = mapped_column(String(length=64), nullable=False)
    as_of: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    equity: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    cash: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    buying_power: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    positions: Mapped[Any] = mapped_column(JSONType, nullable=False)

    __table_args__ = (
        Index("ix_position_snapshots_as_of", "as_of"),
        Index("ix_position_snapshots_account_label", "alpaca_account_label"),
    )


class ToolRunLog(Base, CreatedAtMixin):
    """Trace of tool invocations made by the Codex agent."""

    __tablename__ = "tool_run_logs"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    codex_session_id: Mapped[str] = mapped_column(String(length=128), nullable=False)
    tool_name: Mapped[str] = mapped_column(String(length=128), nullable=False)
    request_payload: Mapped[Any] = mapped_column(JSONType, nullable=False)
    response_payload: Mapped[Any] = mapped_column(JSONType, nullable=False)
    success: Mapped[bool] = mapped_column(Boolean, nullable=False, default=True, server_default=func.true())

    __table_args__ = (
        Index("ix_tool_run_logs_codex_session", "codex_session_id"),
    )


class TradeCursor(Base, TimestampMixin):
    """Cursor for signal ingestion progress tracking."""

    __tablename__ = "trade_cursor"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    source: Mapped[str] = mapped_column(String(length=64), nullable=False, unique=True)
    cursor_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    cursor_seq: Mapped[int] = mapped_column(
        Integer, nullable=False, default=0, server_default=text("0")
    )


__all__ = [
    "Strategy",
    "TradeDecision",
    "Execution",
    "PositionSnapshot",
    "ToolRunLog",
    "TradeCursor",
    "TimestampMixin",
    "CreatedAtMixin",
    "JSONType",
]
