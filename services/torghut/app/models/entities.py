"""SQLAlchemy ORM models for torghut."""

from __future__ import annotations

import uuid
from datetime import datetime
from decimal import Decimal
from typing import Any, List, Optional

from sqlalchemy import (
    BigInteger,
    Boolean,
    DateTime,
    ForeignKey,
    Index,
    Numeric,
    String,
    Text,
    text,
)
from sqlalchemy import func
from sqlalchemy.orm import Mapped, mapped_column, relationship

from .base import Base, GUID, JSONType


class TimestampMixin:
    """Mixin providing created_at and updated_at timestamps."""

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now(),
        nullable=False,
    )


class CreatedAtMixin:
    """Mixin providing created_at timestamp only."""

    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=func.now(), nullable=False
    )


class Strategy(Base, TimestampMixin):
    """Trading strategy configuration."""

    __tablename__ = "strategies"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    name: Mapped[str] = mapped_column(String(length=255), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    enabled: Mapped[bool] = mapped_column(
        Boolean, nullable=False, default=True, server_default=func.true()
    )
    base_timeframe: Mapped[str] = mapped_column(String(length=16), nullable=False)
    universe_type: Mapped[str] = mapped_column(String(length=64), nullable=False)
    universe_symbols: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    max_position_pct_equity: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    max_notional_per_trade: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )

    trade_decisions: Mapped[List["TradeDecision"]] = relationship(
        back_populates="strategy", cascade="all, delete-orphan"
    )

    __table_args__ = (
        Index("ix_strategies_enabled", "enabled"),
        Index("ix_strategies_name", "name"),
    )


class TradeDecision(Base, CreatedAtMixin):
    """Decisions generated by strategies before order execution."""

    __tablename__ = "trade_decisions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    strategy_id: Mapped[uuid.UUID] = mapped_column(
        GUID(), ForeignKey("strategies.id", ondelete="CASCADE"), nullable=False
    )
    alpaca_account_label: Mapped[str] = mapped_column(
        String(length=64), nullable=False, server_default=text("'paper'")
    )
    symbol: Mapped[str] = mapped_column(String(length=16), nullable=False)
    timeframe: Mapped[str] = mapped_column(String(length=16), nullable=False)
    decision_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    rationale: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    decision_hash: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="planned",
        server_default=text("'planned'"),
    )
    executed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    strategy: Mapped[Strategy] = relationship(back_populates="trade_decisions")
    executions: Mapped[List["Execution"]] = relationship(
        back_populates="trade_decision"
    )
    llm_reviews: Mapped[List["LLMDecisionReview"]] = relationship(
        back_populates="trade_decision", cascade="all, delete-orphan"
    )

    __table_args__ = (
        Index("ix_trade_decisions_strategy", "strategy_id"),
        Index("ix_trade_decisions_status", "status"),
        Index("ix_trade_decisions_decision_hash", "decision_hash"),
        Index(
            "uq_trade_decisions_account_decision_hash",
            "alpaca_account_label",
            "decision_hash",
            unique=True,
        ),
    )


class Execution(Base, TimestampMixin):
    """Orders sent to Alpaca and their execution state."""

    __tablename__ = "executions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    trade_decision_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="SET NULL"), nullable=True
    )
    alpaca_account_label: Mapped[str] = mapped_column(
        String(length=64), nullable=False, server_default=text("'paper'")
    )
    alpaca_order_id: Mapped[str] = mapped_column(
        String(length=128), nullable=False
    )
    client_order_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    symbol: Mapped[str] = mapped_column(String(length=16), nullable=False)
    side: Mapped[str] = mapped_column(String(length=8), nullable=False)
    order_type: Mapped[str] = mapped_column(String(length=32), nullable=False)
    time_in_force: Mapped[str] = mapped_column(String(length=16), nullable=False)
    submitted_qty: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    filled_qty: Mapped[Decimal] = mapped_column(
        Numeric(20, 8), nullable=False, default=Decimal("0"), server_default=text("0")
    )
    avg_fill_price: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    status: Mapped[str] = mapped_column(String(length=32), nullable=False)
    execution_expected_adapter: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="unknown",
        server_default=text("'unknown'"),
    )
    execution_actual_adapter: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="unknown",
        server_default=text("'unknown'"),
    )
    execution_fallback_reason: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    execution_fallback_count: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    execution_correlation_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    execution_idempotency_key: Mapped[Optional[str]] = mapped_column(
        String(length=96), nullable=True
    )
    execution_audit_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    raw_order: Mapped[Any] = mapped_column(JSONType, nullable=True)
    last_update_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    order_feed_last_event_ts: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    order_feed_last_seq: Mapped[Optional[int]] = mapped_column(
        BigInteger, nullable=True
    )

    trade_decision: Mapped[Optional[TradeDecision]] = relationship(
        back_populates="executions"
    )
    order_events: Mapped[List["ExecutionOrderEvent"]] = relationship(
        back_populates="execution"
    )

    __table_args__ = (
        Index("ix_executions_alpaca_order_id", "alpaca_order_id"),
        Index("ix_executions_account_label", "alpaca_account_label"),
        Index(
            "uq_executions_account_alpaca_order_id",
            "alpaca_account_label",
            "alpaca_order_id",
            unique=True,
        ),
        Index(
            "uq_executions_account_client_order_id",
            "alpaca_account_label",
            "client_order_id",
            unique=True,
        ),
        Index("ix_executions_symbol_status", "symbol", "status"),
        Index("ix_executions_expected_adapter", "execution_expected_adapter"),
        Index("ix_executions_actual_adapter", "execution_actual_adapter"),
        Index("ix_executions_execution_correlation_id", "execution_correlation_id"),
        Index("ix_executions_order_feed_last_event_ts", "order_feed_last_event_ts"),
    )


class ExecutionOrderEvent(Base, CreatedAtMixin):
    """Normalized order-feed events persisted for execution-state reconciliation."""

    __tablename__ = "execution_order_events"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    event_fingerprint: Mapped[str] = mapped_column(
        String(length=64), nullable=False, unique=True
    )
    source_topic: Mapped[str] = mapped_column(String(length=128), nullable=False)
    source_partition: Mapped[Optional[int]] = mapped_column(nullable=True)
    source_offset: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    alpaca_account_label: Mapped[str] = mapped_column(String(length=64), nullable=False)
    feed_seq: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    event_ts: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    symbol: Mapped[Optional[str]] = mapped_column(String(length=16), nullable=True)
    alpaca_order_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    client_order_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    event_type: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    status: Mapped[Optional[str]] = mapped_column(String(length=32), nullable=True)
    qty: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    filled_qty: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    avg_fill_price: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    raw_event: Mapped[Any] = mapped_column(JSONType, nullable=False)
    execution_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("executions.id", ondelete="SET NULL"), nullable=True
    )
    trade_decision_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="SET NULL"), nullable=True
    )

    execution: Mapped[Optional[Execution]] = relationship(back_populates="order_events")
    trade_decision: Mapped[Optional[TradeDecision]] = relationship()

    __table_args__ = (
        Index("ix_execution_order_events_event_ts", "event_ts"),
        Index("ix_execution_order_events_execution_id", "execution_id"),
        Index("ix_execution_order_events_trade_decision_id", "trade_decision_id"),
        Index("ix_execution_order_events_order_id", "alpaca_order_id"),
        Index("ix_execution_order_events_client_order_id", "client_order_id"),
        Index(
            "uq_execution_order_events_source_offset",
            "source_topic",
            "source_partition",
            "source_offset",
            unique=True,
        ),
    )


class ResearchRun(Base, TimestampMixin):
    """Durable research execution metadata for autonomous lane runs."""

    __tablename__ = "research_runs"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    run_id: Mapped[str] = mapped_column(String(length=64), nullable=False, unique=True)
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="running",
        server_default=text("'running'"),
    )
    strategy_id: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    strategy_name: Mapped[Optional[str]] = mapped_column(
        String(length=255), nullable=True
    )
    strategy_type: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    strategy_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    code_commit: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    feature_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    feature_schema_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    feature_spec_hash: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    signal_source: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    dataset_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    dataset_from: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    dataset_to: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    dataset_snapshot_ref: Mapped[Optional[str]] = mapped_column(
        String(length=255), nullable=True
    )
    runner_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    runner_binary_hash: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    gate_report_trace_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    recommendation_trace_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )

    __table_args__ = (
        Index("ix_research_runs_status", "status"),
        Index("ix_research_runs_created_at", "created_at"),
        Index("ix_research_runs_gate_trace", "gate_report_trace_id"),
        Index("ix_research_runs_recommendation_trace", "recommendation_trace_id"),
    )


class ResearchCandidate(Base, CreatedAtMixin):
    """Candidate metadata selected by an autonomous research lane."""

    __tablename__ = "research_candidates"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    run_id: Mapped[str] = mapped_column(String(length=64), nullable=False)
    candidate_id: Mapped[str] = mapped_column(
        String(length=64), nullable=False, unique=True
    )
    candidate_hash: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    parameter_set: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    decision_count: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    trade_count: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    symbols_covered: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    universe_definition: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    promotion_target: Mapped[Optional[str]] = mapped_column(
        String(length=16), nullable=True
    )
    lifecycle_role: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="challenger",
        server_default=text("'challenger'"),
    )
    lifecycle_status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="evaluated",
        server_default=text("'evaluated'"),
    )
    metadata_bundle: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    recommendation_bundle: Mapped[Optional[Any]] = mapped_column(
        JSONType, nullable=True
    )

    __table_args__ = (
        Index("ix_research_candidates_run_id", "run_id"),
        Index("ix_research_candidates_candidate_id", "candidate_id"),
        Index("ix_research_candidates_lifecycle_role", "lifecycle_role"),
        Index("ix_research_candidates_lifecycle_status", "lifecycle_status"),
    )


class ResearchFoldMetrics(Base, CreatedAtMixin):
    """Fold-level metric records for offline robustness checks."""

    __tablename__ = "research_fold_metrics"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    candidate_id: Mapped[str] = mapped_column(String(length=64), nullable=False)
    fold_name: Mapped[str] = mapped_column(String(length=128), nullable=False)
    fold_order: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    train_start: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False
    )
    train_end: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    test_start: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False
    )
    test_end: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    decision_count: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    trade_count: Mapped[int] = mapped_column(
        BigInteger(), nullable=False, default=0, server_default=text("0")
    )
    gross_pnl: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    net_pnl: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    max_drawdown: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    turnover_ratio: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    cost_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    cost_assumptions: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    regime_label: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )

    __table_args__ = (
        Index("ix_research_fold_metrics_candidate", "candidate_id"),
        Index("ix_research_fold_metrics_fold_order", "fold_order"),
    )


class ResearchStressMetrics(Base, CreatedAtMixin):
    """Stress-case and resilience metrics for robustness checks."""

    __tablename__ = "research_stress_metrics"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    candidate_id: Mapped[str] = mapped_column(String(length=64), nullable=False)
    stress_case: Mapped[str] = mapped_column(String(length=64), nullable=False)
    metric_bundle: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    pessimistic_pnl_delta: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )

    __table_args__ = (
        Index("ix_research_stress_metrics_candidate", "candidate_id"),
        Index("ix_research_stress_metrics_case", "stress_case"),
    )


class ResearchPromotion(Base, CreatedAtMixin):
    """Promotion request/decision audit rows for research candidates."""

    __tablename__ = "research_promotions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    candidate_id: Mapped[str] = mapped_column(String(length=64), nullable=False)
    requested_mode: Mapped[Optional[str]] = mapped_column(
        String(length=16), nullable=True
    )
    approved_mode: Mapped[Optional[str]] = mapped_column(
        String(length=16), nullable=True
    )
    approver: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    approver_role: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    approve_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    deny_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    paper_candidate_patch_ref: Mapped[Optional[str]] = mapped_column(
        String(length=255), nullable=True
    )
    effective_time: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    decision_action: Mapped[str] = mapped_column(
        String(length=32), nullable=False, default="hold", server_default=text("'hold'")
    )
    decision_rationale: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    evidence_bundle: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    recommendation_trace_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    successor_candidate_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    rollback_candidate_id: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )

    __table_args__ = (
        Index("ix_research_promotions_candidate", "candidate_id"),
        Index("ix_research_promotions_requested_mode", "requested_mode"),
        Index("ix_research_promotions_approved_mode", "approved_mode"),
        Index("ix_research_promotions_action", "decision_action"),
        Index("ix_research_promotions_recommendation_trace", "recommendation_trace_id"),
    )


class WhitepaperDocument(Base, TimestampMixin):
    """Logical whitepaper record with source metadata and lifecycle status."""

    __tablename__ = "whitepaper_documents"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    document_key: Mapped[str] = mapped_column(
        String(length=64),
        nullable=False,
        unique=True,
        default=lambda: f"wp-{uuid.uuid4().hex[:24]}",
    )
    source: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="upload",
        server_default=text("'upload'"),
    )
    source_identifier: Mapped[Optional[str]] = mapped_column(
        String(length=255), nullable=True
    )
    title: Mapped[Optional[str]] = mapped_column(String(length=512), nullable=True)
    abstract: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    authors_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    published_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    language: Mapped[str] = mapped_column(
        String(length=16),
        nullable=False,
        default="en",
        server_default=text("'en'"),
    )
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="uploaded",
        server_default=text("'uploaded'"),
    )
    tags_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    metadata_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    ingested_by: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    last_processed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    versions: Mapped[List["WhitepaperDocumentVersion"]] = relationship(
        back_populates="document", cascade="all, delete-orphan"
    )
    analysis_runs: Mapped[List["WhitepaperAnalysisRun"]] = relationship(
        back_populates="document", cascade="all, delete-orphan"
    )
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="document"
    )

    __table_args__ = (
        Index("ix_whitepaper_documents_status", "status"),
        Index("ix_whitepaper_documents_source", "source"),
        Index(
            "uq_whitepaper_documents_source_identifier",
            "source",
            "source_identifier",
            unique=True,
        ),
    )


class WhitepaperDocumentVersion(Base, TimestampMixin):
    """Concrete uploaded file revision and extraction bookkeeping."""

    __tablename__ = "whitepaper_document_versions"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    document_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_documents.id", ondelete="CASCADE"),
        nullable=False,
    )
    version_number: Mapped[int] = mapped_column(BigInteger, nullable=False)
    trigger_reason: Mapped[str] = mapped_column(
        String(length=64),
        nullable=False,
        default="upload",
        server_default=text("'upload'"),
    )
    file_name: Mapped[Optional[str]] = mapped_column(String(length=512), nullable=True)
    mime_type: Mapped[str] = mapped_column(
        String(length=128),
        nullable=False,
        default="application/pdf",
        server_default=text("'application/pdf'"),
    )
    file_size_bytes: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    checksum_sha256: Mapped[str] = mapped_column(String(length=64), nullable=False)
    ceph_bucket: Mapped[str] = mapped_column(String(length=128), nullable=False)
    ceph_object_key: Mapped[str] = mapped_column(String(length=1024), nullable=False)
    ceph_etag: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    parse_status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="pending",
        server_default=text("'pending'"),
    )
    parse_error: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    page_count: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    char_count: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    token_count: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    language: Mapped[Optional[str]] = mapped_column(String(length=16), nullable=True)
    upload_metadata_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    extraction_metadata_json: Mapped[Optional[Any]] = mapped_column(
        JSONType, nullable=True
    )
    uploaded_by: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    processed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    document: Mapped[WhitepaperDocument] = relationship(back_populates="versions")
    content: Mapped[Optional["WhitepaperContent"]] = relationship(
        back_populates="document_version",
        uselist=False,
        cascade="all, delete-orphan",
    )
    analysis_runs: Mapped[List["WhitepaperAnalysisRun"]] = relationship(
        back_populates="document_version", cascade="all, delete-orphan"
    )
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="document_version"
    )

    __table_args__ = (
        Index("ix_whitepaper_document_versions_document_id", "document_id"),
        Index("ix_whitepaper_document_versions_parse_status", "parse_status"),
        Index("ix_whitepaper_document_versions_checksum", "checksum_sha256"),
        Index(
            "uq_whitepaper_document_versions_document_version",
            "document_id",
            "version_number",
            unique=True,
        ),
        Index(
            "uq_whitepaper_document_versions_ceph_object",
            "ceph_bucket",
            "ceph_object_key",
            unique=True,
        ),
    )


class WhitepaperContent(Base, CreatedAtMixin):
    """Normalized full-text representation used by synthesis/viability agents."""

    __tablename__ = "whitepaper_contents"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    document_version_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_document_versions.id", ondelete="CASCADE"),
        nullable=False,
        unique=True,
    )
    text_source: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="pdf_extract",
        server_default=text("'pdf_extract'"),
    )
    full_text: Mapped[str] = mapped_column(Text, nullable=False)
    full_text_sha256: Mapped[str] = mapped_column(String(length=64), nullable=False)
    section_index_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    references_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    tables_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    figures_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    chunk_manifest_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    extraction_warnings_json: Mapped[Optional[Any]] = mapped_column(
        JSONType, nullable=True
    )
    quality_score: Mapped[Optional[Decimal]] = mapped_column(Numeric(6, 4), nullable=True)

    document_version: Mapped[WhitepaperDocumentVersion] = relationship(
        back_populates="content"
    )

    __table_args__ = (
        Index("ix_whitepaper_contents_full_text_sha256", "full_text_sha256"),
    )


class WhitepaperAnalysisRun(Base, TimestampMixin):
    """Workflow-level execution record for Inngest-driven whitepaper processing."""

    __tablename__ = "whitepaper_analysis_runs"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    run_id: Mapped[str] = mapped_column(String(length=64), nullable=False, unique=True)
    document_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_documents.id", ondelete="CASCADE"),
        nullable=False,
    )
    document_version_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_document_versions.id", ondelete="CASCADE"),
        nullable=False,
    )
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="queued",
        server_default=text("'queued'"),
    )
    trigger_source: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="upload",
        server_default=text("'upload'"),
    )
    trigger_actor: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    retry_of_run_id: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    inngest_event_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    inngest_function_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    inngest_run_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True, unique=True
    )
    orchestration_context_json: Mapped[Optional[Any]] = mapped_column(
        JSONType, nullable=True
    )
    analysis_profile_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    request_payload_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    result_payload_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    failure_code: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    failure_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    started_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    completed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    document: Mapped[WhitepaperDocument] = relationship(back_populates="analysis_runs")
    document_version: Mapped[WhitepaperDocumentVersion] = relationship(
        back_populates="analysis_runs"
    )
    steps: Mapped[List["WhitepaperAnalysisStep"]] = relationship(
        back_populates="analysis_run", cascade="all, delete-orphan"
    )
    codex_agentruns: Mapped[List["WhitepaperCodexAgentRun"]] = relationship(
        back_populates="analysis_run", cascade="all, delete-orphan"
    )
    synthesis: Mapped[Optional["WhitepaperSynthesis"]] = relationship(
        back_populates="analysis_run",
        uselist=False,
        cascade="all, delete-orphan",
    )
    viability_verdict: Mapped[Optional["WhitepaperViabilityVerdict"]] = relationship(
        back_populates="analysis_run",
        uselist=False,
        cascade="all, delete-orphan",
    )
    design_pull_requests: Mapped[List["WhitepaperDesignPullRequest"]] = relationship(
        back_populates="analysis_run", cascade="all, delete-orphan"
    )
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="analysis_run"
    )

    __table_args__ = (
        Index("ix_whitepaper_analysis_runs_status", "status"),
        Index("ix_whitepaper_analysis_runs_document_id", "document_id"),
        Index(
            "ix_whitepaper_analysis_runs_document_version_id", "document_version_id"
        ),
        Index("ix_whitepaper_analysis_runs_inngest_event_id", "inngest_event_id"),
        Index("ix_whitepaper_analysis_runs_created_at", "created_at"),
    )


class WhitepaperAnalysisStep(Base, TimestampMixin):
    """Stage-level audit rows for each Inngest workflow step attempt."""

    __tablename__ = "whitepaper_analysis_steps"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    analysis_run_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="CASCADE"),
        nullable=False,
    )
    step_name: Mapped[str] = mapped_column(String(length=64), nullable=False)
    step_order: Mapped[int] = mapped_column(
        BigInteger, nullable=False, default=0, server_default=text("0")
    )
    attempt: Mapped[int] = mapped_column(
        BigInteger, nullable=False, default=1, server_default=text("1")
    )
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="queued",
        server_default=text("'queued'"),
    )
    executor: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    idempotency_key: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    trace_id: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    started_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    completed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    duration_ms: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    input_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    output_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    error_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    analysis_run: Mapped[WhitepaperAnalysisRun] = relationship(back_populates="steps")
    codex_agentruns: Mapped[List["WhitepaperCodexAgentRun"]] = relationship(
        back_populates="analysis_step"
    )

    __table_args__ = (
        Index("ix_whitepaper_analysis_steps_run_id", "analysis_run_id"),
        Index("ix_whitepaper_analysis_steps_step_name", "step_name"),
        Index("ix_whitepaper_analysis_steps_status", "status"),
        Index(
            "uq_whitepaper_analysis_steps_run_step_attempt",
            "analysis_run_id",
            "step_name",
            "attempt",
            unique=True,
        ),
    )


class WhitepaperCodexAgentRun(Base, TimestampMixin):
    """AgentRun execution context for Codex whitepaper analysis against repo state."""

    __tablename__ = "whitepaper_codex_agentruns"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    analysis_run_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="CASCADE"),
        nullable=False,
    )
    analysis_step_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_steps.id", ondelete="SET NULL"),
        nullable=True,
    )
    agentrun_name: Mapped[str] = mapped_column(
        String(length=128), nullable=False, unique=True
    )
    agentrun_namespace: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    agentrun_uid: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="queued",
        server_default=text("'queued'"),
    )
    execution_mode: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="default",
        server_default=text("'default'"),
    )
    requested_by: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    codex_session_id: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    vcs_provider: Mapped[Optional[str]] = mapped_column(String(length=32), nullable=True)
    vcs_repository: Mapped[Optional[str]] = mapped_column(
        String(length=255), nullable=True
    )
    vcs_base_branch: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    vcs_head_branch: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    vcs_base_commit_sha: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    vcs_head_commit_sha: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    workspace_context_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    prompt_text: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    prompt_hash: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    input_context_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    output_context_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    patch_artifact_ref: Mapped[Optional[str]] = mapped_column(
        String(length=512), nullable=True
    )
    log_artifact_ref: Mapped[Optional[str]] = mapped_column(
        String(length=512), nullable=True
    )
    started_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    completed_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    failure_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    analysis_run: Mapped[WhitepaperAnalysisRun] = relationship(
        back_populates="codex_agentruns"
    )
    analysis_step: Mapped[Optional[WhitepaperAnalysisStep]] = relationship(
        back_populates="codex_agentruns"
    )
    design_pull_requests: Mapped[List["WhitepaperDesignPullRequest"]] = relationship(
        back_populates="codex_agentrun"
    )

    __table_args__ = (
        Index("ix_whitepaper_codex_agentruns_run_id", "analysis_run_id"),
        Index("ix_whitepaper_codex_agentruns_status", "status"),
        Index(
            "ix_whitepaper_codex_agentruns_codex_session_id", "codex_session_id"
        ),
        Index("ix_whitepaper_codex_agentruns_head_branch", "vcs_head_branch"),
    )


class WhitepaperSynthesis(Base, TimestampMixin):
    """Structured synthesis payload generated by Codex from full paper context."""

    __tablename__ = "whitepaper_syntheses"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    analysis_run_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="CASCADE"),
        nullable=False,
        unique=True,
    )
    synthesis_version: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="v1",
        server_default=text("'v1'"),
    )
    generated_by: Mapped[str] = mapped_column(
        String(length=64),
        nullable=False,
        default="codex",
        server_default=text("'codex'"),
    )
    model_name: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    prompt_version: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    executive_summary: Mapped[str] = mapped_column(Text, nullable=False)
    problem_statement: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    methodology_summary: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    key_findings_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    novelty_claims_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    risk_assessment_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    citations_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    implementation_plan_md: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    confidence: Mapped[Optional[Decimal]] = mapped_column(Numeric(6, 4), nullable=True)
    synthesis_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    analysis_run: Mapped[WhitepaperAnalysisRun] = relationship(back_populates="synthesis")
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="synthesis"
    )

    __table_args__ = (
        Index("ix_whitepaper_syntheses_generated_by", "generated_by"),
    )


class WhitepaperViabilityVerdict(Base, TimestampMixin):
    """Final viability decision and policy evidence for a whitepaper analysis run."""

    __tablename__ = "whitepaper_viability_verdicts"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    analysis_run_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="CASCADE"),
        nullable=False,
        unique=True,
    )
    verdict: Mapped[str] = mapped_column(String(length=32), nullable=False)
    score: Mapped[Optional[Decimal]] = mapped_column(Numeric(8, 4), nullable=True)
    confidence: Mapped[Optional[Decimal]] = mapped_column(Numeric(6, 4), nullable=True)
    decision_policy: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    gating_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    rationale: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    rejection_reasons_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    recommendations_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    requires_followup: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        server_default=func.false(),
    )
    approved_by: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    approved_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )

    analysis_run: Mapped[WhitepaperAnalysisRun] = relationship(
        back_populates="viability_verdict"
    )
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="viability_verdict"
    )

    __table_args__ = (
        Index("ix_whitepaper_viability_verdicts_verdict", "verdict"),
        Index(
            "ix_whitepaper_viability_verdicts_requires_followup", "requires_followup"
        ),
    )


class WhitepaperDesignPullRequest(Base, TimestampMixin):
    """Design-document pull request metadata generated from whitepaper analysis."""

    __tablename__ = "whitepaper_design_pull_requests"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    analysis_run_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="CASCADE"),
        nullable=False,
    )
    codex_agentrun_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_codex_agentruns.id", ondelete="SET NULL"),
        nullable=True,
    )
    attempt: Mapped[int] = mapped_column(
        BigInteger, nullable=False, default=1, server_default=text("1")
    )
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="draft",
        server_default=text("'draft'"),
    )
    repository: Mapped[str] = mapped_column(String(length=255), nullable=False)
    base_branch: Mapped[str] = mapped_column(String(length=128), nullable=False)
    head_branch: Mapped[str] = mapped_column(String(length=128), nullable=False)
    pr_number: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    pr_url: Mapped[Optional[str]] = mapped_column(String(length=512), nullable=True)
    title: Mapped[Optional[str]] = mapped_column(String(length=512), nullable=True)
    body: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    commit_sha: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    merge_commit_sha: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    checks_url: Mapped[Optional[str]] = mapped_column(String(length=512), nullable=True)
    ci_status: Mapped[Optional[str]] = mapped_column(String(length=32), nullable=True)
    is_merged: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        server_default=func.false(),
    )
    merged_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), nullable=True
    )
    metadata_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    analysis_run: Mapped[WhitepaperAnalysisRun] = relationship(
        back_populates="design_pull_requests"
    )
    codex_agentrun: Mapped[Optional[WhitepaperCodexAgentRun]] = relationship(
        back_populates="design_pull_requests"
    )
    artifacts: Mapped[List["WhitepaperArtifact"]] = relationship(
        back_populates="design_pull_request"
    )

    __table_args__ = (
        Index("ix_whitepaper_design_pull_requests_status", "status"),
        Index("ix_whitepaper_design_pull_requests_pr_number", "pr_number"),
        Index("ix_whitepaper_design_pull_requests_merged", "is_merged"),
        Index(
            "uq_whitepaper_design_pull_requests_run_attempt",
            "analysis_run_id",
            "attempt",
            unique=True,
        ),
    )


class WhitepaperArtifact(Base, CreatedAtMixin):
    """Normalized artifact ledger for Ceph/S3 objects and derived outputs."""

    __tablename__ = "whitepaper_artifacts"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    document_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_documents.id", ondelete="SET NULL"),
        nullable=True,
    )
    document_version_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_document_versions.id", ondelete="SET NULL"),
        nullable=True,
    )
    analysis_run_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_analysis_runs.id", ondelete="SET NULL"),
        nullable=True,
    )
    synthesis_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_syntheses.id", ondelete="SET NULL"),
        nullable=True,
    )
    viability_verdict_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_viability_verdicts.id", ondelete="SET NULL"),
        nullable=True,
    )
    design_pull_request_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(),
        ForeignKey("whitepaper_design_pull_requests.id", ondelete="SET NULL"),
        nullable=True,
    )
    artifact_scope: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="run",
        server_default=text("'run'"),
    )
    artifact_type: Mapped[str] = mapped_column(String(length=64), nullable=False)
    artifact_role: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    ceph_bucket: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    ceph_object_key: Mapped[Optional[str]] = mapped_column(
        String(length=1024), nullable=True
    )
    artifact_uri: Mapped[Optional[str]] = mapped_column(String(length=1024), nullable=True)
    checksum_sha256: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    size_bytes: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    content_type: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    metadata_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    document: Mapped[Optional[WhitepaperDocument]] = relationship(back_populates="artifacts")
    document_version: Mapped[Optional[WhitepaperDocumentVersion]] = relationship(
        back_populates="artifacts"
    )
    analysis_run: Mapped[Optional[WhitepaperAnalysisRun]] = relationship(
        back_populates="artifacts"
    )
    synthesis: Mapped[Optional[WhitepaperSynthesis]] = relationship(
        back_populates="artifacts"
    )
    viability_verdict: Mapped[Optional[WhitepaperViabilityVerdict]] = relationship(
        back_populates="artifacts"
    )
    design_pull_request: Mapped[Optional[WhitepaperDesignPullRequest]] = relationship(
        back_populates="artifacts"
    )

    __table_args__ = (
        Index("ix_whitepaper_artifacts_artifact_type", "artifact_type"),
        Index("ix_whitepaper_artifacts_analysis_run_id", "analysis_run_id"),
        Index("ix_whitepaper_artifacts_document_version_id", "document_version_id"),
        Index(
            "uq_whitepaper_artifacts_ceph_object",
            "ceph_bucket",
            "ceph_object_key",
            unique=True,
        ),
    )


class PositionSnapshot(Base, CreatedAtMixin):
    """Snapshots of account equity, cash, buying power, and positions."""

    __tablename__ = "position_snapshots"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    alpaca_account_label: Mapped[str] = mapped_column(String(length=64), nullable=False)
    as_of: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    equity: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    cash: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    buying_power: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    positions: Mapped[Any] = mapped_column(JSONType, nullable=False)

    __table_args__ = (
        Index("ix_position_snapshots_as_of", "as_of"),
        Index("ix_position_snapshots_account_label", "alpaca_account_label"),
    )


class ExecutionTCAMetric(Base, TimestampMixin):
    """Per-order transaction cost analytics metrics derived from execution outcomes."""

    __tablename__ = "execution_tca_metrics"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    execution_id: Mapped[uuid.UUID] = mapped_column(
        GUID(),
        ForeignKey("executions.id", ondelete="CASCADE"),
        nullable=False,
        unique=True,
    )
    trade_decision_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="SET NULL"), nullable=True
    )
    strategy_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("strategies.id", ondelete="SET NULL"), nullable=True
    )
    alpaca_account_label: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    symbol: Mapped[str] = mapped_column(String(length=16), nullable=False)
    side: Mapped[str] = mapped_column(String(length=8), nullable=False)
    arrival_price: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    avg_fill_price: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    filled_qty: Mapped[Decimal] = mapped_column(
        Numeric(20, 8), nullable=False, default=Decimal("0"), server_default=text("0")
    )
    signed_qty: Mapped[Decimal] = mapped_column(
        Numeric(20, 8), nullable=False, default=Decimal("0"), server_default=text("0")
    )
    slippage_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    shortfall_notional: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    expected_shortfall_bps_p50: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    expected_shortfall_bps_p95: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    realized_shortfall_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    divergence_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    simulator_version: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    churn_qty: Mapped[Decimal] = mapped_column(
        Numeric(20, 8), nullable=False, default=Decimal("0"), server_default=text("0")
    )
    churn_ratio: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    computed_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now()
    )

    __table_args__ = (
        Index("ix_execution_tca_metrics_strategy_symbol", "strategy_id", "symbol"),
        Index("ix_execution_tca_metrics_symbol", "symbol"),
        Index("ix_execution_tca_metrics_computed_at", "computed_at"),
    )


class LeanBacktestRun(Base, TimestampMixin):
    """Asynchronous LEAN backtest request lifecycle and reproducibility ledger."""

    __tablename__ = "lean_backtest_runs"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    backtest_id: Mapped[str] = mapped_column(String(length=64), nullable=False, unique=True)
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="queued",
        server_default=text("'queued'"),
    )
    requested_by: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    lane: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="research",
        server_default=text("'research'"),
    )
    config_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    result_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    artifacts_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    reproducibility_hash: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    replay_hash: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    deterministic_replay_passed: Mapped[Optional[bool]] = mapped_column(Boolean, nullable=True)
    failure_taxonomy: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    completed_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)

    __table_args__ = (
        Index("ix_lean_backtest_runs_status", "status"),
        Index("ix_lean_backtest_runs_lane", "lane"),
        Index("ix_lean_backtest_runs_created_at", "created_at"),
    )


class LeanExecutionShadowEvent(Base, CreatedAtMixin):
    """Parity telemetry comparing Torghut intents against LEAN shadow simulation."""

    __tablename__ = "lean_execution_shadow_events"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    correlation_id: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    trade_decision_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="SET NULL"), nullable=True
    )
    execution_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("executions.id", ondelete="SET NULL"), nullable=True
    )
    symbol: Mapped[str] = mapped_column(String(length=32), nullable=False)
    side: Mapped[str] = mapped_column(String(length=8), nullable=False)
    qty: Mapped[Decimal] = mapped_column(Numeric(20, 8), nullable=False)
    intent_notional: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    simulated_fill_price: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    simulated_slippage_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    parity_delta_bps: Mapped[Optional[Decimal]] = mapped_column(Numeric(20, 8), nullable=True)
    parity_status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="unknown",
        server_default=text("'unknown'"),
    )
    failure_taxonomy: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    simulation_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    __table_args__ = (
        Index("ix_lean_execution_shadow_events_created_at", "created_at"),
        Index("ix_lean_execution_shadow_events_symbol", "symbol"),
        Index("ix_lean_execution_shadow_events_status", "parity_status"),
        Index("ix_lean_execution_shadow_events_trade_decision", "trade_decision_id"),
    )


class LeanCanaryIncident(Base, CreatedAtMixin):
    """Gate-breach incidents and rollback evidence for controlled LEAN live canaries."""

    __tablename__ = "lean_canary_incidents"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    incident_key: Mapped[str] = mapped_column(String(length=96), nullable=False, unique=True)
    breach_type: Mapped[str] = mapped_column(String(length=64), nullable=False)
    severity: Mapped[str] = mapped_column(
        String(length=16),
        nullable=False,
        default="warning",
        server_default=text("'warning'"),
    )
    rollback_triggered: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        server_default=func.false(),
    )
    symbols: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    evidence_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    resolved_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)

    __table_args__ = (
        Index("ix_lean_canary_incidents_breach_type", "breach_type"),
        Index("ix_lean_canary_incidents_created_at", "created_at"),
    )


class LeanStrategyShadowEvaluation(Base, CreatedAtMixin):
    """Shadow-only LEAN strategy-runtime parity evidence before promotion."""

    __tablename__ = "lean_strategy_shadow_evaluations"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    run_id: Mapped[str] = mapped_column(String(length=64), nullable=False, unique=True)
    strategy_id: Mapped[str] = mapped_column(String(length=128), nullable=False)
    symbol: Mapped[str] = mapped_column(String(length=32), nullable=False)
    intent_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    shadow_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    parity_status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="unknown",
        server_default=text("'unknown'"),
    )
    governance_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    disable_switch_active: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        server_default=func.false(),
    )

    __table_args__ = (
        Index("ix_lean_strategy_shadow_evaluations_strategy", "strategy_id"),
        Index("ix_lean_strategy_shadow_evaluations_symbol", "symbol"),
        Index("ix_lean_strategy_shadow_evaluations_status", "parity_status"),
    )


class ToolRunLog(Base, CreatedAtMixin):
    """Trace of tool invocations made by the Codex agent."""

    __tablename__ = "tool_run_logs"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    codex_session_id: Mapped[str] = mapped_column(String(length=128), nullable=False)
    tool_name: Mapped[str] = mapped_column(String(length=128), nullable=False)
    request_payload: Mapped[Any] = mapped_column(JSONType, nullable=False)
    response_payload: Mapped[Any] = mapped_column(JSONType, nullable=False)
    success: Mapped[bool] = mapped_column(
        Boolean, nullable=False, default=True, server_default=func.true()
    )

    __table_args__ = (Index("ix_tool_run_logs_codex_session", "codex_session_id"),)


class TradeCursor(Base, TimestampMixin):
    """Cursor for signal ingestion progress tracking."""

    __tablename__ = "trade_cursor"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    source: Mapped[str] = mapped_column(String(length=64), nullable=False)
    account_label: Mapped[str] = mapped_column(
        String(length=64), nullable=False, server_default=text("'paper'")
    )
    cursor_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), nullable=False)
    cursor_seq: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)
    cursor_symbol: Mapped[Optional[str]] = mapped_column(
        String(length=32), nullable=True
    )

    __table_args__ = (
        Index("uq_trade_cursor_source_account", "source", "account_label", unique=True),
    )


class LLMDSPyWorkflowArtifact(Base, TimestampMixin):
    """DSPy compile/eval/promotion artifact + AgentRun audit record."""

    __tablename__ = "llm_dspy_workflow_artifacts"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    run_key: Mapped[str] = mapped_column(String(length=128), nullable=False, unique=True)
    lane: Mapped[str] = mapped_column(String(length=32), nullable=False)
    status: Mapped[str] = mapped_column(
        String(length=32),
        nullable=False,
        default="queued",
        server_default=text("'queued'"),
    )
    implementation_spec_ref: Mapped[str] = mapped_column(
        String(length=128), nullable=False
    )
    program_name: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    signature_version: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    optimizer: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    artifact_uri: Mapped[Optional[str]] = mapped_column(String(length=1024), nullable=True)
    artifact_hash: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    dataset_hash: Mapped[Optional[str]] = mapped_column(String(length=64), nullable=True)
    compiled_prompt_hash: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    reproducibility_hash: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    metric_bundle: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    gate_compatibility: Mapped[Optional[str]] = mapped_column(
        String(length=16), nullable=True
    )
    promotion_recommendation: Mapped[Optional[str]] = mapped_column(
        String(length=32), nullable=True
    )
    promotion_target: Mapped[Optional[str]] = mapped_column(
        String(length=32), nullable=True
    )
    idempotency_key: Mapped[Optional[str]] = mapped_column(
        String(length=128), nullable=True
    )
    agentrun_name: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    agentrun_namespace: Mapped[Optional[str]] = mapped_column(
        String(length=64), nullable=True
    )
    agentrun_uid: Mapped[Optional[str]] = mapped_column(String(length=128), nullable=True)
    request_payload_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    response_payload_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    metadata_json: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)

    __table_args__ = (
        Index("ix_llm_dspy_workflow_artifacts_lane", "lane"),
        Index("ix_llm_dspy_workflow_artifacts_status", "status"),
        Index(
            "ix_llm_dspy_workflow_artifacts_program_name",
            "program_name",
        ),
        Index(
            "ix_llm_dspy_workflow_artifacts_artifact_hash",
            "artifact_hash",
        ),
        Index(
            "ix_llm_dspy_workflow_artifacts_created_at",
            "created_at",
        ),
    )


class LLMDecisionReview(Base, CreatedAtMixin):
    """Audit record for LLM review of a trade decision."""

    __tablename__ = "llm_decision_reviews"

    id: Mapped[uuid.UUID] = mapped_column(GUID(), primary_key=True, default=uuid.uuid4)
    trade_decision_id: Mapped[uuid.UUID] = mapped_column(
        GUID(), ForeignKey("trade_decisions.id", ondelete="CASCADE"), nullable=False
    )
    model: Mapped[str] = mapped_column(String(length=128), nullable=False)
    prompt_version: Mapped[str] = mapped_column(String(length=32), nullable=False)
    input_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    response_json: Mapped[Any] = mapped_column(JSONType, nullable=False)
    verdict: Mapped[str] = mapped_column(String(length=16), nullable=False)
    confidence: Mapped[Optional[Decimal]] = mapped_column(Numeric(6, 4), nullable=True)
    adjusted_qty: Mapped[Optional[Decimal]] = mapped_column(
        Numeric(20, 8), nullable=True
    )
    adjusted_order_type: Mapped[Optional[str]] = mapped_column(
        String(length=32), nullable=True
    )
    rationale: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    risk_flags: Mapped[Optional[Any]] = mapped_column(JSONType, nullable=True)
    tokens_prompt: Mapped[Optional[int]] = mapped_column(nullable=True)
    tokens_completion: Mapped[Optional[int]] = mapped_column(nullable=True)

    trade_decision: Mapped[TradeDecision] = relationship(back_populates="llm_reviews")

    __table_args__ = (
        Index("ix_llm_decision_reviews_trade_decision_id", "trade_decision_id"),
        Index("ix_llm_decision_reviews_verdict", "verdict"),
        Index("ix_llm_decision_reviews_created_at", "created_at"),
    )


__all__ = [
    "Strategy",
    "TradeDecision",
    "Execution",
    "ExecutionOrderEvent",
    "WhitepaperDocument",
    "WhitepaperDocumentVersion",
    "WhitepaperContent",
    "WhitepaperAnalysisRun",
    "WhitepaperAnalysisStep",
    "WhitepaperCodexAgentRun",
    "WhitepaperSynthesis",
    "WhitepaperViabilityVerdict",
    "WhitepaperDesignPullRequest",
    "WhitepaperArtifact",
    "PositionSnapshot",
    "ToolRunLog",
    "TradeCursor",
    "ResearchRun",
    "ResearchCandidate",
    "ResearchFoldMetrics",
    "ResearchStressMetrics",
    "ResearchPromotion",
    "LeanBacktestRun",
    "LeanExecutionShadowEvent",
    "LeanCanaryIncident",
    "LeanStrategyShadowEvaluation",
    "LLMDSPyWorkflowArtifact",
    "LLMDecisionReview",
    "TimestampMixin",
    "CreatedAtMixin",
    "JSONType",
]
