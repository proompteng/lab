---
- name: Configure k3s API server OIDC settings
  hosts: kube_masters
  remote_user: kalmyk
  become: true
  serial: 1
  vars:
    k3s_oidc_issuer_url: https://auth.proompteng.ai/realms/master
    k3s_oidc_client_id: kubernetes
    k3s_oidc_username_claim: preferred_username
    k3s_oidc_groups_claim: groups
    k3s_oidc_username_prefix: 'oidc:'
    k3s_oidc_groups_prefix: 'oidc:'
    k3s_oidc_ca_file: ''
    k3s_oidc_restart: true
  tasks:
    - name: Ensure k3s config drop-in directory exists
      ansible.builtin.file:
        path: /etc/rancher/k3s/config.yaml.d
        state: directory
        mode: '0755'

    - name: Write k3s OIDC config
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/k3s-oidc.yaml.j2"
        dest: /etc/rancher/k3s/config.yaml.d/oidc.yaml
        owner: root
        group: root
        mode: '0644'
      notify: Restart k3s

  handlers:
    - name: Restart k3s
      ansible.builtin.systemd:
        name: k3s
        state: restarted
        enabled: true
      when: k3s_oidc_restart
