{{- $errors := list -}}
{{- $clusterScoped := .Values.rbac.clusterScoped | default false -}}
{{- $controllerNamespaces := .Values.controller.namespaces | default (list) -}}
{{- $orchestrationNamespaces := .Values.orchestrationController.namespaces | default (list) -}}
{{- $supportingNamespaces := .Values.supportingController.namespaces | default (list) -}}
{{- $globalEnvVars := .Values.env.vars | default dict -}}
{{- $controlPlaneEnvVars := merge (deepCopy $globalEnvVars) (deepCopy (.Values.controlPlane.env.vars | default dict)) -}}
{{- $controlPlaneExplicitEnvVars := .Values.controlPlane.env.vars | default dict -}}
{{- $controllersExplicitEnvVars := .Values.controllers.env.vars | default dict -}}
{{- $envFromSecretRefs := .Values.envFromSecretRefs | default (list) -}}
{{- $envFromConfigMapRefs := .Values.envFromConfigMapRefs | default (list) -}}
{{- $reservedEnvKeysEnforced := .Values.validation.reservedEnvKeysEnforced | default false -}}
{{- $reservedEnvKeys := list
  "JANGAR_GRPC_ENABLED"
  "JANGAR_GRPC_HOST"
  "JANGAR_GRPC_PORT"
  "JANGAR_MIGRATIONS"
  "JANGAR_CONTROL_PLANE_CACHE_ENABLED"
  "JANGAR_AGENTRUN_IDEMPOTENCY_ENABLED"
  "JANGAR_AGENTRUN_IDEMPOTENCY_RETENTION_DAYS"
  "JANGAR_AGENTRUN_ARTIFACTS_MAX"
  "JANGAR_AGENTRUN_ARTIFACTS_STRICT"
}}
{{- $grpcManagedByChart := .Values.grpc.manageEnvVar | default true -}}
{{- $expectedGrpcEnabled := ternary "true" "false" .Values.grpc.enabled -}}
{{- $expectedGrpcHost := "0.0.0.0" -}}
{{- $expectedGrpcPort := toString .Values.grpc.port -}}
{{- $expectedControllersGrpcEnabled := "0" -}}
{{- $expectedControllersGrpcHost := "0.0.0.0" -}}
{{- $expectedControllersGrpcPort := toString .Values.grpc.port -}}

{{- if and (gt (len $controllerNamespaces) 1) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $controllerNamespaces) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $orchestrationNamespaces) 1) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $orchestrationNamespaces) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $supportingNamespaces) 1) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $supportingNamespaces) (not $clusterScoped) }}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if $grpcManagedByChart }}
{{- $grpcControlPlaneGrpcConflictValues := list "JANGAR_GRPC_ENABLED" "JANGAR_GRPC_HOST" "JANGAR_GRPC_PORT" -}}
{{- range $grpcEnvKey := $grpcControlPlaneGrpcConflictValues }}
{{- if and (hasKey $controlPlaneExplicitEnvVars $grpcEnvKey) (hasKey $globalEnvVars $grpcEnvKey) }}
{{- if ne (toString (index $controlPlaneExplicitEnvVars $grpcEnvKey)) (toString (index $globalEnvVars $grpcEnvKey)) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but env.vars and controlPlane.env.vars define conflicting values for %q: env.vars=%s, controlPlane.env.vars=%s. Remove one value so the key has one source of truth." $grpcEnvKey (index $globalEnvVars $grpcEnvKey) (index $controlPlaneExplicitEnvVars $grpcEnvKey)) -}}
{{- end }}
{{- end }}
{{- if and (hasKey $controllersExplicitEnvVars $grpcEnvKey) (hasKey $globalEnvVars $grpcEnvKey) }}
{{- if ne (toString (index $controllersExplicitEnvVars $grpcEnvKey)) (toString (index $globalEnvVars $grpcEnvKey)) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but env.vars and controllers.env.vars define conflicting values for %q: env.vars=%s, controllers.env.vars=%s. Set controllers.env.vars to match env.vars or remove it from env.vars." $grpcEnvKey (index $globalEnvVars $grpcEnvKey) (index $controllersExplicitEnvVars $grpcEnvKey)) -}}
{{- end }}
{{- end }}
{{- end }}

{{- if and (hasKey $controlPlaneEnvVars "JANGAR_GRPC_ENABLED") (ne (toString (index $controlPlaneEnvVars "JANGAR_GRPC_ENABLED")) $expectedGrpcEnabled) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but control-plane env values (env.vars + controlPlane.env.vars) set JANGAR_GRPC_ENABLED=%s which does not match grpc.enabled=%s." (index $controlPlaneEnvVars "JANGAR_GRPC_ENABLED") .Values.grpc.enabled) -}}
{{- end -}}
{{- if and (hasKey $controlPlaneEnvVars "JANGAR_GRPC_HOST") (ne (toString (index $controlPlaneEnvVars "JANGAR_GRPC_HOST")) $expectedGrpcHost) }}
{{- $errors = append $errors "grpc managed by chart is enabled (grpc.manageEnvVar=true), but control-plane env values (env.vars + controlPlane.env.vars) override JANGAR_GRPC_HOST. Remove the override or set grpc.manageEnvVar=false." -}}
{{- end -}}
{{- if and (hasKey $controlPlaneEnvVars "JANGAR_GRPC_PORT") (ne (toString (index $controlPlaneEnvVars "JANGAR_GRPC_PORT")) $expectedGrpcPort) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but control-plane env values (env.vars + controlPlane.env.vars) set JANGAR_GRPC_PORT=%s which does not match grpc.port=%s." (index $controlPlaneEnvVars "JANGAR_GRPC_PORT") .Values.grpc.port) -}}
{{- end -}}
{{- if and (hasKey $controllersExplicitEnvVars "JANGAR_GRPC_ENABLED") (ne (toString (index $controllersExplicitEnvVars "JANGAR_GRPC_ENABLED")) $expectedControllersGrpcEnabled) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but controllers.env.vars sets JANGAR_GRPC_ENABLED=%s. Set it to %q or set grpc.manageEnvVar=false to own controller gRPC settings explicitly." (index $controllersExplicitEnvVars "JANGAR_GRPC_ENABLED") $expectedControllersGrpcEnabled) -}}
{{- end -}}
{{- if and (hasKey $controllersExplicitEnvVars "JANGAR_GRPC_HOST") (ne (toString (index $controllersExplicitEnvVars "JANGAR_GRPC_HOST")) $expectedControllersGrpcHost) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but controllers.env.vars sets JANGAR_GRPC_HOST=%s. Remove the override or set grpc.manageEnvVar=false to own controller gRPC settings explicitly." (index $controllersExplicitEnvVars "JANGAR_GRPC_HOST")) -}}
{{- end -}}
{{- if and (hasKey $controllersExplicitEnvVars "JANGAR_GRPC_PORT") (ne (toString (index $controllersExplicitEnvVars "JANGAR_GRPC_PORT")) $expectedControllersGrpcPort) }}
{{- $errors = append $errors (printf "grpc managed by chart is enabled (grpc.manageEnvVar=true), but controllers.env.vars sets JANGAR_GRPC_PORT=%s, which does not match grpc.port=%s. Remove the override or set grpc.manageEnvVar=false to own controller gRPC settings explicitly." (index $controllersExplicitEnvVars "JANGAR_GRPC_PORT") .Values.grpc.port) -}}
{{- end -}}
{{- end -}}

{{- if $reservedEnvKeysEnforced }}
{{- $refSourceType := "secretRef" }}
{{- range $envSource := $envFromSecretRefs }}
{{- if kindIs "map" $envSource }}
{{- $refName := index $envSource "name" | default "anonymous" -}}
{{- $refKeys := list -}}
{{- if kindIs "slice" (index $envSource "keys") }}
{{- $refKeys = index $envSource "keys" -}}
{{- else if kindIs "string" (index $envSource "keys") }}
{{- $refKeys = list (index $envSource "keys") -}}
{{- end }}
{{- range $refKeys }}
{{- if and (kindIs "string" .) (has . $reservedEnvKeys) }}
{{- if not (hasKey $controlPlaneEnvVars .) }}
{{- $errors = append $errors (printf "envFrom %s %q sets reserved key %q, but controlPlane.env.vars+env.vars does not explicitly set it; add it to controlPlane.env.vars or env.vars, or disable validation.reservedEnvKeysEnforced=false." $refSourceType $refName .) -}}
{{- end }}
{{- if not (hasKey $controllersExplicitEnvVars .) }}
{{- $errors = append $errors (printf "envFrom %s %q sets reserved key %q, but controllers.env.vars does not explicitly set it; add it to controllers.env.vars, or disable validation.reservedEnvKeysEnforced=false." $refSourceType $refName .) -}}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{- $refSourceType = "configMapRef" }}
{{- range $envSource := $envFromConfigMapRefs }}
{{- if kindIs "map" $envSource }}
{{- $refName := index $envSource "name" | default "anonymous" -}}
{{- $refKeys := list -}}
{{- if kindIs "slice" (index $envSource "keys") }}
{{- $refKeys = index $envSource "keys" -}}
{{- else if kindIs "string" (index $envSource "keys") }}
{{- $refKeys = list (index $envSource "keys") -}}
{{- end }}
{{- range $refKeys }}
{{- if and (kindIs "string" .) (has . $reservedEnvKeys) }}
{{- if not (hasKey $controlPlaneEnvVars .) }}
{{- $errors = append $errors (printf "envFrom %s %q sets reserved key %q, but controlPlane.env.vars+env.vars does not explicitly set it; add it to controlPlane.env.vars or env.vars, or disable validation.reservedEnvKeysEnforced=false." $refSourceType $refName .) -}}
{{- end }}
{{- if not (hasKey $controllersExplicitEnvVars .) }}
{{- $errors = append $errors (printf "envFrom %s %q sets reserved key %q, but controllers.env.vars does not explicitly set it; add it to controllers.env.vars, or disable validation.reservedEnvKeysEnforced=false." $refSourceType $refName .) -}}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end -}}

{{- if gt (len $errors) 0 }}
{{- fail (printf "Agents chart values validation failed:\n- %s" (join "\n- " $errors)) -}}
{{- end -}}
