{{- $errors := list -}}
{{- $clusterScoped := .Values.rbac.clusterScoped | default false -}}
{{- $controllerNamespaces := .Values.controller.namespaces | default (list) -}}
{{- $orchestrationNamespaces := .Values.orchestrationController.namespaces | default (list) -}}
{{- $supportingNamespaces := .Values.supportingController.namespaces | default (list) -}}

{{- if and (gt (len $controllerNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $controllerNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $orchestrationNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $orchestrationNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $supportingNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $supportingNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- $rolloutChecksums := .Values.rolloutChecksums | default dict -}}
{{- if $rolloutChecksums.enabled -}}
{{- $rolloutEntryErrors := list -}}
{{- if and (not .Values.database.createSecret.enabled) (and (eq (len $rolloutChecksums.secrets) 0) (eq (len $rolloutChecksums.configMaps) 0)) -}}
{{- $errors = append $errors "rolloutChecksums.enabled=true requires at least one checksum entry or database.createSecret.enabled=true." -}}
{{- end -}}

{{- range $idx, $entry := $rolloutChecksums.secrets -}}
{{- $secretName := trim (default "" $entry.name) -}}
{{- $secretChecksum := trim (default "" $entry.checksum) -}}
{{- if not $secretName -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].name must be a non-empty string." $idx) -}}
{{- end -}}
{{- if not (regexMatch "^[A-Fa-f0-9]{64}$" $secretChecksum) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].checksum must be a 64-char sha256 hex string." $idx) -}}
{{- end -}}
{{- end -}}

{{- range $idx, $entry := $rolloutChecksums.configMaps -}}
{{- $configMapName := trim (default "" $entry.name) -}}
{{- $configMapChecksum := trim (default "" $entry.checksum) -}}
{{- if not $configMapName -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].name must be a non-empty string." $idx) -}}
{{- end -}}
{{- if not (regexMatch "^[A-Fa-f0-9]{64}$" $configMapChecksum) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].checksum must be a 64-char sha256 hex string." $idx) -}}
{{- end -}}
{{- end -}}

{{- if gt (len $rolloutEntryErrors) 0 -}}
{{- $errors = append $errors (printf "%s" (join "\n" $rolloutEntryErrors)) -}}
{{- end -}}
{{- end -}}

{{- if gt (len $errors) 0 -}}
{{- fail (printf "Agents chart values validation failed:\n- %s" (join "\n- " $errors)) -}}
{{- end -}}
