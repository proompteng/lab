{{- $errors := list -}}
{{- $clusterScoped := .Values.rbac.clusterScoped | default false -}}
{{- $controllerNamespaces := .Values.controller.namespaces | default (list) -}}
{{- $orchestrationNamespaces := .Values.orchestrationController.namespaces | default (list) -}}
{{- $supportingNamespaces := .Values.supportingController.namespaces | default (list) -}}

{{- if and (gt (len $controllerNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $controllerNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when controller.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $orchestrationNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $orchestrationNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when orchestrationController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- if and (gt (len $supportingNamespaces) 1) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces has multiple entries." -}}
{{- end -}}
{{- if and (has "*" $supportingNamespaces) (not $clusterScoped) -}}
{{- $errors = append $errors "rbac.clusterScoped must be true when supportingController.namespaces includes '*' (wildcard)." -}}
{{- end -}}

{{- $rolloutChecksums := .Values.rolloutChecksums | default dict -}}
{{- if $rolloutChecksums.enabled -}}
{{- $rolloutEntryErrors := list -}}
{{- $dbNamespace := .Values.namespaceOverride | default .Release.Namespace -}}
{{- $checksumNamespacePattern := "^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$" -}}
{{- $checksumResourceNamePattern := "^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?(\\.[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$" -}}
{{- $seenSecretRefs := dict -}}
{{- $seenConfigMapRefs := dict -}}
{{- if and (not .Values.database.createSecret.enabled) (and (eq (len $rolloutChecksums.secrets) 0) (eq (len $rolloutChecksums.configMaps) 0)) -}}
{{- $errors = append $errors "rolloutChecksums.enabled=true requires at least one checksum entry or database.createSecret.enabled=true." -}}
{{- end -}}

{{- range $idx, $entry := $rolloutChecksums.secrets -}}
{{- $secretName := trim (default "" $entry.name) -}}
{{- $secretChecksum := trim (default "" $entry.checksum) -}}
{{- $secretNamespace := trim (default $dbNamespace $entry.namespace) -}}
{{- if not $secretName -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].name must be a non-empty string." $idx) -}}
{{- end -}}
{{- if and $secretName (not (regexMatch $checksumResourceNamePattern $secretName)) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].name must match RFC-1123 subdomain syntax." $idx) -}}
{{- end -}}
{{- if and (not $secretNamespace) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].namespace must be a non-empty string." $idx) -}}
{{- end -}}
{{- if and $secretNamespace (not (regexMatch $checksumNamespacePattern $secretNamespace)) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].namespace must match RFC-1123 DNS label syntax." $idx) -}}
{{- end -}}
{{- if not (regexMatch "^[A-Fa-f0-9]{64}$" $secretChecksum) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d].checksum must be a 64-char sha256 hex string." $idx) -}}
{{- end -}}
{{- if and $secretName $secretNamespace -}}
{{- $secretRef := printf "%s/%s" $secretNamespace $secretName -}}
{{- if hasKey $seenSecretRefs $secretRef -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.secrets[%d] duplicates key %s. namespace+name must be unique." $idx $secretRef) -}}
{{- else -}}
{{- $_ := set $seenSecretRefs $secretRef true -}}
{{- end -}}
{{- end -}}
{{- end -}}

{{- range $idx, $entry := $rolloutChecksums.configMaps -}}
{{- $configMapName := trim (default "" $entry.name) -}}
{{- $configMapChecksum := trim (default "" $entry.checksum) -}}
{{- $configMapNamespace := trim (default $dbNamespace $entry.namespace) -}}
{{- if not $configMapName -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].name must be a non-empty string." $idx) -}}
{{- end -}}
{{- if and $configMapName (not (regexMatch $checksumResourceNamePattern $configMapName)) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].name must match RFC-1123 subdomain syntax." $idx) -}}
{{- end -}}
{{- if and (not $configMapNamespace) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].namespace must be a non-empty string." $idx) -}}
{{- end -}}
{{- if and $configMapNamespace (not (regexMatch $checksumNamespacePattern $configMapNamespace)) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].namespace must match RFC-1123 DNS label syntax." $idx) -}}
{{- end -}}
{{- if not (regexMatch "^[A-Fa-f0-9]{64}$" $configMapChecksum) -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d].checksum must be a 64-char sha256 hex string." $idx) -}}
{{- end -}}
{{- if and $configMapName $configMapNamespace -}}
{{- $configMapRef := printf "%s/%s" $configMapNamespace $configMapName -}}
{{- if hasKey $seenConfigMapRefs $configMapRef -}}
{{- $rolloutEntryErrors = append $rolloutEntryErrors (printf "rolloutChecksums.configMaps[%d] duplicates key %s. namespace+name must be unique." $idx $configMapRef) -}}
{{- else -}}
{{- $_ := set $seenConfigMapRefs $configMapRef true -}}
{{- end -}}
{{- end -}}
{{- end -}}

{{- if gt (len $rolloutEntryErrors) 0 -}}
{{- $errors = append $errors (printf "%s" (join "\n" $rolloutEntryErrors)) -}}
{{- end -}}
{{- end -}}

{{- if gt (len $errors) 0 -}}
{{- fail (printf "Agents chart values validation failed:\n- %s" (join "\n- " $errors)) -}}
{{- end -}}
