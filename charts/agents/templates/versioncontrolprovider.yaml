{{- $vcp := .Values.versionControlProvider -}}
{{- if $vcp.enabled -}}
{{- $method := $vcp.auth.method | default "token" -}}
{{- $appSecretName := $vcp.auth.app.privateKeySecretRef.name -}}
{{- if and $vcp.privateKeySecret.create (not $appSecretName) -}}
{{- $appSecretName = include "agents.vcsAppSecretName" . -}}
{{- end -}}
{{- $namespace := $vcp.namespace | default (.Values.namespaceOverride | default .Release.Namespace) -}}
apiVersion: agents.proompteng.ai/v1alpha1
kind: VersionControlProvider
metadata:
  name: {{ $vcp.name | default "github" }}
  namespace: {{ $namespace }}
  labels:
    {{- include "agents.labels" . | nindent 4 }}
    {{- with $vcp.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $vcp.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  provider: {{ required "versionControlProvider.provider is required when versionControlProvider.enabled is true" $vcp.provider }}
  {{- with $vcp.apiBaseUrl }}
  apiBaseUrl: {{ . | quote }}
  {{- end }}
  {{- with $vcp.cloneBaseUrl }}
  cloneBaseUrl: {{ . | quote }}
  {{- end }}
  {{- with $vcp.webBaseUrl }}
  webBaseUrl: {{ . | quote }}
  {{- end }}
  {{- with $vcp.cloneProtocol }}
  cloneProtocol: {{ . | quote }}
  {{- end }}
  {{- with $vcp.sshHost }}
  sshHost: {{ . | quote }}
  {{- end }}
  {{- with $vcp.sshUser }}
  sshUser: {{ . | quote }}
  {{- end }}
  {{- with $vcp.auth }}
  auth:
    method: {{ $method | quote }}
    {{- if .username }}
    username: {{ .username | quote }}
    {{- end }}
    {{- if .token.secretRef.name }}
    token:
      secretRef:
        name: {{ .token.secretRef.name | quote }}
        key: {{ .token.secretRef.key | default "token" | quote }}
      {{- if .token.type }}
      type: {{ .token.type | quote }}
      {{- end }}
    {{- end }}
    {{- if or (eq $method "app") .app.appId .app.installationId $appSecretName }}
    app:
      {{- if .app.appId }}
      appId: {{ .app.appId | quote }}
      {{- end }}
      {{- if .app.installationId }}
      installationId: {{ .app.installationId | quote }}
      {{- end }}
      {{- if $appSecretName }}
      privateKeySecretRef:
        name: {{ $appSecretName | quote }}
        key: {{ .app.privateKeySecretRef.key | default $vcp.privateKeySecret.key | default "privateKey" | quote }}
      {{- end }}
      {{- if and .app.tokenTtlSeconds (gt (int .app.tokenTtlSeconds) 0) }}
      tokenTtlSeconds: {{ .app.tokenTtlSeconds }}
      {{- end }}
    {{- end }}
    {{- if or .ssh.privateKeySecretRef.name .ssh.knownHostsConfigMapRef.name }}
    ssh:
      {{- if .ssh.privateKeySecretRef.name }}
      privateKeySecretRef:
        name: {{ .ssh.privateKeySecretRef.name | quote }}
        key: {{ .ssh.privateKeySecretRef.key | default "privateKey" | quote }}
      {{- end }}
      {{- if .ssh.knownHostsConfigMapRef.name }}
      knownHostsConfigMapRef:
        name: {{ .ssh.knownHostsConfigMapRef.name | quote }}
        key: {{ .ssh.knownHostsConfigMapRef.key | default "known_hosts" | quote }}
      {{- end }}
    {{- end }}
  {{- end }}
  {{- with $vcp.repositoryPolicy }}
  repositoryPolicy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with $vcp.capabilities }}
  capabilities:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with $vcp.defaults }}
  defaults:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- end }}
