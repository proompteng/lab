name: jangar-deploy

on:
  push:
    branches: [main]
    paths:
      - 'services/jangar/**'
      - '.github/workflows/jangar-deploy.yml'

permissions:
  contents: read

jobs:
  deploy-convex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.3

      - name: Install deps (workspace)
        run: bun install --frozen-lockfile

      - name: Install deps (jangar)
        run: cd services/jangar && bun install --frozen-lockfile

      - name: Deploy Convex for jangar
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT_JANGAR }}
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY_JANGAR }}
          CONVEX_SELF_HOSTED_URL: ${{ secrets.CONVEX_SELF_HOSTED_URL_JANGAR }}
          CONVEX_SITE_ORIGIN: ${{ secrets.CONVEX_SITE_ORIGIN_JANGAR }}
          CONVEX_CLOUD_ORIGIN: ${{ secrets.CONVEX_CLOUD_ORIGIN_JANGAR }}
        run: cd services/jangar && bunx convex deploy --yes
