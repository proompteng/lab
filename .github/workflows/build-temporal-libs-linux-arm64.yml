name: Build Temporal Libraries (linux-arm64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: arc-arm64
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev protobuf-compiler
      
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
      
      - name: Clone and build temporal-sdk-core
        run: |
          source $HOME/.cargo/env
          cd packages/temporal-bun-sdk
          mkdir -p vendor
          git clone --depth 1 https://github.com/temporalio/sdk-core.git vendor/temporal-sdk-core
          cd vendor/temporal-sdk-core
          cargo build --release
      
      - name: Package libraries
        run: |
          cd packages/temporal-bun-sdk
          VERSION="v1.0.0"
          RELEASE_DIR="releases/$VERSION/linux-arm64"
          mkdir -p "$RELEASE_DIR"
          
          find vendor/temporal-sdk-core/target/release -name "*.a" -exec cp {} "$RELEASE_DIR/" \;
          
          TARBALL="releases/temporal-static-libs-linux-arm64-$VERSION.tar.gz"
          tar -czf "$TARBALL" -C "$RELEASE_DIR" .
          
          sha256sum "$TARBALL" | awk '{print $1 "  temporal-static-libs-linux-arm64-v1.0.0.tar.gz"}' > "$TARBALL.sha256"
      
      - name: Upload to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd packages/temporal-bun-sdk
          gh release upload temporal-libs-v1.0.0 \
            releases/temporal-static-libs-linux-arm64-v1.0.0.tar.gz \
            releases/temporal-static-libs-linux-arm64-v1.0.0.tar.gz.sha256 \
            --clobber
