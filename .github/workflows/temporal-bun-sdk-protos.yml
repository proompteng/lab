name: Temporal Bun SDK Proto Regen

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1'

jobs:
  regenerate:
    runs-on: arc-arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: '24.11.1'

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Cache Bun install
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-1.3.9-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-1.3.9-

      - name: Install Buf CLI
        uses: bufbuild/buf-setup-action@v1

      - name: Install dependencies
        run: bun install --frozen-lockfile --ignore-scripts

      - name: Run Temporal proto regeneration
        run: bun packages/temporal-bun-sdk/scripts/update-temporal-protos.ts

      - name: Check for proto changes
        id: proto_changes
        run: |
          if git status --short packages/temporal-bun-sdk/src/proto | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open proto update pull request
        if: steps.proto_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/temporal-bun-sdk-proto-regen
          title: 'chore: refresh temporal-bun-sdk protos'
          commit-message: 'chore: refresh temporal-bun-sdk protos'
          body: |
            ## Summary
            Automated Temporal proto regeneration for `@proompteng/temporal-bun-sdk`.

            - Ran `bun packages/temporal-bun-sdk/scripts/update-temporal-protos.ts`
            - Rebuilt SDK and executed Oxfmt + test + load suites

            Merge after verifying CI to keep generated protos aligned with upstream Temporal APIs.

      - name: No changes detected
        if: steps.proto_changes.outputs.changed != 'true'
        run: echo 'Temporal proto sources already up to date'
