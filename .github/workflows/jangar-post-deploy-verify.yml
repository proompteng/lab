name: jangar-post-deploy-verify

on:
  push:
    branches:
      - main
    paths:
      - 'argocd/applications/jangar/**'
  workflow_dispatch:

concurrency:
  group: jangar-post-deploy-verify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: arc-arm64
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.31.2

      - name: Install Temporal CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sSfL https://temporal.download/cli.sh | bash -s -- -b "${HOME}/.temporalio/bin"
          echo "${HOME}/.temporalio/bin" >> "$GITHUB_PATH"

      - name: Verify Temporal CLI
        shell: bash
        run: temporal --version

      - name: Configure in-cluster kubeconfig when context is missing
        shell: bash
        run: |
          set -euo pipefail

          if kubectl config current-context >/dev/null 2>&1; then
            echo "Kubectl context already configured"
            exit 0
          fi

          if [ -z "${KUBERNETES_SERVICE_HOST:-}" ] || [ -z "${KUBERNETES_SERVICE_PORT:-}" ]; then
            echo "KUBERNETES_SERVICE_HOST/PORT are not set and no kubectl context exists"
            exit 1
          fi
          if [ ! -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
            echo "Service account token is missing"
            exit 1
          fi
          if [ ! -f /var/run/secrets/kubernetes.io/serviceaccount/ca.crt ]; then
            echo "Service account CA cert is missing"
            exit 1
          fi

          KUBECONFIG_PATH="${RUNNER_TEMP}/kubeconfig"
          echo "KUBECONFIG=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"

          kubectl config set-cluster in-cluster \
            --server="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}" \
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            --embed-certs=true \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config set-credentials gha-runner \
            --token="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config set-context in-cluster \
            --cluster=in-cluster \
            --user=gha-runner \
            --namespace=jangar \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config use-context in-cluster --kubeconfig="${KUBECONFIG_PATH}"

      - name: Validate kubectl context
        shell: bash
        run: |
          set -euo pipefail
          kubectl config current-context

      - name: Verify deployment health and digest
        shell: bash
        run: |
          set -euo pipefail
          bun run packages/scripts/src/jangar/verify-deployment.ts

      - name: Sync Temporal routing after rollout
        shell: bash
        env:
          TEMPORAL_ADDRESS: temporal-frontend.temporal.svc.cluster.local:7233
          TEMPORAL_NAMESPACE: default
        run: |
          set -euo pipefail
          bun run packages/scripts/src/jangar/sync-temporal-routing.ts \
            --task-queue jangar \
            --deployment-name jangar-deployment \
            --migrate-stale-running

      - name: Prepare rollback manifests
        if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: rollback
        shell: bash
        run: |
          set -euo pipefail

          HEAD_MESSAGE="$(git log -1 --pretty=%s)"
          if [[ "${HEAD_MESSAGE}" == rollback\(jangar\):* ]]; then
            echo "Skipping rollback PR because current commit is already a rollback"
            echo "should_rollback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            echo "No parent commit available for rollback"
            echo "should_rollback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git checkout --quiet HEAD^ -- \
            argocd/applications/jangar/kustomization.yaml \
            argocd/applications/jangar/deployment.yaml \
            argocd/applications/jangar/jangar-worker-deployment.yaml

          if git diff --quiet -- \
            argocd/applications/jangar/kustomization.yaml \
            argocd/applications/jangar/deployment.yaml \
            argocd/applications/jangar/jangar-worker-deployment.yaml; then
            echo "No rollback diff detected"
            echo "should_rollback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_rollback=true" >> "$GITHUB_OUTPUT"

      - name: Open rollback pull request
        if: failure() && steps.rollback.outputs.should_rollback == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.AGENTS_SPLIT_TOKEN || secrets.GITHUB_TOKEN }}
          branch: codex/jangar-rollback-${{ github.run_id }}-${{ github.run_attempt }}
          base: main
          title: "rollback(jangar): revert failed promotion ${{ github.sha }}"
          commit-message: "rollback(jangar): revert failed promotion ${{ github.sha }}"
          delete-branch: true
          add-paths: |
            argocd/applications/jangar/kustomization.yaml
            argocd/applications/jangar/deployment.yaml
            argocd/applications/jangar/jangar-worker-deployment.yaml
          body: |
            ## Summary
            Automatic rollback created because `jangar-post-deploy-verify` failed on `main`.

            - Failed commit: `${{ github.sha }}`
            - Workflow run: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            - Rollback source: `HEAD^` manifests from the failed run checkout
