name: jangar-post-deploy-verify

on:
  push:
    branches:
      - main
    paths:
      - 'argocd/applications/jangar/**'
  workflow_dispatch:

jobs:
  verify:
    runs-on: arc-arm64
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.31.2

      - name: Configure in-cluster kubeconfig when context is missing
        shell: bash
        run: |
          set -euo pipefail

          if kubectl config current-context >/dev/null 2>&1; then
            echo "Kubectl context already configured"
            exit 0
          fi

          if [ -z "${KUBERNETES_SERVICE_HOST:-}" ] || [ -z "${KUBERNETES_SERVICE_PORT:-}" ]; then
            echo "KUBERNETES_SERVICE_HOST/PORT are not set and no kubectl context exists"
            exit 1
          fi
          if [ ! -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
            echo "Service account token is missing"
            exit 1
          fi
          if [ ! -f /var/run/secrets/kubernetes.io/serviceaccount/ca.crt ]; then
            echo "Service account CA cert is missing"
            exit 1
          fi

          KUBECONFIG_PATH="${RUNNER_TEMP}/kubeconfig"
          echo "KUBECONFIG=${KUBECONFIG_PATH}" >> "${GITHUB_ENV}"

          kubectl config set-cluster in-cluster \
            --server="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}" \
            --certificate-authority=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            --embed-certs=true \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config set-credentials gha-runner \
            --token="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config set-context in-cluster \
            --cluster=in-cluster \
            --user=gha-runner \
            --namespace=jangar \
            --kubeconfig="${KUBECONFIG_PATH}"

          kubectl config use-context in-cluster --kubeconfig="${KUBECONFIG_PATH}"

      - name: Validate kubectl context
        shell: bash
        run: |
          set -euo pipefail
          kubectl config current-context

      - name: Wait for Argo application health
        shell: bash
        run: |
          set -euo pipefail
          for attempt in $(seq 1 60); do
            if ! STATUS="$(kubectl -n argocd get application jangar -o jsonpath='{.status.sync.status} {.status.health.status}' 2>&1)"; then
              echo "Unable to query Argo application status (${STATUS}); continuing with rollout/digest verification"
              exit 0
            fi
            SYNC_STATUS="$(echo "${STATUS}" | awk '{print $1}')"
            HEALTH_STATUS="$(echo "${STATUS}" | awk '{print $2}')"
            echo "Attempt ${attempt}: sync=${SYNC_STATUS:-unknown} health=${HEALTH_STATUS:-unknown}"

            # Health + rollout/digest checks are authoritative for deployed state.
            # Sync can remain OutOfSync due unrelated drift, so do not block on it.
            if [ "${HEALTH_STATUS}" = "Healthy" ]; then
              if [ "${SYNC_STATUS}" != "Synced" ]; then
                echo "Application is Healthy but sync=${SYNC_STATUS}; continuing with rollout/digest verification"
              fi
              exit 0
            fi

            sleep 10
          done

          echo "Jangar Argo application did not reach Healthy within timeout"
          exit 1

      - name: Wait for deployment rollouts
        shell: bash
        run: |
          set -euo pipefail
          kubectl rollout status deployment/jangar -n jangar --timeout=10m
          kubectl rollout status deployment/jangar-worker -n jangar --timeout=10m

      - name: Verify deployed image digest matches manifests
        shell: bash
        run: |
          set -euo pipefail
          EXPECTED_DIGEST="$(
            awk '
              index($0, "name: registry.ide-newton.ts.net/lab/jangar") { found=1; next }
              found && $1 == "digest:" { print $2; exit }
            ' argocd/applications/jangar/kustomization.yaml
          )"
          if [ -z "${EXPECTED_DIGEST}" ]; then
            echo "Unable to parse expected digest from argocd/applications/jangar/kustomization.yaml"
            exit 1
          fi

          API_IMAGES="$(kubectl -n jangar get deployment jangar -o jsonpath='{..image}')"
          WORKER_IMAGES="$(kubectl -n jangar get deployment jangar-worker -o jsonpath='{..image}')"

          echo "Expected digest: ${EXPECTED_DIGEST}"
          echo "API images: ${API_IMAGES}"
          echo "Worker images: ${WORKER_IMAGES}"

          if [[ "${API_IMAGES}" != *"${EXPECTED_DIGEST}"* ]]; then
            echo "API deployment image digest does not match expected digest"
            exit 1
          fi
          if [[ "${WORKER_IMAGES}" != *"${EXPECTED_DIGEST}"* ]]; then
            echo "Worker deployment image digest does not match expected digest"
            exit 1
          fi
