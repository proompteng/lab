name: agents-sync

on:
  push:
    branches:
      - main
    paths:
      - 'charts/agents/**'
      - '.github/workflows/agents-sync.yml'
  workflow_dispatch: {}

concurrency:
  group: agents-sync
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install git-filter-repo
        run: python3 -m pip install --no-cache-dir git-filter-repo

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Split charts/agents into charts repo and publish chart
        env:
          AGENTS_SPLIT_TOKEN: ${{ secrets.AGENTS_SPLIT_TOKEN }}
        run: |
          if [ -z "${AGENTS_SPLIT_TOKEN}" ]; then
            echo "AGENTS_SPLIT_TOKEN is not set" >&2
            exit 1
          fi

          tmpdir="$(mktemp -d)"
          git clone --no-local . "${tmpdir}/agents-split"
          cd "${tmpdir}/agents-split"

          git filter-repo --path charts/agents

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git remote add origin "https://x-access-token:${AGENTS_SPLIT_TOKEN}@github.com/proompteng/charts.git"
          git fetch origin main

          cp charts/agents/README.md README.md
          if ! git diff --quiet -- README.md; then
            git add README.md
            git commit -m "docs: mirror agents chart README at repository root"
          fi

          git push --force-with-lease=main -u origin HEAD:main

          chart_version="$(awk '/^version:/ {print $2; exit}' charts/agents/Chart.yaml)"
          package_dir="${tmpdir}/chart-packages"
          existing_dir="${tmpdir}/existing-packages"
          mkdir -p "${package_dir}" "${existing_dir}"

          helm package charts/agents --destination "${package_dir}"
          package_path="${package_dir}/agents-${chart_version}.tgz"
          if [ ! -f "${package_path}" ]; then
            echo "Expected packaged chart at ${package_path}" >&2
            exit 1
          fi

          echo "${AGENTS_SPLIT_TOKEN}" | helm registry login ghcr.io -u proompteng --password-stdin
          if helm pull oci://ghcr.io/proompteng/charts/agents --version "${chart_version}" --destination "${existing_dir}" >/dev/null 2>&1; then
            existing_path="${existing_dir}/agents-${chart_version}.tgz"
            compare_new_dir="${tmpdir}/compare-new"
            compare_existing_dir="${tmpdir}/compare-existing"
            mkdir -p "${compare_new_dir}" "${compare_existing_dir}"
            tar -xzf "${package_path}" -C "${compare_new_dir}"
            tar -xzf "${existing_path}" -C "${compare_existing_dir}"

            if diff -qr "${compare_new_dir}" "${compare_existing_dir}" >/dev/null; then
              echo "Chart ${chart_version} already published and matches packaged contents; skipping helm push."
            else
              echo "Chart ${chart_version} already exists in OCI but differs from current contents. Bump charts/agents/Chart.yaml version." >&2
              exit 1
            fi
          else
            helm push "${package_path}" oci://ghcr.io/proompteng/charts
          fi
