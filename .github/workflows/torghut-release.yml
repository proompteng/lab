name: torghut-release

on:
  workflow_run:
    workflows:
      - torghut-build-push
    types:
      - completed
  workflow_dispatch:
    inputs:
      commit_sha:
        description: Commit SHA to promote (defaults to current main HEAD)
        required: false
        type: string
      image_tag:
        description: Image tag to promote (defaults to source short SHA)
        required: false
        type: string
      image_digest:
        description: Image digest override (sha256:...)
        required: false
        type: string

concurrency:
  group: torghut-release-${{ github.event.workflow_run.head_sha || inputs.commit_sha || github.ref }}
  cancel-in-progress: true

jobs:
  promote:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
      }}
    runs-on: arc-arm64
    permissions:
      actions: read
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download release contract artifact from triggering build
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: torghut-release-contract
          path: .artifacts/torghut
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve release metadata
        id: meta
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_RUN_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          COMMIT_SHA_INPUT: ${{ inputs.commit_sha }}
          IMAGE_TAG_INPUT: ${{ inputs.image_tag }}
        run: |
          set -euo pipefail

          MAIN_HEAD="$(git rev-parse origin/main)"
          IMAGE='registry.ide-newton.ts.net/lab/torghut'
          SOURCE_SHA=''
          TAG=''
          CONTRACT_DIGEST=''
          PROMOTE='true'

          if [ "${EVENT_NAME}" = 'workflow_run' ]; then
            CONTRACT_PATH='.artifacts/torghut/torghut-release-contract.json'
            if [ ! -f "${CONTRACT_PATH}" ]; then
              echo "Release contract artifact is missing at ${CONTRACT_PATH}"
              exit 1
            fi

            SOURCE_SHA="$(bun run packages/scripts/src/torghut/release-contract.ts get --path "${CONTRACT_PATH}" --field sourceSha)"
            TAG="$(bun run packages/scripts/src/torghut/release-contract.ts get --path "${CONTRACT_PATH}" --field tag)"
            CONTRACT_DIGEST="$(bun run packages/scripts/src/torghut/release-contract.ts get --path "${CONTRACT_PATH}" --field digest)"
            CONTRACT_IMAGE="$(bun run packages/scripts/src/torghut/release-contract.ts get --path "${CONTRACT_PATH}" --field image)"

            if [ "${CONTRACT_IMAGE}" != "${IMAGE}" ]; then
              echo "Release contract image mismatch: expected ${IMAGE}, got ${CONTRACT_IMAGE}"
              exit 1
            fi

            if [ "${SOURCE_SHA}" != "${WORKFLOW_RUN_HEAD_SHA}" ]; then
              echo "Release contract source SHA ${SOURCE_SHA} does not match workflow_run head ${WORKFLOW_RUN_HEAD_SHA}"
              exit 1
            fi

            if [ "${SOURCE_SHA}" != "${MAIN_HEAD}" ]; then
              echo "Skipping stale workflow_run promotion for ${SOURCE_SHA}; latest main is ${MAIN_HEAD}"
              PROMOTE='false'
            fi
          else
            if [ -n "${COMMIT_SHA_INPUT}" ]; then
              SOURCE_SHA="$(git rev-parse "${COMMIT_SHA_INPUT}^{commit}")"
            else
              SOURCE_SHA="${MAIN_HEAD}"
            fi

            if [ -n "${IMAGE_TAG_INPUT}" ]; then
              TAG="${IMAGE_TAG_INPUT}"
            else
              TAG="$(git rev-parse --short=8 "${SOURCE_SHA}")"
            fi
          fi

          if [ "${PROMOTE}" = 'true' ] && ! git cat-file -e "${SOURCE_SHA}^{commit}" >/dev/null 2>&1; then
            echo "Source SHA ${SOURCE_SHA} is not present in local git history"
            exit 1
          fi

          {
            echo "main_head=${MAIN_HEAD}"
            echo "source_sha=${SOURCE_SHA}"
            echo "tag=${TAG}"
            echo "contract_digest=${CONTRACT_DIGEST}"
            echo "image=${IMAGE}"
            echo "promote=${PROMOTE}"
          } >> "$GITHUB_OUTPUT"

      - name: Checkout source revision
        if: steps.meta.outputs.promote == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git checkout --force "${{ steps.meta.outputs.source_sha }}"

      - name: Resolve image digest
        if: steps.meta.outputs.promote == 'true'
        id: digest
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.meta.outputs.image }}
          IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          CONTRACT_DIGEST: ${{ steps.meta.outputs.contract_digest }}
          DIGEST_INPUT: ${{ inputs.image_digest }}
        run: |
          set -euo pipefail

          if [ -n "${DIGEST_INPUT}" ]; then
            DIGEST="${DIGEST_INPUT}"
          elif [ -n "${CONTRACT_DIGEST}" ]; then
            DIGEST="${CONTRACT_DIGEST}"
          else
            DIGEST="$(
              bun --eval "
                import { inspectImageDigest } from './packages/scripts/src/shared/docker.ts'
                const image = process.env.IMAGE_NAME + ':' + process.env.IMAGE_TAG
                const repoDigest = inspectImageDigest(image)
                const digest = repoDigest.includes('@') ? repoDigest.split('@')[1] : repoDigest
                console.log(digest)
              "
            )"
          fi

          DIGEST="${DIGEST#*@}"
          if ! printf '%s' "${DIGEST}" | grep -Eiq '^sha256:[0-9a-f]{64}$'; then
            echo "Resolved digest '${DIGEST}' is invalid"
            exit 1
          fi

          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Evaluate migration safety gate
        if: steps.meta.outputs.promote == 'true'
        id: migration
        shell: bash
        run: |
          set -euo pipefail
          CHANGED_FILES="$(git diff-tree --no-commit-id --name-only -r "${{ steps.meta.outputs.source_sha }}")"
          if printf '%s\n' "${CHANGED_FILES}" | grep -Eq '^services/torghut/migrations/'; then
            echo "requires_approval=true" >> "$GITHUB_OUTPUT"
            echo "label=do-not-automerge" >> "$GITHUB_OUTPUT"
            echo "draft=true" >> "$GITHUB_OUTPUT"
          else
            echo "requires_approval=false" >> "$GITHUB_OUTPUT"
            echo "label=" >> "$GITHUB_OUTPUT"
            echo "draft=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Torghut manifests
        if: steps.meta.outputs.promote == 'true'
        shell: bash
        env:
          TORGHUT_IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          TORGHUT_IMAGE_DIGEST: ${{ steps.digest.outputs.digest }}
          TORGHUT_COMMIT: ${{ steps.meta.outputs.source_sha }}
        run: |
          set -euo pipefail
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          bun run packages/scripts/src/torghut/update-manifests.ts \
            --tag "${TORGHUT_IMAGE_TAG}" \
            --digest "${TORGHUT_IMAGE_DIGEST}" \
            --commit "${TORGHUT_COMMIT}" \
            --rollout-timestamp "${TIMESTAMP}"

      - name: Check for manifest changes
        if: steps.meta.outputs.promote == 'true'
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet -- argocd/applications/torghut/knative-service.yaml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create deploy pull request (manual approval required)
        if: >-
          ${{
            steps.meta.outputs.promote == 'true' &&
            steps.changes.outputs.changed == 'true' &&
            steps.migration.outputs.requires_approval == 'true'
          }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.AGENTS_SPLIT_TOKEN || secrets.GITHUB_TOKEN }}
          branch: codex/torghut-release-${{ steps.meta.outputs.tag }}
          base: main
          title: 'chore(torghut): promote image ${{ steps.meta.outputs.tag }}'
          commit-message: 'chore(torghut): promote image ${{ steps.meta.outputs.tag }}'
          delete-branch: true
          labels: do-not-automerge
          draft: true
          add-paths: |
            argocd/applications/torghut/knative-service.yaml
          body: |
            ## Summary
            Promote Torghut image into GitOps manifests.

            - Source commit: `${{ steps.meta.outputs.source_sha }}`
            - Image tag: `${{ steps.meta.outputs.tag }}`
            - Image digest: `${{ steps.digest.outputs.digest }}`
            - Migration change detected under `services/torghut/migrations/**`
            - Added `do-not-automerge`; manual DB migration approval required before merge

      - name: Create deploy pull request (auto-merge eligible)
        if: >-
          ${{
            steps.meta.outputs.promote == 'true' &&
            steps.changes.outputs.changed == 'true' &&
            steps.migration.outputs.requires_approval != 'true'
          }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.AGENTS_SPLIT_TOKEN || secrets.GITHUB_TOKEN }}
          branch: codex/torghut-release-${{ steps.meta.outputs.tag }}
          base: main
          title: 'chore(torghut): promote image ${{ steps.meta.outputs.tag }}'
          commit-message: 'chore(torghut): promote image ${{ steps.meta.outputs.tag }}'
          delete-branch: true
          add-paths: |
            argocd/applications/torghut/knative-service.yaml
          body: |
            ## Summary
            Promote Torghut image into GitOps manifests.

            - Source commit: `${{ steps.meta.outputs.source_sha }}`
            - Image tag: `${{ steps.meta.outputs.tag }}`
            - Image digest: `${{ steps.digest.outputs.digest }}`

      - name: No manifest changes detected
        if: steps.meta.outputs.promote == 'true' && steps.changes.outputs.changed != 'true'
        run: echo 'No Torghut manifest changes detected.'

      - name: Promotion skipped (stale workflow_run)
        if: steps.meta.outputs.promote != 'true'
        run: echo 'Skipping stale workflow_run promotion because source SHA is not current main.'
