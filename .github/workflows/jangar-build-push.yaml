name: jangar-build-push

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'services/jangar/**'
      - 'packages/scripts/src/jangar/**'
      - 'packages/scripts/src/shared/**'
      - 'packages/codex/**'
      - 'packages/otel/**'
      - 'packages/temporal-bun-sdk/**'
      - 'skills/**'
      - 'package.json'
      - 'bun.lock'
      - '.github/workflows/jangar-build-push.yaml'
  workflow_dispatch:

concurrency:
  group: jangar-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: arc-arm64
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          cache-binary: false

      - name: Resolve image tag
        id: meta
        run: echo "tag=$(git rev-parse --short=8 HEAD)" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: bun install --frozen-lockfile --ignore-scripts --filter @proompteng/scripts --filter @proompteng/jangar

      - name: Prepare pruned build context
        id: prune
        shell: bash
        run: |
          set -euo pipefail
          PRUNE_DIR="$(mktemp -d)"
          bunx turbo prune --scope=@proompteng/jangar --docker --out-dir="$PRUNE_DIR"
          cp tsconfig.base.json "$PRUNE_DIR/tsconfig.base.json"
          if [ -d skills ]; then
            cp -R skills "$PRUNE_DIR/skills"
          fi
          if [ -d services/jangar/agentctl ]; then
            mkdir -p "$PRUNE_DIR/full/services/jangar" "$PRUNE_DIR/json/services/jangar"
            cp -R services/jangar/agentctl "$PRUNE_DIR/full/services/jangar/agentctl"
            cp -R services/jangar/agentctl "$PRUNE_DIR/json/services/jangar/agentctl"
          fi
          echo "context=$PRUNE_DIR" >> "$GITHUB_OUTPUT"

      - name: Build and push jangar image
        env:
          JANGAR_BUILD_CONTEXT: ${{ steps.prune.outputs.context }}
          JANGAR_IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          JANGAR_IMAGE_PLATFORMS: linux/arm64
          JANGAR_BUILD_CACHE_MODE: min
          JANGAR_BUILD_NODE_OPTIONS: --max-old-space-size=4096
          JANGAR_BUILD_SOURCEMAP: '0'
          JANGAR_BUILD_CI: 'true'
          JANGAR_BUILD_LOG_LEVEL: warn
        run: bun run packages/scripts/src/jangar/build-image.ts

      - name: Build and push jangar control-plane image
        env:
          JANGAR_BUILD_CONTEXT: ${{ steps.prune.outputs.context }}
          JANGAR_IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          JANGAR_IMAGE_PLATFORMS: linux/arm64
          JANGAR_BUILD_CACHE_MODE: min
          JANGAR_BUILD_NODE_OPTIONS: --max-old-space-size=4096
          JANGAR_BUILD_SOURCEMAP: '0'
          JANGAR_BUILD_CI: 'true'
          JANGAR_BUILD_LOG_LEVEL: warn
        run: bun run packages/scripts/src/jangar/build-control-plane-image.ts

      - name: Resolve pushed image digest
        id: digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar"
          TAG="${{ steps.meta.outputs.tag }}"
          DIGEST="$(docker buildx imagetools inspect "${IMAGE}:${TAG}" | awk '/^Digest:/ { print $2; exit }')"
          if [ -z "${DIGEST}" ]; then
            echo "Failed to resolve digest for ${IMAGE}:${TAG}"
            exit 1
          fi
          echo "${DIGEST}" > jangar-image-digest.txt
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Resolve pushed control-plane image digest
        id: control_plane_digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar-control-plane"
          TAG="${{ steps.meta.outputs.tag }}"
          DIGEST="$(docker buildx imagetools inspect "${IMAGE}:${TAG}" | awk '/^Digest:/ { print $2; exit }')"
          if [ -z "${DIGEST}" ]; then
            echo "Failed to resolve digest for ${IMAGE}:${TAG}"
            exit 1
          fi
          echo "${DIGEST}" > jangar-control-plane-image-digest.txt
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Write release contract artifact
        shell: bash
        run: |
          set -euo pipefail
          bun run packages/scripts/src/jangar/release-contract.ts write \
            --path jangar-release-contract.json \
            --source-sha "${GITHUB_SHA}" \
            --tag "${{ steps.meta.outputs.tag }}" \
            --digest "${{ steps.digest.outputs.digest }}" \
            --image "registry.ide-newton.ts.net/lab/jangar"

      - name: Upload release contract artifact
        uses: actions/upload-artifact@v4
        with:
          name: jangar-release-contract
          path: jangar-release-contract.json
          if-no-files-found: error
          retention-days: 3

      - name: Update latest tag
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar"
          CONTROL_PLANE_IMAGE="registry.ide-newton.ts.net/lab/jangar-control-plane"
          TAG="${{ steps.meta.outputs.tag }}"
          docker buildx imagetools create -t "${IMAGE}:latest" "${IMAGE}:${TAG}"
          docker buildx imagetools create -t "${CONTROL_PLANE_IMAGE}:latest" "${CONTROL_PLANE_IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:latest"
          docker buildx imagetools inspect "${CONTROL_PLANE_IMAGE}:${TAG}"
          docker buildx imagetools inspect "${CONTROL_PLANE_IMAGE}:latest"
