name: jangar-build-push

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'services/jangar/**'
      - 'packages/scripts/src/jangar/**'
      - 'packages/scripts/src/shared/**'
      - 'packages/codex/**'
      - 'packages/otel/**'
      - 'packages/temporal-bun-sdk/**'
      - 'skills/**'
      - 'package.json'
      - 'bun.lock'
      - '.github/workflows/jangar-build-push.yaml'
  workflow_dispatch:

concurrency:
  group: jangar-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: arc-arm64
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve image tag
        id: meta
        run: echo "tag=$(git rev-parse --short=8 HEAD)" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: bun install --frozen-lockfile --ignore-scripts

      - name: Build and push jangar image
        env:
          JANGAR_IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          JANGAR_IMAGE_PLATFORMS: linux/arm64
          JANGAR_BUILD_NODE_OPTIONS: --max-old-space-size=4096
        run: bun run packages/scripts/src/jangar/build-image.ts

      - name: Resolve pushed image digest
        id: digest
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar"
          TAG="${{ steps.meta.outputs.tag }}"
          DIGEST="$(docker buildx imagetools inspect "${IMAGE}:${TAG}" | awk '/^Digest:/ { print $2; exit }')"
          if [ -z "${DIGEST}" ]; then
            echo "Failed to resolve digest for ${IMAGE}:${TAG}"
            exit 1
          fi
          echo "${DIGEST}" > jangar-image-digest.txt
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Write release contract artifact
        shell: bash
        run: |
          set -euo pipefail
          bun run packages/scripts/src/jangar/release-contract.ts write \
            --path jangar-release-contract.json \
            --source-sha "${GITHUB_SHA}" \
            --tag "${{ steps.meta.outputs.tag }}" \
            --digest "${{ steps.digest.outputs.digest }}" \
            --image "registry.ide-newton.ts.net/lab/jangar"

      - name: Upload release contract artifact
        uses: actions/upload-artifact@v4
        with:
          name: jangar-release-contract
          path: jangar-release-contract.json
          if-no-files-found: error
          retention-days: 3

      - name: Update latest tag
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar"
          TAG="${{ steps.meta.outputs.tag }}"
          docker buildx imagetools create -t "${IMAGE}:latest" "${IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:latest"
