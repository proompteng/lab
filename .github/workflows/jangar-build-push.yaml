name: jangar-build-push

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'services/jangar/**'
      - 'packages/scripts/src/jangar/**'
      - 'packages/scripts/src/shared/**'
      - 'packages/codex/**'
      - 'packages/otel/**'
      - 'packages/temporal-bun-sdk/**'
      - 'skills/**'
      - 'package.json'
      - 'bun.lock'
      - '.github/workflows/jangar-build-push.yaml'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: arc-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve image tag
        id: meta
        run: echo "tag=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        run: bun install --frozen-lockfile --ignore-scripts

      - name: Prebuild jangar output
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          bun run --filter @proompteng/otel build
          bun run --filter @proompteng/temporal-bun-sdk build
          bun run --cwd services/jangar start:build

      - name: Build and push jangar image
        env:
          JANGAR_IMAGE_TAG: ${{ steps.meta.outputs.tag }}
          JANGAR_IMAGE_PLATFORMS: linux/arm64
          JANGAR_BUILD_NODE_OPTIONS: --max-old-space-size=4096
          JANGAR_USE_PREBUILT_OUTPUT: 'true'
        run: bun run packages/scripts/src/jangar/build-image.ts

      - name: Update latest tag
        run: |
          set -euo pipefail
          IMAGE="registry.ide-newton.ts.net/lab/jangar"
          TAG="${{ steps.meta.outputs.tag }}"
          docker buildx imagetools create -t "${IMAGE}:latest" "${IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:${TAG}"
          docker buildx imagetools inspect "${IMAGE}:latest"
