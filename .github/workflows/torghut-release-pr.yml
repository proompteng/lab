name: torghut-release-pr

on:
  workflow_run:
    workflows:
      - torghut-ci
    types:
      - completed
  workflow_dispatch:
    inputs:
      ref:
        description: Ref (branch, tag, or SHA) to release from
        required: false
        default: main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: torghut-release-pr-${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.run_id }}
  cancel-in-progress: true

jobs:
  release-pr:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: arc-arm64
    steps:
      - name: Checkout workflow run SHA
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Checkout manual ref
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build images and update torghut manifests (GitOps mode)
        env:
          TORGHUT_SKIP_MIGRATIONS: 'true'
          TORGHUT_SKIP_APPLY: 'true'
        run: bun run deploy:torghut

      - name: Detect torghut manifest changes
        id: changes
        run: |
          set -euo pipefail
          if git diff --quiet -- argocd/applications/torghut; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit and push release branch
        if: steps.changes.outputs.changed == 'true'
        id: push
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          head_sha="$(git rev-parse HEAD)"
          release_hash="$(printf "%s" "$head_sha" | sha256sum | awk '{print $1}')"
          release_branch="release/${release_hash}"
          short_sha="$(printf "%s" "$head_sha" | cut -c1-7)"

          git checkout -B "$release_branch"
          git add argocd/applications/torghut
          git commit -m "chore(torghut): automatic update deployment manifests"

          git push --force-with-lease origin "$release_branch"

          echo "release_branch=$release_branch" >> "$GITHUB_OUTPUT"
          echo "short_sha=$short_sha" >> "$GITHUB_OUTPUT"

      - name: Open rollout PR
        if: steps.changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          release_branch="${{ steps.push.outputs.release_branch }}"
          short_sha="${{ steps.push.outputs.short_sha }}"

          existing_any="$(gh pr list \
            --repo "$GH_REPO" \
            --head "$release_branch" \
            --base main \
            --state all \
            --json number,state \
            --jq '.[0] | if . == null then "" else "#\(.number) (\(.state))" end')"

          if [ -n "$existing_any" ]; then
            echo "Rollout PR already exists: $existing_any"
            exit 0
          fi

          pr_body=$'Automated Torghut rollout PR.\n\n- Built and pushed torghut/torghut-ws/torghut-ta images\n- Updated manifests under `argocd/applications/torghut`\n- Ready for merge; Argo CD auto-sync will reconcile after merge.'

          gh pr create \
            --repo "$GH_REPO" \
            --base main \
            --head "$release_branch" \
            --title "chore(release/${short_sha}): automated torghut rollout PR" \
            --body "$pr_body"

      - name: No manifest changes
        if: steps.changes.outputs.changed != 'true'
        run: echo "No torghut manifest updates were produced."
